(()=>{var ce=new BroadcastChannel("tagChannel"),Ve=new BroadcastChannel("savedQueryChannel");function je(e,t){ce.postMessage({hash:e,tagAdd:t})}function $e(e,t){ce.postMessage({hash:e,tagRemove:t})}function Qe(e){ce.addEventListener("message",e)}function Ke(e){Ve.postMessage({queries:e})}function We(e){Ve.addEventListener("message",e)}var f="data-name",b="data-bad-media",N="data-dupe",_="data-duration",G="data-quality",q="data-tag-count",D="data-file-size",ze="vqStorage";function y(e){for(;e.hasChildNodes();)e.removeChild(e.lastChild)}function ln(e){return[...new Uint8Array(e)].map(t=>t.toString(16).padStart(2,"0")).join("")}function cn(e,t,n){e instanceof File?t(e):e.file(t,n)}function ue(e,t){cn(e,async n=>{let o=null;if(n.size<3*1024)o=await n.arrayBuffer();else{o=new ArrayBuffer(3*1024+8);let s=new BigUint64Array(o);s[0]=BigInt(n.size);let a=Math.floor((n.size-1024)/2),c=n.slice(0,1024).arrayBuffer(),l=n.slice(a,a+1024).arrayBuffer(),g=n.slice(n.size-1024,n.size).arrayBuffer(),u=new Uint8Array(o);u.set(new Uint8Array(await c),8),u.set(new Uint8Array(await l),8+1024),u.set(new Uint8Array(await g),8+2*1024)}let i=await crypto.subtle.digest("SHA-256",o);t(ln(i))})}function Ze(e){let t=3735928559,n=1103547991;for(let r=0,o;r<e.length;r++)o=e.charCodeAt(r),t=Math.imul(t^o,2654435761),n=Math.imul(n^o,1597334677);return t=Math.imul(t^t>>>16,2246822507)^Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507)^Math.imul(t^t>>>13,3266489909),(n>>>0).toString(16).padStart(8,"0")+(t>>>0).toString(16).padStart(8,"0")}function x(){return!!window?.chrome?.app?.window}function Ye(e){if(e<1024)return`${e.toFixed()} B`;let t=["kB","MB","GB","TB","PB"],n=-1;do e/=1024,++n;while(Math.round(Math.abs(e)*100)/100>=1024&&n<t.length-1);return`${e.toFixed(2)} ${t[n]}`}var me="storedGalleries",v={},$={};function Xe(e){chrome.storage.local.get(me,t=>{v=t[me]||{},chrome.mediaGalleries.getMediaFileSystems({interactive:"no"},n=>{let r=[];for(let o of n){let s=chrome.mediaGalleries.getMediaFileSystemMetadata(o).galleryId,a=v[s];(!a||a.enabled)&&r.push({galleryId:s,dir:o.root}),$[s]=o}e(r)})})}function dn(e,t){let n=[],r=()=>{let o=e.shift();if(!o){t(n);return}o.dir.createReader().readEntries(s=>{for(let a of s)a.isFile?n.push({galleryId:o.galleryId,file:a}):a.isDirectory&&e.push({galleryId:o.galleryId,dir:a});r()})};r()}function fe(){return document.getElementById("folder-grid")}function Je(e,t,n){let r=fe(),o=document.createElement("div");o.className="folder-row";let i=document.createElement("input");i.className="folder-enable",i.type="checkbox",i.checked=t,i.addEventListener("change",()=>{v[e].enabled=i.checked}),o.appendChild(i);let s=document.createElement("div");s.className="folder-name",s.textContent=n,o.appendChild(s);let a=document.createElement("button");a.className="folder-delete",a.addEventListener("click",()=>{v[e].show=!1,r.removeChild(o)}),o.appendChild(a),r.appendChild(o)}function et(){let t=fe().getElementsByClassName("folder-enable"),n=!1;for(let r of t)if(r instanceof HTMLInputElement&&r.checked){n=!0;break}for(let r of t)r instanceof HTMLInputElement&&(r.checked=!n,r.dispatchEvent(new Event("change")))}function tt(){y(fe());for(let[t,n]of Object.entries($)){let r=v[t]||{show:!0,enabled:!0};v[t]=r;let o=chrome.mediaGalleries.getMediaFileSystemMetadata(n);r.show&&Je(t,r.enabled,o.name)}document.getElementById("settings-dialog").showModal()}function nt(e){e.preventDefault(),chrome.mediaGalleries.addUserSelectedFolder((t,n)=>{if(n){for(let r of t)if(r.name==n){let o=chrome.mediaGalleries.getMediaFileSystemMetadata(r),i=v[o.galleryId]||{};i.enabled=!0,i.show=!0,Je(o.galleryId,i.enabled,o.name);break}}})}function rt(e){x()&&chrome.storage.local.set({[me]:v},e)}function ot(e,t,n){dn(e,r=>{for(let o of r)t(o);n()})}var mn=624,fn=1e4;function ge(e,t,n){let r={};function o(){l.style.width=`${mn}px`,r.width=l.videoWidth,r.height=l.videoHeight,r.duration=l.duration}function i(u){if(g!==0&&(clearTimeout(g),g=0),l.removeEventListener("error",c,!1),l.removeEventListener("canplay",a,!1),l.removeEventListener("loadedmetadata",o,!1),l.src="",u&&(r.image=u,u.size<1200&&t.retries>0)){--t.retries,typeof t.specificTime=="number"&&(t.specificTime+=1/30),ge(e,t,n);return}n(r)}function s(){l.removeEventListener("seeked",s,!1),gn(l,i)}function a(){l.removeEventListener("canplay",a,!1),l.pause(),t.specificTime||(t.specificTime=l.duration/2),l.addEventListener("seeked",s),l.currentTime=t.specificTime}function c(){i(null)}let l=document.getElementById("generator");l.addEventListener("canplay",a,!1),l.addEventListener("loadedmetadata",o,!1),l.addEventListener("error",c,!1),l.src=e;let g=setTimeout(c,fn);l.pause()}function gn(e,t){let n=document.getElementById("canvas"),r=e.offsetWidth,o=e.offsetHeight;n.width=r,n.height=o;let i=e.offsetWidth,s=e.offsetHeight,a=n.getContext("2d",{willReadFrequently:!0});if(!a){t(null);return}a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high",a.drawImage(e,0,0,i,s),n.toBlob(t,"image/webp",.5)}var Q=null;function it(e){console.log("storage init");let t=indexedDB.open(ze,3);t.onupgradeneeded=n=>{console.log(`onupgradeneeded old=${n.oldVersion} new=${n.newVersion}`);let r=t.result;switch(n.oldVersion){case 0:console.log("Creating new DB"),r.createObjectStore("tags",{});case 1:console.log("Upgrading to version 2"),r.createObjectStore("previews",{});case 2:console.log("Upgrading to version 3"),r.createObjectStore("misc",{})}},t.onerror=n=>{Q=null,e(!1)},t.onsuccess=n=>{Q=t.result,e(!0)}}function m(){if(!Q)throw"DB not initialized";return Q}var W=0,H=0;function st(e,t){let n=document.getElementById("progress-container"),r=document.getElementById("progress");H==0&&(n.style.opacity="1"),W+=t,H+=e,r.value=W,r.max=H,W>=H&&(n.style.opacity="0",H=0,W=0)}function at(e,t){let r=m().transaction("previews").objectStore("previews").get(e);r.onsuccess=o=>{t(r.result)}}var M=[],pe=!1;function lt(e,t){ye(e,void 0,t)}function ye(e,t,n){st(1,0),M.push({file:e,specificTime:t,callback:n,processing:!1}),M.length==1&&he()}function Ee(e,t){m().transaction("previews","readwrite").objectStore("previews").put(t,e)}function ct(){pe=!0}function dt(){pe=!1;let e=M[0];e&&!e.processing&&he()}function he(){if(pe)return;let e=M[0];e&&(e.processing=!0,yn(e.file,e.specificTime,t=>{M.shift(),e.callback(t),he()}))}function yn(e,t,n){let r=URL.createObjectURL(e);ge(r,{specificTime:t,retries:t===void 0?1:3},s=>{URL.revokeObjectURL(r),st(0,1),n(s)})}var z=0;function Z(e,t=7e3){ut(e,"info",t)}function I(e,t=7e3){ut(e,"error",t)}function ut(e,t,n){let r=document.getElementById("toast");r.setAttribute("data-kind",t),r.style.pointerEvents="auto",r.style.opacity="1";let o=document.getElementById("toast-msg");o.textContent=e,z!==0&&(clearTimeout(z),z=0),z=setTimeout(Y,n)}function Y(){let e=document.getElementById("toast");e.style.pointerEvents="none",e.style.opacity="0"}function ve(e,t,n){let r=n*(1-t/2);if(r==0||r==1)return[e,0,r];let o=(n-r)/Math.min(r,1-r);return[e,o,r]}function Te(e,t,n){return`hsl(${e} ${t*100}% ${n*100}%`}var ft={};function hn(e){let t=ft[e];if(t)return t;let n=Ze(e),r=(sn,qe,an)=>qe+sn*(an-qe),o=r(parseInt(n.substr(7,3),16)/4096*360,0,360),i=r(parseInt(n.substr(2,2),16)/255,.4,.8),s=r(parseInt(n.substr(4,2),16)/255,.2,.4),a=Math.min(i*.8,1),c=Math.min(s*3,1),l=Math.min(i*.8,1),g=Math.min(s*4,1),u={bkg:Te(...ve(o,i,s)),border:Te(...ve(o,a,c)),text:Te(...ve(o,l,g))};return ft[e]=u,u}var T={};function be(){T={}}function vn(e){T[e]=T[e]+1||1}function Tn(e){--T[e]==0&&delete T[e]}function Se(e){let t=[];for(let n of Object.keys(T))n.startsWith(e)&&n!=e&&t.push(n);return t.sort((n,r)=>T[r]-T[n]),t}function Ie(e){try{let t=e.id,r=m().transaction("tags").objectStore("tags").get(t);r.onsuccess=o=>{let i=r.result;if(i){let s=e.querySelector(".tag-container");for(let a of i.tags)B(s,a)}}}catch(t){I(`Error loading tags: ${t}`)}}function Fe(e){let t=e?.parentElement?.parentElement;if(!t)throw"tagContainer without parent";return t.id}function X(e){let t=Fe(e);if(t){let n=ee(e),r=m().transaction("tags","readwrite").objectStore("tags");n.length>0?r.put({tags:n},t):r.delete(t)}}async function pt(){try{let e={types:[{description:"Exported tags",accept:{"application/json":[".json"]}}],suggestedName:"exported-tags.json"},n=await(await window.showSaveFilePicker(e)).createWritable(),r={};for(let i of document.getElementsByClassName("entry")){let s=i.id,a=i.getAttribute(f);if(!s||!a)continue;let c=i.querySelector(".tag-container");if(!c)continue;let l=ee(c);l.length!==0&&(r[s]={name:a,tags:l})}let o=new Blob([JSON.stringify(r)],{type:"application/json"});await n.write(o),await n.close()}catch(e){return console.log("errol:",e),!1}return!0}function bn(e){if(!("name"in e&&typeof e.name=="string")||!("tags"in e&&Array.isArray(e.tags)))return!1;for(let t of e.tags)if(typeof t!="string")return!1;return!0}async function yt(e){try{let t={types:[{description:"Tags",accept:{"application/json":[".json"]}}],multiple:!1},[n]=await window.showOpenFilePicker(t),o=await(await n.getFile()).arrayBuffer(),i=new Uint8Array(o),s=new TextDecoder("utf-8"),a=JSON.parse(s.decode(i)),l=m().transaction("tags","readwrite").objectStore("tags");for(let[g,u]of Object.entries(a))g.length===64&&bn(u)&&l.put({tags:u.tags},g);e()}catch(t){console.log("errol:",t)}}function J(e){return e.childNodes[0].textContent||""}function ee(e){let t=[],n=e.children;for(let r=1;r<n.length;++r)t.push(J(n[r]));return t}function we(e,t){let n=document.createElement("span");n.className="tag",n.textContent=e;let r=hn(e);if(n.style.background=r.bkg,n.style.borderColor=r.border,n.style.color=r.text,n.addEventListener("click",o=>{o.stopPropagation()}),!t||!t.displayOnly){let o=document.createElement("span");o.className="tag-delete",o.textContent="x",o.addEventListener("click",In),n.appendChild(o)}return n}function Et(e){return e.trim().toLowerCase()}function Le(e,t){t=Et(t);let n=e.children;for(let r=1;r<n.length;++r)if(t===J(n[r]))return!0;return!1}function B(e,t){vn(t),e.appendChild(we(t)),Ce(e)}function gt(e,t){let n=Et(t||"");if(n===""||Le(e,n))return;B(e,n),X(e);let r=Fe(e);je(r,n)}function Sn(e){let t=e.currentTarget;if(!t.classList.contains("tag-add"))return;let n=t.parentElement;if(!n)throw"event on unparented tagContainer";switch(e.key){case"Escape":t.textContent="+",t.blur();break;case"Tab":t.textContent==""||t.textContent=="+"?(t.textContent="+",t.blur()):(gt(n,t.textContent),t.textContent="",setTimeout(()=>{t.focus()},0)),e.preventDefault();break;case"Enter":gt(n,t.textContent),t.textContent="+",t.blur();break}e.stopPropagation()}function ht(){let e=document.createElement("span");e.className="tag-add",e.textContent="+",e.contentEditable="true",e.setAttribute("spellcheck","false"),e.setAttribute("tabindex","-1"),e.addEventListener("click",n=>{e.textContent="",n.stopPropagation()}),e.addEventListener("focusout",n=>{e.textContent="+"}),e.addEventListener("keydown",Sn);let t=document.createElement("div");return t.className="tag-container",t.appendChild(e),Ce(t),t}function Ce(e){let t=e.querySelectorAll(".tag").length,n=e?.parentElement?.parentElement;n&&n.setAttribute(q,`${t}`)}function te(e,t){Tn(t);for(let n of e.children)if(t===J(n)){e.removeChild(n),Ce(e);break}}function In(e){if(!e.currentTarget)return;e.stopPropagation();let n=e.currentTarget.parentElement;if(!n)return;let r=J(n),o=n.parentElement;if(!o)throw"unparented tagDelete";te(o,r),X(o);let i=Fe(o);$e(i,r)}function vt(e){let t=document.getElementById(e.data.hash);if(t){let n=t.querySelector(".tag-container");if(!n)return;e.data.tagAdd&&B(n,e.data.tagAdd),e.data.tagRemove&&te(n,e.data.tagRemove)}}function E(){return document.getElementById("search-entry")}function bt(e){let t=document.getElementsByClassName("entry");if(e){let n=Bn(e);for(let r of t){let o=r;xn(o,n)?o.style.display="":o.style.display="none"}}else for(let n of t){let r=n;r.getAttribute(b)||(r.style.display="")}}function Fn(e){return Number.parseInt(e.getAttribute(_)||"0")}function wn(e){return Number.parseInt(e.getAttribute(G)||"0")}function Ln(e){return Number.parseInt(e.getAttribute(q)||"0")}function Cn(e){return Number.parseInt(e.getAttribute(D)||"0")/(1024*1024)}function Dn(e){return Number.parseInt(e.getAttribute(D)||"0")/(1024*1024*1024)}function xn(e,t){if(e.getAttribute(b))return!1;for(let r of t.scalarMatchers)if(!r(e))return!1;if((e.getAttribute(f)||"").toLowerCase().indexOf(t.freetext)===-1)return!1;if(t.includeTags.length||t.excludeTags.length){let r=e.querySelector(".tag-container"),o=r?ee(r):[];for(let i of t.includeTags)if(o.indexOf(i)===-1)return!1;for(let i of t.excludeTags)if(o.indexOf(i)!==-1)return!1}return!0}function Hn(e){let t=e.match(/^(>=|>|=|<|<=)([0-9]+)([ptmg]?)$/);if(!t)return;let n=Fn;t[3]=="p"?n=wn:t[3]=="t"?n=Ln:t[3]=="m"?n=Cn:t[3]=="g"&&(n=Dn);let r=Number.parseInt(t[2]);switch(t[1]){case">=":return o=>n(o)>=r;case">":return o=>n(o)>r;case"=":return o=>n(o)==r;case"<":return o=>n(o)<r;case"<=":return o=>n(o)<=r}}function Mn(e,t){let n=Hn(e);return n?(t.scalarMatchers.push(n),!0):!1}function Bn(e){let t={freetext:"",includeTags:[],excludeTags:[],scalarMatchers:[]},n=e.slice(-1);(n=="+"||n=="-")&&(e=e.slice(0,-1));let r=[];for(let o of e.trim().toLowerCase().split(" "))o[0]=="+"&&o.length>=2?t.includeTags.push(o.substring(1)):o[0]=="-"&&o.length>=2?t.excludeTags.push(o.substring(1)):Mn(o,t)||r.push(o);return t.freetext=r.join(" "),t}function St(e,t){let n=t;if(n==e.length||e[n]==" "){for(;n--&&e[n]!=" ";)if((e[n]=="+"||e[n]=="-")&&(n==0||e[n-1]==" "))return e.substring(n+1,t)}}function A(){let e=E();bt(e.value.trim().toLowerCase()),Ct(),Dt()}function It(){let e=E(),t=document.getElementById("completion");if(y(t),e.selectionStart!=e.selectionEnd){F();return}let n=!1,r=St(e.value,e.selectionStart||0);if(r!==void 0){let o=Se(r);if(o.length>0){n=!0;for(let i of o)t.appendChild(we(i,{displayOnly:!0}));Pn()}}n||F()}function Ft(e){if(e.key==="Tab"){let t=E();if(t.selectionStart==t.selectionEnd){let n=t.selectionStart||0,r=St(t.value,n);if(r!==void 0){let o=Se(r);if(o.length===1){let i=o[0].substring(r.length)+" ";t.setRangeText(i);let s=n+i.length;t.setSelectionRange(s,s),A(),e.preventDefault(),F()}}}}else setTimeout(It,0)}function wt(e){It()}function Lt(e){let t=E();Ct(),Dt(),bt(t.value.trim().toLowerCase())}function Ct(){let e=E(),t=document.getElementById("clear-search");t.style.visibility=e.value.length===0?"hidden":"visible"}function Dt(){let e=E(),t=document.getElementById("save-search");e.value.length===0?t.setAttribute("disabled",""):t.removeAttribute("disabled")}function xt(){kt("")}var An=["width","height","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontSize","fontFamily","textAlign"];function kn(e,t){let n=e.id+"--mirror",r=document.getElementById(n);if(!r){r=document.createElement("div"),r.id=n;let i=getComputedStyle(e),s=r.style;s.position="absolute",s.visibility="hidden",s.overflow="hidden",An.forEach(a=>{s[a]=i[a]}),document.body.appendChild(r)}r.textContent=e.value.substring(0,t).replace(/\s/g,"\xA0");let o=document.createElement("span");return o.textContent=".",r.appendChild(o),o.offsetLeft}function Pn(){let e=E(),t=document.getElementById("completion"),n=kn(e,e.selectionStart||0),r=-e.scrollLeft+n+10,o=e.offsetWidth-r-10;t.style.left=`${e.offsetLeft+r}px`,t.style.top=`${e.offsetTop+4}px`,t.style.width=`${o}px`,t.style.display="block"}function F(){let e=document.getElementById("completion");e.style.display="none",y(e)}function Ht(){let e=document.getElementById("save-query-name");e.value="";let t=document.getElementById("save-query-query");t.value=E().value.trim(),document.getElementById("save-query-dialog").showModal()}function De(){let e=document.getElementById("save-query-name"),t=document.getElementById("save-query-query"),n=e.value.trim(),r=t.value.trim();n!==""&&r!==""&&(He(n,r),xe())}var Mt="storedQueries";function Bt(){let t=m().transaction("misc").objectStore("misc").get(Mt);t.onsuccess=n=>{let r=t.result||[];for(let o of r)He(o.name,o.search)}}function xe(){let e=[],t=document.getElementById("saved-searches");for(let o of t.children){let i=o.getAttribute(f),s=o.getAttribute("data-search");!i||!s||e.push({name:i,search:s})}m().transaction("misc","readwrite").objectStore("misc").put(e,Mt),Ke(e)}function At(e){e.key==="Enter"&&De()}function kt(e){let t=E();t.value=e,t.dispatchEvent(new Event("change"))}function Un(e){e.dataTransfer&&(e.dataTransfer.effectAllowed="move")}function On(e,t){let n=document.elementFromPoint(e,t);if(n){if(n.classList.contains("ss"))return n;if(n.classList.contains("ss-del")||n.classList.contains("ss-name"))return n.parentElement}return null}function Rn(e){let t=e.target;if(!t)return;let n=t.parentElement,r=On(e.clientX,e.clientY);if(r&&r.parentElement===n){if(r!==t){let o=r.offsetHeight;e.clientY>r.offsetTop+o/2?n.insertBefore(t,r.nextSibling):n.insertBefore(t,r)}}else{let o=n.getBoundingClientRect();e.clientX>=o.left&&e.clientX<o.right&&(e.clientY<o.top&&t!==n.firstChild?n.insertBefore(t,n.firstChild):e.clientY>=o.bottom&&t!==n.lastChild&&n.appendChild(t))}e.preventDefault(),e.stopPropagation()}function Nn(e){e.dataTransfer&&(e.dataTransfer.effectAllowed="move"),e.preventDefault(),e.stopPropagation()}function _n(e){xe(),e.preventDefault(),e.stopPropagation()}function He(e,t){let n=document.createElement("div");n.className="ss",n.setAttribute(f,e),n.setAttribute("data-search",t),n.setAttribute("draggable","true"),n.addEventListener("dragstart",Un),n.addEventListener("drag",Rn),n.addEventListener("dragover",Nn),n.addEventListener("dragend",_n);let r=document.createElement("button");r.className="ss-del",r.setAttribute("tabindex","-1"),r.title="Delete query",r.addEventListener("click",()=>{i.removeChild(n),xe()}),n.appendChild(r);let o=document.createElement("span");o.className="ss-name",o.textContent=e,o.title=t,o.addEventListener("click",()=>{kt(t)}),n.appendChild(o);let i=document.getElementById("saved-searches");i.appendChild(n)}function Pt(e){let t=document.getElementById("saved-searches");y(t);for(let n of e.data.queries)He(n.name,n.search)}function Gt(e){let t=e.substr(e.lastIndexOf(".")+1).toLowerCase();return tn.indexOf(t)>=0}var qt="settings",L=!1,U=!1,O=null;function qn(e){let n=m().transaction("misc").objectStore("misc").get(qt);n.onsuccess=r=>{let o=n.result;o&&(L=!!o.shuffleMode,U=!!o.loopSingle),e()},n.onerror=()=>{I("Error loading preferences"),e()}}function Vt(){let t=m().transaction("misc","readwrite").objectStore("misc"),n={shuffleMode:L,loopSingle:U};t.put(n,qt).onsuccess=()=>{console.log("settings saved",n)}}function d(){return document.getElementById("video-player")}function se(){return document.getElementById("video-container")}function ae(){return document.getElementById("entries")}function Oe(){return document.getElementById("gallery-container")}function jt(e){return e?.getAttribute(f)||""}function Re(e){return e.querySelector(".entry-image")}function $t(e){Kt(),Ae=null,O=e,d().pause(),le(e,t=>{Vn(URL.createObjectURL(t))})}function R(){return O?document.getElementById(O):null}function le(e,t){let n=P[e];if(n){t(n);return}let r=Ue[e];if(r){let o=$[r.galleryId];o&&o.root.getFile(r.fullPath,{create:!1},i=>{i.file(t)});return}}function Vn(e){let t=d();t.src&&(URL.revokeObjectURL(t.src),t.src=""),t.autoplay=!0,t.src=e}function jn(e){let t=e.lastIndexOf(".");if(t==-1)return e;let n=e.substr(t+1).toLowerCase();return tn.indexOf(n)==-1?e:e.substr(0,t)}function Qt(e){return e.getElementsByTagName("img")[0]}var h=null,S=0,Me=3;function $n(e){if(e<30)return 4;if(e>3600)return 15;let i=(e-30)/(3600-30);return Math.floor(Math.sqrt(i)*(15-4)+4)}function Qn(e,t){let n=$n(e);if(n*(t+3)>e)return[];let o=e/n,i=[],s=o;for(let a=1;a<n;++a)i.push(s),s+=o;return i}function Kt(){if(h){Qt(h).style.display="";for(let e of h.getElementsByTagName("video")){let t=e.src;e.pause(),e.src="",e.remove(),URL.revokeObjectURL(t)}S&&(clearTimeout(S),S=0),h=null}}var ie=[],re=0;function Wt(){if(S=0,h){let e=h.getElementsByTagName("video");if(e.length!=1)return;let t=e[0];t.currentTime=ie[re],S=setTimeout(Wt,Me*1e3),++re==ie.length&&(re=0)}}function Kn(e){if(h||S||!e.parentElement)return;h=e;let t=e.parentElement.id,n=Qt(e),r=Math.floor(n.offsetWidth),o=Math.floor(n.offsetHeight);t&&le(t,i=>{let s=URL.createObjectURL(i);if(h!=e){URL.revokeObjectURL(s);return}let a=document.createElement("video");a.style.height=`${o}px`,a.style.display="none",a.muted=!0,a.autoplay=!0,a.loop=!0,e.appendChild(a),a.src=s,a.addEventListener("loadedmetadata",()=>{n.style.display="none",a.style.display="",re=0,ie=Qn(a.duration,Me),ie.length>0&&(S=setTimeout(Wt,Me*1e3))},!1)})}var Be=null,oe=0;function Wn(e){Be=e.target,oe=setTimeout(()=>{Be==e.target&&Kn(e.target)},500)}function zn(e){Be=null,oe!==0&&(clearTimeout(oe),oe=0),Kt()}function zt(e){let t=jn(e),n=document.createElement("div");n.className="entry",n.addEventListener("click",Xn),n.setAttribute(f,t);let r=document.createElement("div");r.className="entry-preview",r.addEventListener("mouseenter",Wn),r.addEventListener("mouseleave",zn);let o=document.createElement("img");o.className="entry-image",r.appendChild(o),r.appendChild(ht());let i=document.createElement("div");i.className="duration-badge",r.appendChild(i);let s=document.createElement("div");s.className="quality-badge",r.appendChild(s);let a=document.createElement("div");a.className="file-size-badge",r.appendChild(a),n.appendChild(r);let c=document.createElement("div");return c.className="entry-title",c.textContent=t,n.appendChild(c),n}function Zn(){let e=ae(),t=[...e.children];for(let n=t.length-1;n>0;n--){let r=Math.floor(Math.random()*(n+1));[t[n],t[r]]=[t[r],t[n]]}t.forEach(n=>{e.appendChild(n)})}function Yn(){let e=ae(),t=[...e.children];t.sort((n,r)=>{let o=n.getAttribute(f)||"",i=r.getAttribute(f)||"";return o.localeCompare(i)}),t.forEach(n=>{e.appendChild(n)})}function Ne(){L?Zn():Yn()}function Zt(){let e=document.getElementById("shuffle-button");L?(e.style.backgroundPositionY="0px",e.style.backgroundImage="url(./assets/shuffle-icon.svg)",e.title="Shuffle on"):(e.style.backgroundPositionY="-2px",e.style.backgroundImage="url(./assets/sort-icon.svg)",e.title="Shuffle off")}function Yt(){let e=document.getElementById("loop-button"),t=d();U?(e.classList.remove("disabled"),e.title="Loop single on",t.setAttribute("loop","")):(e.classList.add("disabled"),e.title="Loop single off",t.removeAttribute("loop"))}function _e(){return Oe().style.display!=="none"}var ne=0;function C(e,t,n){let r=document.getElementById("osd");if(!e){r.style.display="none";return}ne&&(clearTimeout(ne),ne=0),r.style.display="",r.style.fontSize=`${n}px`,r.textContent=e,ne=setTimeout(()=>{r.style.display="none"},t)}async function Xn(e){if(!e.currentTarget)return;e.preventDefault(),e.stopPropagation();let t=e.currentTarget;if(t.getAttribute(b))return;let n=d();if(t==R())try{await n.play()}catch(r){console.log("Error playing video",r),Jt()}else se().style.background="",$t(t.id)}function Jn(){if(d().src){er();let t=R();if(t&&"mediaSession"in navigator){let n=Re(t),r={title:jt(t),artist:"VideoQueen",artwork:[{src:n.src,sizes:`${n.naturalWidth}x${n.naturalHeight}`,type:"image/webp"}]};navigator.mediaSession.metadata=new MediaMetadata(r)}}}function Xt(){let e=d();e.paused||e.pause(),Oe().style.display="block",document.getElementById("sidebar").style.display="block",se().style.display="none",document.getElementById("progress-container").style.display="",C(null),dt()}function er(){_e()&&(Oe().style.display="none",document.getElementById("sidebar").style.display="none",se().style.display="block",document.getElementById("progress-container").style.display="none",Y()),ct()}function Jt(){let e=d();I(`Error playing video: ${e.error?e.error.message:""}`)}function Ut(e,t){return String(e).padStart(t,"0")}function en(e){e=Math.floor(e);let t=Math.floor(e/3600),n=Math.floor(e%3600/60),r=e%60,o=Ut(r,2);if(t){let i=Ut(n,2);return`${t}:${i}:${o}`}return`${n}:${o}`}function tr(){let e=d();if(e.duration){let t=en(e.currentTime),n=Math.round(e.currentTime/e.duration*100);C(`Time: ${t} (${n}%)`,3e3,38)}}function nr(){let e=d();C(`Volume: ${Math.round(e.volume*100)}%`,3e3,38)}function rr(){let e=d();C(`Speed: ${Math.round(e.playbackRate*100)}%`,3e3,38)}function or(){ke()}function ir(){let e=d();if(e.src&&e.paused&&O){let t=e.currentTime,n=O;Xt();let r=document.getElementById(n);if(!r)return;le(n,function(o){ye(o,t,i=>{if(i.image){let a=Re(r).src;Pe(r,i),URL.revokeObjectURL(a),Ee(n,i)}})})}}async function Ot(){if(document.fullscreenElement)document.exitFullscreen();else try{await se().requestFullscreen()}catch(e){console.log("fullscreen failed: ",e)}}function Rt(e,t){t.paused&&!t.error?t.play():t.pause()}var Ae=null,k=0;function p(e,t){let n=parseInt(e.key);Ae===n?(k+=.01,k>=1&&(k=0)):k=n/10,Ae=n,t.currentTime=t.duration*k}function w(e,t={}){return(n,r)=>{if(!t.pauseOnly||r.paused){let o=n.shiftKey&&t.shiftDelta?t.shiftDelta:e,i=r.currentTime;r.currentTime=Math.max(Math.min(i+o,r.duration),0)}}}var sr={Enter:Ot,f:Ot,t:ir,p:Nt,n:ke,PageUp:Nt,PageDown:ke,0:p,1:p,2:p,3:p,4:p,5:p,6:p,7:p,8:p,9:p,j:w(-10),l:w(10),",":w(-1/30,{pauseOnly:!0}),".":w(1/30,{pauseOnly:!0}),ArrowLeft:w(-5,{shiftDelta:-30}),ArrowRight:w(5,{shiftDelta:30})," ":Rt,k:Rt,Escape:(e,t)=>{t.paused||t.pause(),Xt()},"[":(e,t)=>{t.playbackRate>.1&&(t.playbackRate-=.05)},"]":(e,t)=>{t.playbackRate<10&&(t.playbackRate+=.05)},"=":(e,t)=>{t.playbackRate=1},ArrowUp:(e,t)=>{t.volume=Math.min(t.volume+.1,1)},ArrowDown:(e,t)=>{t.volume=Math.max(t.volume-.1,0)},i:()=>{let e=R();e&&C(jt(e),7e3,24)},d:()=>{let e=R();if(e){let t=e.querySelector(".tag-container");if(t){let n="delete";Le(t,n)?(Z(`Removed '${n}' tag`,3e3),te(t,n)):(Z(`Added '${n}' tag`,3e3),B(t,n)),X(t)}}}};function ar(e){if(document.activeElement&&document.activeElement.tagName==="INPUT")return;if(_e()){if(e.code==="Escape"){let n=d();n.paused&&n.src&&!n.error&&n.play(),e.preventDefault(),e.stopPropagation()}e.key==="k"&&e.ctrlKey&&(document.getElementById("search-entry").focus(),e.preventDefault(),e.stopPropagation());return}let t=sr[e.key];t&&(t(e,d()),e.preventDefault(),e.stopPropagation())}function lr(){U=!U,Yt(),Vt()}function cr(){L=!L,Ne(),Zt(),Vt()}function dr(e){if(!_e()){let t=d();t.volume=Math.max(Math.min(t.volume+e.deltaY/560,1),0)}}var tn=["avi","m4v","mkv","mov","mp4","mpeg","mpeg4","ogg","ogv","webm","wmv"];function ur(){let e=[],t=document.getElementsByClassName("entry");for(let n of t){let r=n;r.style.display!=="none"&&e.push(r)}return e}function nn(e){let t=ur(),n=R();if(!n)return;let r=t.indexOf(n);if(!(r<0))for(let o=0;o!=t.length-1;++o){r=e?r<t.length-1?r+1:0:r>0?r-1:t.length-1;let i=t[r];if(!i.getAttribute(b)&&!i.getAttribute(N)){C(null),$t(i.id);break}}}function ke(){nn(!0)}function Nt(){nn(!1)}function Pe(e,t){let n=Re(e);if(t.unsupported)e.setAttribute(b,"true"),e.style.display="none";else{let r=e.querySelector(".duration-badge");r.textContent=en(t.duration),e.setAttribute(_,`${t.duration}`),e.setAttribute(G,`${t.height}`);let o=e.querySelector(".quality-badge");o.textContent=`${t.width}x${t.height}`,n.src=URL.createObjectURL(t.image)}}function rn(e,t){at(e,n=>{if(n){Pe(t,n);return}le(e,r=>{lt(r,o=>{o.image||(o={unsupported:!0}),Pe(t,o),Ee(e,o)})})})}var P={};function on(e){document.getElementById("initial-view").style.display="none",be(),P={};for(let n of document.getElementsByClassName("entry-image")){let r=n;URL.revokeObjectURL(r.src)}let t=ae();y(t);for(let n of e){if(!Gt(n.name))continue;let r=zt(n.name);t.appendChild(r),ue(n,o=>{if(document.getElementById(o)){let s=r.querySelector(".entry-preview");if(s){s.setAttribute(N,"true"),r.setAttribute(N,"true");let c=document.createElement("div");c.className="dupe-badge",c.textContent=`Dupe of ${P[o].name}`,s.append(c)}let a=r.querySelector(".tag-container");a&&a.remove()}else{r.setAttribute("id",o),r.setAttribute(D,`${n.size}`);let s=r.querySelector(".file-size-badge");s.textContent=Ye(n.size),Ie(r),P[o]=n}rn(o,r)})}Ne(),A()}var Ue={};function mr(){be(),Ue={};for(let t of document.getElementsByClassName("entry-image")){let n=t;URL.revokeObjectURL(n.src)}let e=ae();y(e),Xe(t=>{ot(t,n=>{if(!Gt(n.file.fullPath))return;let r=zt(n.file.name);e.appendChild(r),ue(n.file,function(o){r.setAttribute("id",o),Ue[o]={galleryId:n.galleryId,fullPath:n.file.fullPath},rn(o,r),Ie(r)})},()=>{Ne(),A()})})}function Ge(){if(x())mr();else{let e=Object.values(P);e.length>0&&on(e)}}function fr(){rt(Ge)}async function gr(e){e.preventDefault();let t=await pt();document.getElementById("settings-dialog").close(),t&&Z("Tags exported")}function pr(e){e.preventDefault(),yt(Ge)}function yr(){F()}function Er(e){let t=e.target,n=document.getElementById("top-gradient-mask"),r=document.getElementById("bottom-gradient-mask");t.scrollTop==0?n.style.opacity="0":n.style.opacity="1",t.scrollTop>=t.scrollHeight-t.offsetHeight-2?r.style.opacity="0":r.style.opacity="1"}async function _t(e){let t={id:"boop",mode:"read",startIn:"videos"};try{let n=await window.showDirectoryPicker(t),r=[],o=async s=>{for await(let[a,c]of s.entries())c.kind==="file"?r.push(c.getFile()):c.kind==="directory"&&await o(c)};await o(n);let i=await Promise.all(r);on(i)}catch(n){console.log("errol: ",n)}}function hr(){let e=document.getElementById("sidebar");e.setAttribute("data-flash","true"),setTimeout(()=>{e.removeAttribute("data-flash")},500),De()}async function vr(){if("serviceWorker"in navigator)try{let e=await navigator.serviceWorker.register("service-worker.js",{scope:"./"});e.installing?console.log("Service worker installing"):e.waiting?console.log("Service worker installed"):e.active&&console.log("Service worker active")}catch(e){console.error(`Registration failed with ${e}`)}}globalThis.addEventListener("load",function(){globalThis.addEventListener("keydown",ar,{capture:!0});let e=document.getElementById("search-entry");e.addEventListener("input",A),e.addEventListener("blur",F),e.addEventListener("change",Lt),e.addEventListener("keydown",Ft),e.addEventListener("focus",wt);let t=d();if(t.addEventListener("play",Jn,!1),t.addEventListener("error",Jt,!1),t.addEventListener("seeking",tr,!1),t.addEventListener("volumechange",nr,!1),t.addEventListener("ratechange",rr,!1),t.addEventListener("ended",or,!1),document.addEventListener("dragover",function(n){n.dataTransfer&&(n.dataTransfer.dropEffect="none"),n.preventDefault()},!1),document.addEventListener("drop",function(n){n.preventDefault()},!1),document.addEventListener("wheel",dr,!1),document.getElementById("gallery-view").addEventListener("scroll",Er),document.getElementById("save-query-dialog").addEventListener("keydown",At),document.getElementById("loop-button").addEventListener("click",lr),document.getElementById("shuffle-button").addEventListener("click",cr),document.getElementById("clear-search").addEventListener("click",xt),document.getElementById("save-search").addEventListener("click",Ht),document.getElementById("save-query-confirm").addEventListener("click",hr),document.getElementById("saved-searches").addEventListener("dragover",n=>{n.preventDefault(),n.stopPropagation()}),document.getElementById("settings").addEventListener("click",tt),document.getElementById("settings-confirm").addEventListener("click",fr),document.getElementById("settings-add-folder").addEventListener("click",nt),document.getElementById("settings-export-tags").addEventListener("click",gr),document.getElementById("settings-import-tags").addEventListener("click",pr),document.querySelector("#folder-grid-header > .folder-enable").addEventListener("click",et),document.getElementById("open-folder").addEventListener("click",_t),document.getElementById("initial-open-folder").addEventListener("click",_t),document.getElementById("toast-close").addEventListener("click",Y),globalThis.addEventListener("resize",yr),x()?document.getElementById("initial-view").style.display="none":(document.getElementById("folder-grid-container").style.display="none",document.getElementById("settings-add-folder").style.display="none",vr()),Qe(vt),We(Pt),"windowControlsOverlay"in navigator){let n=r=>{let o=document.getElementById("pwa-flair");o.style.visibility=r?"visible":"hidden"};n(navigator.windowControlsOverlay.visible),navigator.windowControlsOverlay.addEventListener("geometrychange",r=>{if(n(r.visible),console.log("geometrychange",r),r.visible){let o=r.titlebarAreaRect}})}it(n=>{n?(Bt(),qn(()=>{Zt(),Yt(),Ge()})):I("Error opening IndexedDB")})});})();
