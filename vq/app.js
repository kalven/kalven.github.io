"use strict";(()=>{var ot=new BroadcastChannel("metadataChannel");function it(e){ot.postMessage(e)}function at(e){ot.addEventListener("message",e)}var y="data-name",F="data-bad-media",K="data-dupe",b="data-file-size",ae="data-file-dir",lt="vqStorage";var q=null,ct=[];function dt(e){console.log("storage init");let t=indexedDB.open(lt,5);t.onupgradeneeded=async n=>{console.log(`onupgradeneeded old=${n.oldVersion} new=${n.newVersion}`);let r=t.result;switch(n.oldVersion){case 0:console.log("Creating new DB"),r.createObjectStore("tags",{});case 1:console.log("Upgrading to version 2"),r.createObjectStore("previews",{});case 2:console.log("Upgrading to version 3"),r.createObjectStore("misc",{});case 3:console.log("Upgrading to version 4"),r.createObjectStore("metadata",{}),ct.push(Vn);case 4:console.log("Upgrading to version 5"),r.createObjectStore("dir_handles",{})}},t.onerror=n=>{q=null,e(!1)},t.onsuccess=async n=>{q=t.result;for(let r of ct)console.log("Running upgrade function"),await r(q);e(!0)}}function E(){if(!q)throw"DB not initialized";return q}async function ut(e){return new Promise((t,n)=>{let i=E().transaction(e,"readonly").objectStore(e).getAll();i.onerror=()=>{n(new Error(`Failed to getAll from ${e}`))},i.onsuccess=()=>{t(i.result)}})}async function Vn(e){return new Promise((t,n)=>{let r=e.transaction(["tags","metadata"],"readwrite"),o=r.objectStore("tags").openCursor(),i=r.objectStore("metadata"),a=[];o.onsuccess=async s=>{let c=o.result;if(c){let l={contentHash:c.key,tags:c.value.tags};a.push(new Promise((S,f)=>{let m=i.put({metadata:l},c.key);m.onsuccess=()=>S(),m.onerror=f})),c.continue()}else await Promise.all(a),t()},o.onerror=s=>{n(new Error("Could not open tags cursor"))}})}async function se(e,t){return new Promise((n,r)=>{let a=E().transaction(e,"readwrite").objectStore(e).openCursor(),s=0;a.onerror=()=>{r()},a.onsuccess=()=>{let c=a.result;c?(t.has(c.key)||(c.delete(),s++),c.continue()):n(s)}})}var Ae=new Map,mt=1;function ft(e){Ae.set(mt,e),mt++}var H=new Map;function g(e){let t=H.get(e)||{contentHash:e,tags:[],scenes:[],playbackSeconds:0};return t.scenes=t.scenes||[],t.tags=t.tags||[],t.playbackSeconds=t.playbackSeconds??0,t}function gt(e){let t=e.data.md;H.set(t.contentHash,t),Ae.forEach(n=>{n(t)})}function pt(){return new Promise((e,t)=>{let r=E().transaction("metadata","readonly").objectStore("metadata").getAll();r.onerror=o=>{t(new Error("Failed to initialize metadata"))},r.onsuccess=o=>{for(let i of r.result)H.set(i.metadata.contentHash,i.metadata);e()}})}function I(e,t){let n=structuredClone(g(e)),r=t(n);r!==void 0&&Gn(e,r)}async function yt(){try{let e={types:[{description:"Exported tags",accept:{"application/json":[".json"]}}],suggestedName:"exported-metadata.json"},n=await(await globalThis.showSaveFilePicker(e)).createWritable(),r=[];H.forEach((i,a)=>{r.push(i)});let o=new Blob([JSON.stringify({metadata:r})],{type:"application/json"});await n.write(o),await n.close()}catch(e){return console.log("export error:",e),!1}return!0}async function Et(){try{let e={types:[{description:"Metadata",accept:{"application/json":[".json"]}}],multiple:!1},[t]=await globalThis.showOpenFilePicker(e),r=await(await t.getFile()).arrayBuffer(),o=new Uint8Array(r),a=new TextDecoder("utf-8").decode(o),c=JSON.parse(a).metadata;for(let l of c)console.log(`updating metadata for ${l.contentHash}`),St(l.contentHash,l);return!0}catch(e){return console.log("import error:",e),!1}}async function ht(e){for(let t of H.keys())e.has(t)||H.delete(t);return se("metadata",e)}function Gn(e,t){St(e,t),Ae.forEach(n=>{n(t)}),it({md:t})}function St(e,t){H.set(e,t),E().transaction("metadata","readwrite").objectStore("metadata").put({metadata:t},e)}var d;function vt(e){d=e}var jn=624,zn=1e4;function Ce(e,t,n){let r={};function o(){l.style.width=`${jn}px`,r.width=l.videoWidth,r.height=l.videoHeight,r.duration=l.duration}function i(f){if(S!==0&&(clearTimeout(S),S=0),l.removeEventListener("error",c,!1),l.removeEventListener("canplay",s,!1),l.removeEventListener("loadedmetadata",o,!1),l.src="",f&&(r.image=f,f.size<1200&&t.retries>0)){--t.retries,typeof t.specificTime=="number"&&(t.specificTime+=1/30),Ce(e,t,n);return}n(r)}function a(){l.removeEventListener("seeked",a,!1),Kn(l,i)}function s(){l.removeEventListener("canplay",s,!1),l.pause(),t.specificTime||(t.specificTime=l.duration/2),l.addEventListener("seeked",a),l.currentTime=t.specificTime}function c(){i(null)}let l=document.getElementById("generator");l.addEventListener("canplay",s,!1),l.addEventListener("loadedmetadata",o,!1),l.addEventListener("error",c,!1),l.src=e;let S=setTimeout(c,zn);l.pause()}function Kn(e,t){let n=document.getElementById("canvas"),r=e.offsetWidth,o=e.offsetHeight;n.width=r,n.height=o;let i=e.offsetWidth,a=e.offsetHeight,s=n.getContext("2d",{willReadFrequently:!0});if(!s){t(null);return}s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high",s.drawImage(e,0,0,i,a),n.toBlob(t,"image/webp",.5)}var bt=new Map;function x(e){return bt.get(e)||{duration:0,width:0,height:0}}function Tt(e,t){let r=E().transaction("previews").objectStore("previews").get(e);r.onsuccess=o=>{Pt(e,r.result),t(r.result)}}function wt(e,t,n){De(e,t,void 0,n)}function De(e,t,n,r){At(1,0),Z.push({contentHash:e,file:t,specificTime:n,callback:r,processing:!1}),Z.length==1&&ke()}function Le(e,t){E().transaction("previews","readwrite").objectStore("previews").put(t,e)}function Mt(){Fe=!0}function It(){Fe=!1;let e=Z[0];e&&!e.processing&&ke()}async function xt(e){return se("previews",e)}function Pt(e,t){let n={duration:t&&t.duration||0,width:t&&t.width||0,height:t&&t.height||0};bt.set(e,n)}var le=0,Q=0;function At(e,t){let n=document.getElementById("progress-container"),r=document.getElementById("progress");Q==0&&(n.style.opacity="1"),le+=t,Q+=e,r.value=le,r.max=Q,le>=Q&&(n.style.opacity="0",Q=0,le=0)}var Z=[],Fe=!1;function ke(){if(Fe)return;let e=Z[0];e&&(e.processing=!0,Wn(e.contentHash,e.file,e.specificTime,t=>{Z.shift(),e.callback(t),ke()}))}function Wn(e,t,n,r){let o=URL.createObjectURL(t);Ce(o,{specificTime:n,retries:n===void 0?1:3},s=>{URL.revokeObjectURL(o),At(0,1),Pt(e,s),r(s)})}function w(e){for(;e.hasChildNodes();)e.removeChild(e.lastChild)}function J(e,t){w(e);let n=document.createElement("span");n.textContent=t,e.appendChild(n)}function Qn(e){return[...new Uint8Array(e)].map(t=>t.toString(16).padStart(2,"0")).join("")}async function Dt(e){let n=null;if(e.size<3*1024)n=await e.arrayBuffer();else{n=new ArrayBuffer(3*1024+8);let r=new BigUint64Array(n);r[0]=BigInt(e.size);let o=Math.floor((e.size-1024)/2),i=e.slice(0,1024).arrayBuffer(),a=e.slice(o,o+1024).arrayBuffer(),s=e.slice(e.size-1024,e.size).arrayBuffer(),c=new Uint8Array(n);c.set(new Uint8Array(await i),8),c.set(new Uint8Array(await a),1032),c.set(new Uint8Array(await s),8+2*1024)}return Qn(await crypto.subtle.digest("SHA-256",n))}function Lt(e){let t=3735928559,n=1103547991;for(let r=0,o;r<e.length;r++)o=e.charCodeAt(r),t=Math.imul(t^o,2654435761),n=Math.imul(n^o,1597334677);return t=Math.imul(t^t>>>16,2246822507)^Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507)^Math.imul(t^t>>>13,3266489909),(n>>>0).toString(16).padStart(8,"0")+(t>>>0).toString(16).padStart(8,"0")}function ce(e){if(e<1024)return`${e.toFixed()} B`;let t=["kB","MB","GB","TB","PB"],n=-1;do e/=1024,++n;while(Math.round(Math.abs(e)*100)/100>=1024&&n<t.length-1);return`${e.toFixed(2)} ${t[n]}`}function Ct(e,t){return String(e).padStart(t,"0")}function M(e,t=!1){e=Math.floor(e);let n=Math.floor(e/3600),r=Math.floor(e%3600/60),o=e%60,i=Ct(o,2);if(t)return`${n?`${n}h `:""} ${r}m ${o}s`;if(n){let a=Ct(r,2);return`${n}:${a}:${i}`}return`${r}:${i}`}function Ft(e){return e>=1048576?`${(e/1048576).toFixed(2)} Mbps`:`${(e/1024).toFixed(2)} Kbps`}function He(e,t,n){let r=n*(1-t/2);if(r==0||r==1)return[e,0,r];let o=(n-r)/Math.min(r,1-r);return[e,o,r]}function Be(e,t,n){return`hsl(${e} ${t*100}% ${n*100}%`}var kt={};function Oe(e){let t=kt[e];if(t)return t;let n=Lt(e),r=(m,v,L)=>v+m*(L-v),o=r(parseInt(n.substr(7,3),16)/4096*360,0,360),i=r(parseInt(n.substr(2,2),16)/255,.4,.8),a=r(parseInt(n.substr(4,2),16)/255,.2,.4),s=Math.min(i*.8,1),c=Math.min(a*3,1),l=Math.min(i*.8,1),S=Math.min(a*4,1),f={bkg:Be(...He(o,i,a)),border:Be(...He(o,s,c)),text:Be(...He(o,l,S))};return kt[e]=f,f}var C={};function Bt(){C={}}function Zn(e){C[e]=C[e]+1||1}function Yn(e){--C[e]==0&&delete C[e]}function Ue(e){let t=[];for(let n of Object.keys(C))n.startsWith(e)&&n!=e&&t.push(n);return t.sort((n,r)=>C[r]-C[n]),t}function Jn(e){let t=e?.parentElement?.parentElement;if(!t)throw"tagContainer without parent";return t.id}function Ot(e){let t=Jn(e);t&&I(t,n=>(n.tags=Ut(e),n))}function de(e){return e.childNodes[0].textContent||""}function Ut(e){let t=[],n=e.children;for(let r=1;r<n.length;++r)t.push(de(n[r]));return t}function Xn(e,t){return e.length!=t.length?!1:e.every((n,r)=>n===t[r])}function _t(e,t){let n=Ut(e);if(!Xn(n,t)){for(let r of n)Gt(e,r);for(let r of t)Rt(e,r)}}function _e(e,t){let n=document.createElement("span");n.className="tag",n.textContent=e;let r=Oe(e);if(n.style.background=r.bkg,n.style.borderColor=r.border,n.style.color=r.text,n.addEventListener("click",o=>{o.stopPropagation()}),n.addEventListener("mouseover",()=>{let o=C[e];o&&(n.title=`${o} video${o>1?"s":""}`)}),!t||!t.displayOnly){let o=document.createElement("span");o.className="tag-delete",o.textContent="x",o.addEventListener("click",rr),n.appendChild(o)}return n}var er=new Map([["outdoor","outdoors"],["naturals","natural"]]);function Nt(e){let t=e.trim().toLowerCase();return er.get(t)||t}function tr(e,t){t=Nt(t);let n=e.children;for(let r=1;r<n.length;++r)if(t===de(n[r]))return!0;return!1}function Rt(e,t){Zn(t),e.appendChild(_e(t))}function Ht(e,t){let n=Nt(t||"");n!==""&&(tr(e,n)||(Rt(e,n),Ot(e)))}function nr(e){let t=e.currentTarget;if(!t.classList.contains("tag-add"))return;let n=t.parentElement;if(!n)throw"event on unparented tagContainer";switch(e.key){case"Escape":t.textContent="+",t.blur();break;case"Tab":t.textContent==""||t.textContent=="+"?(t.textContent="+",t.blur()):(Ht(n,t.textContent),t.textContent="",setTimeout(()=>{t.focus()},0)),e.preventDefault();break;case"Enter":Ht(n,t.textContent),t.textContent="+",t.blur();break}e.stopPropagation()}function Vt(){let e=document.createElement("span");e.className="tag-add",e.textContent="+",e.contentEditable="true",e.setAttribute("spellcheck","false"),e.setAttribute("tabindex","-1"),e.addEventListener("click",n=>{e.textContent="",n.stopPropagation()}),e.addEventListener("focusout",n=>{e.textContent="+"}),e.addEventListener("keydown",nr);let t=document.createElement("div");return t.className="tag-container",t.appendChild(e),t}function Gt(e,t){Yn(t);for(let n of e.children)if(t===de(n)){e.removeChild(n);break}}function rr(e){if(!e.currentTarget)return;e.stopPropagation();let n=e.currentTarget.parentElement;if(!n)return;let r=de(n),o=n.parentElement;if(!o)throw"unparented tagDelete";Gt(o,r),Ot(o)}function X(){let e=O();qt(e.value.trim().toLowerCase()),Jt()}function $t(e){if(e.key==="Tab"){let t=O();if(t.selectionStart==t.selectionEnd){let n=t.selectionStart||0,r=Zt(t.value,n);if(r!==void 0){let o=Ue(r);if(o.length===1){let i=o[0].substring(r.length)+" ";t.setRangeText(i);let a=n+i.length;t.setSelectionRange(a,a),X(),e.preventDefault(),R()}}}}else setTimeout(Yt,0)}function jt(e){Yt()}function zt(e){let t=O();Jt(),qt(t.value.trim().toLowerCase())}function Kt(){yr("")}function R(){let e=document.getElementById("completion");e.style.display="none",w(e)}function O(){return document.getElementById("search-entry")}function qt(e){let t=document.getElementsByClassName("entry"),n=0;if(e){let o=Qt(e);for(let i of t){let a=i;Wt(a,o)?(a.style.display="",++n):a.style.display="none"}}else for(let o of t){let i=o;i.getAttribute(F)||(i.style.display="",++n)}let r=document.getElementById("video-count");J(r,`${n}`)}function or(e){return x(e.id).duration}function ir(e){return x(e.id).height}function ar(e){return g(e.id).tags.length}function sr(e){return g(e.id).scenes.length}function lr(e){return Number.parseInt(e.getAttribute(b)||"0")/(1024*1024)}function cr(e){return Number.parseInt(e.getAttribute(b)||"0")/(1024*1024*1024)}function Wt(e,t){if(t.union.length>0){for(let r of t.union)if(Wt(e,r))return!0;return!1}if(e.getAttribute(F))return!1;for(let r of t.scalarMatchers)if(!r(e))return!1;if((e.getAttribute(y)||"").toLowerCase().indexOf(t.freetext)===-1)return!1;if(t.includeTags.length||t.excludeTags.length){let r=g(e.id);for(let o of t.includeTags)if(r.tags.indexOf(o)===-1)return!1;for(let o of t.excludeTags)if(r.tags.indexOf(o)!==-1)return!1}return!0}function dr(e){let t=e.match(/^(>=|>|=|<|<=)([0-9]+)([ptsmg]?)$/);if(!t)return;let n=or;t[3]=="p"?n=ir:t[3]=="t"?n=ar:t[3]=="s"?n=sr:t[3]=="m"?n=lr:t[3]=="g"&&(n=cr);let r=Number.parseInt(t[2]);switch(t[1]){case">=":return o=>n(o)>=r;case">":return o=>n(o)>r;case"=":return o=>n(o)==r;case"<":return o=>n(o)<r;case"<=":return o=>n(o)<=r}}function ur(e,t){let n=dr(e);return n?(t.scalarMatchers.push(n),!0):!1}function mr(e,t){let n="dir:";if(!e.startsWith(n))return!1;let r=e.substr(n.length);return r.length===0?!1:(t.scalarMatchers.push(o=>o.getAttribute(ae)===r),!0)}function fr(e,t){let n=[];for(let r of e.split(t)){let o=r.trim();o!==""&&n.push(o)}return n.length===0?[e]:n}function Qt(e){let t={freetext:"",includeTags:[],excludeTags:[],scalarMatchers:[],union:[]},n=fr(e,"|");if(n.length>=2){for(let i of n)t.union.push(Qt(i));return t}let r=e.slice(-1);(r=="+"||r=="-")&&(e=e.slice(0,-1));let o=[];for(let i of e.trim().toLowerCase().split(" "))i[0]=="+"&&i.length>=2?t.includeTags.push(i.substring(1)):i[0]=="-"&&i.length>=2?t.excludeTags.push(i.substring(1)):ur(i,t)||mr(i,t)||o.push(i);return t.freetext=o.join(" "),t}function Zt(e,t){let n=t;if(n==e.length||e[n]==" "){for(;n--&&e[n]!=" ";)if((e[n]=="+"||e[n]=="-")&&(n==0||e[n-1]==" "))return e.substring(n+1,t)}}function Yt(){let e=O(),t=document.getElementById("completion");if(w(t),e.selectionStart!=e.selectionEnd){R();return}let n=!1,r=Zt(e.value,e.selectionStart||0);if(r!==void 0){let o=Ue(r);if(o.length>0){n=!0;for(let i of o)t.appendChild(_e(i,{displayOnly:!0}));pr()}}n||R()}function Jt(){let e=O(),t=document.getElementById("clear-search");t.style.visibility=e.value.length===0?"hidden":"visible"}function gr(e,t){let n=e.id+"--mirror",r=document.getElementById(n);if(!r){r=document.createElement("div"),r.id=n;let i=getComputedStyle(e),a=r.style;a.position="absolute",a.visibility="hidden",a.overflow="hidden",a.width=i.width,a.height=i.height,a.paddingTop=i.paddingTop,a.paddingRight=i.paddingRight,a.paddingBottom=i.paddingBottom,a.paddingLeft=i.paddingLeft,a.fontFamily=i.fontFamily,a.fontStyle=i.fontStyle,a.fontVariant=i.fontVariant,a.fontWeight=i.fontWeight,a.fontSize=i.fontSize,a.textAlign=i.textAlign,document.body.appendChild(r)}r.textContent=e.value.substring(0,t).replace(/\s/g,"\xA0");let o=document.createElement("span");return o.textContent=".",r.appendChild(o),o.offsetLeft}function pr(){let e=O(),t=document.getElementById("completion"),n=gr(e,e.selectionStart||0),r=-e.scrollLeft+n+10,o=e.offsetWidth-r-10;t.style.left=`${e.offsetLeft+r}px`,t.style.top=`${e.offsetTop+4}px`,t.style.width=`${o}px`,t.style.display="block"}function yr(e){let t=O();t.value=e,t.dispatchEvent(new Event("change"))}var Er=(e,t)=>{let n=e.getAttribute(y)||"",r=t.getAttribute(y)||"";return n.localeCompare(r)},hr=(e,t)=>{let n=Number.parseInt(e.getAttribute(b)||"0")||0,r=Number.parseInt(t.getAttribute(b)||"0")||0;return n-r},Sr=(e,t)=>{let n=x(e.id).duration,r=x(t.id).duration;return n-r},vr=(e,t)=>{let n=Number.parseInt(e.getAttribute(b)||"0")||0,r=Number.parseInt(t.getAttribute(b)||"0")||0,o=x(e.id).duration||1,i=x(t.id).duration||1,a=n/o,s=r/i;return a-s};function ue(e,t){let n=[...e.children];n.sort(t),n.forEach(r=>{e.appendChild(r)})}function br(e){let t=[...e.children];for(let n=t.length-1;n>0;n--){let r=Math.floor(Math.random()*(n+1));[t[n],t[r]]=[t[r],t[n]]}t.forEach(n=>{e.appendChild(n)})}var U=new Map([["shuffle",{icon:"url(./assets/shuffle-icon.svg)",tooltip:"Shuffle",func:e=>{br(e)}}],["by_name",{icon:"url(./assets/sort-icon.svg)",tooltip:"Sort by name",func:e=>{ue(e,Er)}}],["by_file_size",{icon:"url(./assets/sort-by-size.svg)",tooltip:"Sort by size",func:e=>{ue(e,hr)}}],["by_duration",{icon:"url(./assets/sort-by-duration.svg)",tooltip:"Sort by duration",func:e=>{ue(e,Sr)}}],["by_quality",{icon:"url(./assets/sort-by-quality.svg)",tooltip:"Sort by quality",func:e=>{ue(e,vr)}}]]);function en(e,t){let n=U.get(t);n&&n.func(e)}var me=0;function P(e,t=7e3){tn(e,"info",t)}function p(e,t=7e3){tn(e,"error",t)}function tn(e,t,n){let r=document.getElementById("toast");r.setAttribute("data-kind",t),r.style.pointerEvents="auto",r.style.opacity="1";let o=document.getElementById("toast-msg");o.textContent=e,me!==0&&(clearTimeout(me),me=0),me=setTimeout(fe,n)}function fe(){let e=document.getElementById("toast");e.style.pointerEvents="none",e.style.opacity="0"}var nn="settings",D="by_name",V=!1,_=!1;function rn(e){D=e}function on(e){V=e}function an(e){_=e}function Tr(e){return typeof e=="string"&&U.get(e)?e:"shuffle"}function sn(e){let n=E().transaction("misc").objectStore("misc").get(nn);n.onsuccess=r=>{let o=n.result;o&&(D=Tr(o.sortMode),V=!!o.loopSingle,_=!!o.hideDupes),e()},n.onerror=()=>{p("Error loading preferences"),e()}}function pe(){let t=E().transaction("misc","readwrite").objectStore("misc"),n={loopSingle:V,sortMode:D,hideDupes:_};t.put(n,nn).onsuccess=()=>{console.log("settings saved",n)}}var ye=class{maxConcurrency;current=0;q=[];constructor(t){this.maxConcurrency=t}run(t){this.q.push(t),this.tryRun()}tryRun(){if(this.current<this.maxConcurrency){let t=this.q.shift();t!==void 0&&(this.current++,t().then(()=>{this.current--,this.tryRun()}))}}};var dn=["avi","m4v","mkv","mov","mp4","mpeg","mpeg4","ogg","ogv","webm","wmv"];function un(){he=document.getElementById("entries"),We=document.getElementById("gallery-container"),pn=document.getElementById("initial-view"),yn=document.getElementById("previous-dirs-container"),Ve=document.getElementById("previous-dirs"),Ir()}function Se(e){return G[e]}function mn(){return new Set(Object.keys(G))}function je(){let e=Object.values(G);e.length>0&&En(e)}async function ze(){let e={id:"boop",mode:"read",startIn:"videos"};try{let t=await globalThis.showDirectoryPicker(e);E().transaction("dir_handles","readwrite").objectStore("dir_handles").put(t,t.name),await Ge(t)}catch(t){console.log("errol: ",t)}}function ve(e){return e.querySelector(".entry-image")}function Ke(){en(he,D)}function fn(){let e=d.getVideoElement(),t=d.getCurrentPlayingHash();if(e.src&&e.paused&&t){let n=e.currentTime;d.showGallery();let r=document.getElementById(t);if(!r)return;let o=Se(t);if(!o)return;De(t,o.file,n,i=>{if(i.image){let s=ve(r).src;$e(r,i),URL.revokeObjectURL(s),Le(t,i),I(t,c=>(c.thumbnailTime=n,c))}})}}function qe(e,t){let n=e.querySelector(".tag-container");_t(n,t.tags);let r=e.querySelector(".view-time-badge");r&&t.playbackSeconds&&(r.textContent=`Watch time: ${M(t.playbackSeconds)}`)}function cn(e){let t=e.substr(e.lastIndexOf(".")+1).toLowerCase();return dn.indexOf(t)>=0}function Mr(e){let t=e.lastIndexOf(".");if(t==-1)return e;let n=e.substr(t+1).toLowerCase();return dn.indexOf(n)==-1?e:e.substr(0,t)}var G={},Ee=0,ee=0,gn=0,he,We,pn,yn,Ve;async function Ge(e){let t=[],n=async(r,o)=>{for await(let[i,a]of o.entries())a.kind==="file"?t.push({file:await a.getFile(),dir:r}):a.kind==="directory"&&await n(i,a)};await n("root",e),En(t)}async function Ir(){let e=await ut("dir_handles");if(e.length!==0){yn.style.display="block",w(Ve);for(let t of e){let n=document.createElement("button");n.className="previous-dir-button",n.textContent=t.name,n.onclick=async()=>{if(await t.queryPermission({mode:"read"})==="granted"){await Ge(t);return}await t.requestPermission({mode:"read"})==="granted"?await Ge(t):p("Permission denied for directory.")},Ve.appendChild(n)}}}async function xr(e){if(!e.currentTarget)return;e.preventDefault(),e.stopPropagation();let t=e.currentTarget;if(t.getAttribute(F))return;let n=d.getVideoElement();if(t==d.getPlayingGalleryElement())try{await n.play()}catch(r){console.log("Error playing video",r),n.error&&p(`Error playing video: ${n.error.message}`)}else d.getVideoContainer().style.background="",d.play(t.id)}function Pr(e){let t=Mr(e),n=document.createElement("div");n.className="entry",n.addEventListener("click",xr),n.setAttribute(y,t);let r=document.createElement("div");r.className="entry-preview";let o=document.createElement("img");o.className="entry-image",r.appendChild(o),r.appendChild(Vt());let i=document.createElement("div");i.className="duration-badge",r.appendChild(i);let a=document.createElement("div");a.className="quality-badge",r.appendChild(a);let s=document.createElement("div");s.className="file-size-badge",r.appendChild(s);let c=document.createElement("div");c.className="view-time-badge",r.appendChild(c),n.appendChild(r);let l=document.createElement("div");return l.className="entry-title",l.textContent=t,n.appendChild(l),n}function $e(e,t){let n=ve(e);if(Ee<ee&&(++Ee,Ee==ee&&Cr()),t.unsupported)e.setAttribute(F,"true"),e.style.display="none";else{let r=e.querySelector(".duration-badge");r.textContent=M(t.duration);let o=e.querySelector(".quality-badge");o.textContent=`${t.width}x${t.height}`,n.src=URL.createObjectURL(t.image)}}function Ar(e,t){Tt(e,n=>{if(n){$e(t,n);return}let r=Se(e);r&&wt(e,r.file,o=>{o.image||(o={unsupported:!0}),$e(t,o),Le(e,o)})})}async function En(e){pn.style.display="none",Bt(),G={},Ee=0,gn=performance.now();for(let n of document.getElementsByClassName("entry-image")){let r=n;URL.revokeObjectURL(r.src)}w(he),ee=0;for(let n of e){let r=n.file;cn(r.name)&&++ee}ee>0&&(We.style.display="none");let t=new ye(64);for(let n of e){let r=n.file;if(!cn(r.name))continue;let o=Pr(r.name);he.appendChild(o),t.run(()=>Dt(r).then(i=>{if(document.getElementById(i)){let s=o.querySelector(".entry-preview");if(s){s.setAttribute(K,"true"),o.setAttribute(K,"true");let l=document.createElement("div");l.className="dupe-badge",l.textContent=`Dupe of ${G[i].file.name}`,s.append(l)}let c=o.querySelector(".tag-container");c&&c.remove()}else{o.setAttribute("id",i),o.setAttribute(b,`${r.size}`),o.setAttribute(ae,n.dir);let s=o.querySelector(".file-size-badge");s.textContent=ce(r.size),qe(o,g(i)),G[i]=n}Ar(i,o)}))}}function Cr(){We.style.display="block";let e=performance.now();console.log(`Total load time: ${e-gn}`),Ke(),X()}var te=0,Lr=4e3,ne=0,Fr=5e3;function be(e,t){let n=document.getElementById(e);J(n,t)}function $(e){e&&e.info&&(be("osd-info1",e.info),ne&&(clearTimeout(ne),ne=0),ne=setTimeout(()=>{be("osd-info1",""),ne=0},Fr));let t=document.getElementById("osd-container");t.style.opacity="1.0",te&&(clearTimeout(te),te=0),te=setTimeout(()=>{t.style.opacity="0",te=0},Lr)}function Te(){let e=document.getElementById("osd-container");e.style.opacity="0"}function re(e){let t=document.getElementById(e);if(t){let n=document.getElementById("osd-title"),r=t.getAttribute(y)||"";J(n,r);let o=document.getElementById("osd-fileinfo");w(o);let i=x(e),a=Number.parseInt(t.getAttribute(b)||"0")||0,s=a*8/(i.duration||1),c=[M(i.duration,!0),`${i.height}p`,ce(a),Ft(s)];for(let f of c){let m=document.createElement("span");m.textContent=f,m.className="badge",o.appendChild(m)}let l=document.getElementById("osd-tags");w(l);let S=g(e);if(S){for(let m of S.tags){let v=Oe(m),L=document.createElement("span");L.textContent=m,L.className="tag",L.style.background=v.bkg,L.style.borderColor=v.border,L.style.color=v.text,l.appendChild(L)}let f=document.getElementById("osd-sections");f.style.display=S.scenes.length>0?"block":"none",w(f);for(let m of S.scenes){let v=document.createElement("div");v.textContent=m.name,v.className="osd-section",v.style.left=`${m.start*100}%`,v.style.width=`${m.length*100}%`,f.appendChild(v)}}}}function we(){Ye(!0,vn())}function Ze(){Ye(!1,vn())}function hn(){Tn(!0)}function Sn(){Tn(!1)}function kr(){let e=[],t=document.getElementsByClassName("entry");for(let n of t){let r=n;r.style.display!=="none"&&e.push(r)}return e}function vn(){return e=>!0}function Hr(e){return t=>bn(t)==e}function Ye(e,t){let n=kr(),r=d.getPlayingGalleryElement();if(!r)return;let o=n.indexOf(r);if(!(o<0))for(let i=0;i!=n.length-1;++i){o=e?o<n.length-1?o+1:0:o>0?o-1:n.length-1;let a=n[o];if(!(a.getAttribute(F)||a.getAttribute(K))&&t(a)){Te(),d.play(a.id);break}}}function bn(e){let t=e.getAttribute(y)||"";if(t=="")return"";let n=t.indexOf("-");return n==-1?"":t.substr(0,n).trim().toLowerCase()}function Tn(e){let t=d.getPlayingGalleryElement();if(!t)return;let n=bn(t);n!=""&&Ye(e,Hr(n))}var Me=null,wn=!1;function Mn(){if(wn)return;let e=d.getVideoElement();e.addEventListener("play",()=>{Me=performance.now()/1e3}),e.addEventListener("pause",()=>{let t=d.getCurrentPlayingHash();t&&oe(t)}),e.addEventListener("ended",()=>{let t=d.getCurrentPlayingHash();t&&oe(t)}),wn=!0}function oe(e){if(Me===null)return;let n=performance.now()/1e3-Me;Me=null,!(n<=0)&&I(e,r=>(r.playbackSeconds=(r.playbackSeconds??0)+n,console.log(`Recording playback time, adding ${n} seconds for ${e}, total is now ${r.playbackSeconds}`),r))}var j,T,xe,Ie=0;function In(){return!!xe}function xn(){return xe||""}function Ur(e,t){for(let n of e)if(t>=n.start&&t<n.start+n.length)return n}function _r(e,t){return!(e.start+e.length<=t.start||t.start+t.length<=e.start)}function Nr(e,t){let n=[];for(let r of t)_r(e,r)||n.push(r);for(let r=0;r<n.length;r++)if(e.start<n[r].start)return n.splice(r,0,e),n;return n.push(e),n}function Rr(e){let t=d.getCurrentPlayingHash();if(!t)return;let n=e.currentTime/e.duration,r=g(t);return Ur(r.scenes,n)}function Pn(e,t){if(!t.paused){p("Pause video before marking start of scene",3e3);return}j=t.currentTime/t.duration,P(`Marked start of scene at ${M(t.currentTime)}`,3e3)}function An(e,t){if(!t.paused){p("Pause video before marking end of scene",3e3);return}if(j===void 0){p("Mark start of scene before marking end",3e3);return}if(t.currentTime/t.duration-j<=0){p("Scene end must be after the start",3e3);return}document.getElementById("name-scene-dialog").showModal()}function Je(){let e=d.getCurrentPlayingHash();if(j===void 0||!e)return!1;let t=d.getVideoElement(),n=j,r=t.currentTime/t.duration,o=r-n,a=document.getElementById("save-scene-name").value.trim();return a===""?(p("Scene name cannot be empty",2e3),!1):(I(e,s=>(s.scenes=Nr({start:n,length:o,name:a},s.scenes),s)),P(`Adding scene between ${M(n*t.duration)} and ${M(r*t.duration)}`,3e3),re(e),j=void 0,!0)}function Cn(e,t){T=Rr(t),T&&(t.currentTime=T.start*t.duration)}function Dn(e,t){let n=d.getCurrentPlayingHash();if(!n)return;let r=g(n);if(r.scenes.length===0)return;let o=a=>{xe=a.name,Ie&&clearTimeout(Ie),Ie=setTimeout(()=>{xe=void 0,Ie=0},500),t.currentTime=a.start*t.duration,t.paused&&!t.error&&t.play()},i=t.currentTime/t.duration;for(let a of r.scenes)if(a.start>i){o(a);return}o(r.scenes[0])}function Ln(e,t){if(T){let n=t*T.start,r=t*(T.start+T.length);(e<n||e>=r)&&(P("Exiting loop",1e3),T=void 0)}}function Fn(e){T&&e.currentTime/e.duration>=T.start+T.length&&(e.currentTime=T.start*e.duration)}var h=null;function Gr(){return h}function u(){return document.getElementById("video-player")}function Pe(){return document.getElementById("video-container")}function et(){return document.getElementById("gallery-container")}function $r(e){return e?.getAttribute(y)||""}function jr(e){Xe=null,h&&oe(h),h=e,u().pause(),_n(!1);let t=Se(e);t&&(zr(URL.createObjectURL(t.file)),re(e))}function tt(){return h?document.getElementById(h):null}function zr(e){let t=u();t.src&&(URL.revokeObjectURL(t.src),t.src=""),t.autoplay=!0,t.src=e}function Bn(){let e=U.get(D);if(e){let t=document.getElementById("shuffle-button");t.style.backgroundImage=e.icon,t.title=e.tooltip}}function On(){let e=document.getElementById("loop-button"),t=u();V?(e.classList.remove("disabled"),e.title="Loop single on",t.setAttribute("loop","")):(e.classList.add("disabled"),e.title="Loop single off",t.removeAttribute("loop"))}function nt(){return et().style.display!=="none"}function Kr(){if(u().src){qr();let t=tt();if(t&&"mediaSession"in navigator){let n=ve(t),r={title:$r(t),artist:"VideoQueen",artwork:[{src:n.src,sizes:`${n.naturalWidth}x${n.naturalHeight}`,type:"image/webp"}]};navigator.mediaSession.metadata=new MediaMetadata(r)}}}function Un(){let e=u();e.paused||e.pause(),et().style.display="block",Pe().style.display="none",document.getElementById("progress-container").style.display="",Te(),It()}function qr(){nt()&&(et().style.display="none",Pe().style.display="block",document.getElementById("progress-container").style.display="none",fe()),Mt()}function Wr(){let e=u();p(`Error playing video: ${e.error?e.error.message:""}`)}function Qr(){if(u().duration){if(In()){$({info:`Scene: ${xn()}`});return}$()}}function Zr(){let e=u();$({info:`Volume: ${Math.round(e.volume*100)}%`})}function Yr(){let e=u();$({info:`Speed: ${Math.round(e.playbackRate*100)}%`})}function Jr(){we()}async function kn(){if(document.fullscreenElement)document.exitFullscreen();else try{await Pe().requestFullscreen()}catch(e){console.log("fullscreen failed: ",e)}}function _n(e){let t=u(),n=!1;typeof e<"u"?n=e:n=t.style.objectFit!=="fill",t.style.objectFit=n?"fill":"contain"}function Hn(e,t){t.paused&&!t.error?t.play():t.pause()}var Xe=null,ie=0;function rt(e,t,n){n==1&&Ln(t,e.duration),e.currentTime=t}function A(e,t){let n=parseInt(e.key);Xe===n?(ie+=.01,ie>=1&&(ie=0)):ie=n/10,Xe=n,rt(t,t.duration*ie,1)}function Xr(e,t){if(!h)return;let n=g(h),r=t.duration*.5;typeof n.thumbnailTime=="number"&&(r=n.thumbnailTime),rt(t,r,1)}function z(e,t={}){return(n,r)=>{if(!t.pauseOnly||r.paused){let o=n.shiftKey&&t.shiftDelta?t.shiftDelta:e,i=r.currentTime;rt(r,Math.max(Math.min(i+o,r.duration),0),1)}}}function eo(e){let t=u(),n=t.currentTime/t.duration,r=M(t.currentTime),o=Math.round(n*100);be("osd-info2",`Time: ${r} (${o}%)`),Fn(t)}var to={Enter:kn,w:(e,t)=>{_n()},f:kn,t:fn,p:Ze,n:we,PageUp:Ze,PageDown:we,A:Sn,a:hn,"[":Pn,"]":An,L:Cn,s:Dn,0:A,1:A,2:A,3:A,4:A,5:A,6:A,7:A,8:A,9:A,j:z(-10),l:z(10),",":z(-1/30,{pauseOnly:!0}),".":z(1/30,{pauseOnly:!0}),ArrowLeft:z(-5,{shiftDelta:-30}),ArrowRight:z(5,{shiftDelta:30}),z:Xr," ":Hn,k:Hn,Escape:(e,t)=>{t.paused||t.pause(),Un()},"=":(e,t)=>{t.playbackRate=1},ArrowUp:(e,t)=>{t.volume=Math.min(t.volume+.1,1)},ArrowDown:(e,t)=>{t.volume=Math.max(t.volume-.1,0)},i:()=>{tt()&&$()},d:()=>{h&&I(h,e=>{let t="delete",r=e.tags.indexOf(t);return r==-1?(P(`Added '${t}' tag`,3e3),e.tags.push(t)):(P(`Removed '${t}' tag`,3e3),e.tags.splice(r,1)),e})}};function no(e){if(document.activeElement&&document.activeElement.tagName==="INPUT"||e.key==="w"&&e.ctrlKey)return;if(nt()){if(e.code==="Escape"){let n=u();n.paused&&n.src&&!n.error&&n.play(),e.preventDefault(),e.stopPropagation()}e.key==="k"&&e.ctrlKey&&(document.getElementById("search-entry").focus(),e.preventDefault(),e.stopPropagation()),e.key==="m"&&e.ctrlKey&&(Nn("shuffle"),e.preventDefault(),e.stopPropagation());return}let t=to[e.key];t&&(t(e,u()),e.preventDefault(),e.stopPropagation())}function ro(){on(!V),On(),pe()}function Nn(e){rn(e),Bn(),Ke(),pe()}function oo(){if(document.getElementById("sort-dropdown-content").classList.toggle("show-dropdown"),U.get(D)){let n=`arrange_${D}`,r=document.getElementById(n);r.checked=!0}}function io(e){if(!nt()){let t=u();t.volume=Math.max(Math.min(t.volume+e.deltaY/560,1),0)}}async function ao(e){e.preventDefault();let t=await yt();document.getElementById("settings-dialog").close(),t&&P("Metadata exported")}async function so(e){e.preventDefault();let t=await Et();document.getElementById("settings-dialog").close(),je(),t&&P("Metadata imported")}async function lo(){let e=mn(),t=await xt(e),n=await ht(e);P(`Removed ${t} unused previews and ${n} metadata entries`)}function co(){R()}function uo(e){if(!(e.target instanceof Element&&e.target.matches("#shuffle-button")))for(let t of document.getElementsByClassName("sort-dropdown-content"))t.classList.remove("show-dropdown")}function mo(e){let t=e.target,n=document.getElementById("top-gradient-mask"),r=document.getElementById("bottom-gradient-mask");t.scrollTop==0?n.style.opacity="0":n.style.opacity="1",t.scrollTop>=t.scrollHeight-t.offsetHeight-2?r.style.opacity="0":r.style.opacity="1"}function Rn(){if(_){let e=new CSSStyleSheet;e.replaceSync('.entry[data-dupe="true"] { display: none; }'),document.adoptedStyleSheets=[e]}else document.adoptedStyleSheets=[]}function fo(){let e=document.getElementById("settings-hide-dupes");e.checked=_,document.getElementById("settings-dialog").showModal()}function go(){let e=document.getElementById("settings-hide-dupes");e.checked!==_&&(an(e.checked),Rn()),pe()}function po(e){let t=document.getElementById(e.contentHash);t&&(qe(t,e),e.contentHash==h&&re(e.contentHash))}async function yo(){if("serviceWorker"in navigator)try{let e=await navigator.serviceWorker.register("service-worker.js",{scope:"./"});e.installing?console.log("Service worker installing"):e.waiting?console.log("Service worker installed"):e.active&&console.log("Service worker active")}catch(e){console.error(`Registration failed with ${e}`)}}globalThis.addEventListener("load",function(){globalThis.addEventListener("keydown",no,{capture:!0});let e=document.getElementById("search-entry");e.addEventListener("input",X),e.addEventListener("blur",R),e.addEventListener("change",zt),e.addEventListener("keydown",$t),e.addEventListener("focus",jt);let t=u();t.addEventListener("play",Kr,!1),t.addEventListener("error",Wr,!1),t.addEventListener("seeking",Qr,!1),t.addEventListener("volumechange",Zr,!1),t.addEventListener("ratechange",Yr,!1),t.addEventListener("ended",Jr,!1),t.addEventListener("timeupdate",eo,!1),document.addEventListener("dragover",function(n){n.dataTransfer&&(n.dataTransfer.dropEffect="none"),n.preventDefault()},!1),document.addEventListener("drop",function(n){n.preventDefault()},!1),document.addEventListener("wheel",io,!1),document.getElementById("gallery-view").addEventListener("scroll",mo),document.getElementById("loop-button").addEventListener("click",ro),document.getElementById("shuffle-button").addEventListener("click",oo),document.getElementById("clear-search").addEventListener("click",Kt),document.getElementById("settings").addEventListener("click",fo),document.getElementById("settings-confirm").addEventListener("click",go),document.getElementById("settings-export-tags").addEventListener("click",ao),document.getElementById("settings-import-tags").addEventListener("click",so),document.getElementById("settings-gc-previews").addEventListener("click",lo),document.getElementById("open-folder").addEventListener("click",ze),document.getElementById("initial-open-folder").addEventListener("click",ze),document.getElementById("save-scene-confirm").addEventListener("click",Je),document.getElementById("save-scene-name").addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),Je()&&document.getElementById("name-scene-dialog").close())}),U.forEach((n,r)=>{document.getElementById(`arrange_${r}`).addEventListener("click",()=>Nn(r))}),document.getElementById("toast-close").addEventListener("click",fe),globalThis.addEventListener("resize",co),globalThis.addEventListener("click",uo),globalThis.addEventListener("beforeunload",()=>{h&&oe(h)}),yo(),ft(po),vt({getPlayingGalleryElement:tt,play:jr,getCurrentPlayingHash:Gr,getVideoElement:u,getVideoContainer:Pe,showGallery:Un}),Mn(),at(gt),dt(n=>{n?pt().then(()=>{sn(()=>{un(),Bn(),On(),Rn(),je()})}):p("Error opening IndexedDB")})});})();
