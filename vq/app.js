(()=>{var ae=new BroadcastChannel("tagChannel"),Ne=new BroadcastChannel("savedQueryChannel");function qe(e,t){let n={hash:e,tagAdd:t};ae.postMessage(n)}function Ge(e,t){let n={hash:e,tagRemove:t};ae.postMessage(n)}function Qe(e){ae.addEventListener("message",e)}function Ve(e){Ne.postMessage({queries:e})}function je(e){Ne.addEventListener("message",e)}var f="data-name",S="data-bad-media",U="data-dupe",w="data-duration",_="data-quality",R="data-tag-count",b="data-file-size",ze="vqStorage";var nn=624,on=1e4;function ce(e,t,n){let o={};function r(){c.style.width=`${nn}px`,o.width=c.videoWidth,o.height=c.videoHeight,o.duration=c.duration}function i(p){if(T!==0&&(clearTimeout(T),T=0),c.removeEventListener("error",l,!1),c.removeEventListener("canplay",a,!1),c.removeEventListener("loadedmetadata",r,!1),c.src="",p&&(o.image=p,p.size<1200&&t.retries>0)){--t.retries,typeof t.specificTime=="number"&&(t.specificTime+=1/30),ce(e,t,n);return}n(o)}function s(){c.removeEventListener("seeked",s,!1),rn(c,i)}function a(){c.removeEventListener("canplay",a,!1),c.pause(),t.specificTime||(t.specificTime=c.duration/2),c.addEventListener("seeked",s),c.currentTime=t.specificTime}function l(){i(null)}let c=document.getElementById("generator");c.addEventListener("canplay",a,!1),c.addEventListener("loadedmetadata",r,!1),c.addEventListener("error",l,!1),c.src=e;let T=setTimeout(l,on);c.pause()}function rn(e,t){let n=document.getElementById("canvas"),o=e.offsetWidth,r=e.offsetHeight;n.width=o,n.height=r;let i=e.offsetWidth,s=e.offsetHeight,a=n.getContext("2d",{willReadFrequently:!0});if(!a){t(null);return}a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high",a.drawImage(e,0,0,i,s),n.toBlob(t,"image/webp",.5)}var q=null;function $e(e){console.log("storage init");let t=indexedDB.open(ze,3);t.onupgradeneeded=n=>{console.log(`onupgradeneeded old=${n.oldVersion} new=${n.newVersion}`);let o=t.result;switch(n.oldVersion){case 0:console.log("Creating new DB"),o.createObjectStore("tags",{});case 1:console.log("Upgrading to version 2"),o.createObjectStore("previews",{});case 2:console.log("Upgrading to version 3"),o.createObjectStore("misc",{})}},t.onerror=n=>{q=null,e(!1)},t.onsuccess=n=>{q=t.result,e(!0)}}function m(){if(!q)throw"DB not initialized";return q}var Q=0,B=0;function Ke(e,t){let n=document.getElementById("progress-container"),o=document.getElementById("progress");B==0&&(n.style.opacity="1"),Q+=t,B+=e,o.value=Q,o.max=B,Q>=B&&(n.style.opacity="0",B=0,Q=0)}function We(e,t){let o=m().transaction("previews").objectStore("previews").get(e);o.onsuccess=r=>{t(o.result)}}var x=[],de=!1;function Ze(e,t){ue(e,void 0,t)}function ue(e,t,n){Ke(1,0),x.push({file:e,specificTime:t,callback:n,processing:!1}),x.length==1&&fe()}function me(e,t){m().transaction("previews","readwrite").objectStore("previews").put(t,e)}function Ye(){de=!0}function Xe(){de=!1;let e=x[0];e&&!e.processing&&fe()}function fe(){if(de)return;let e=x[0];e&&(e.processing=!0,an(e.file,e.specificTime,t=>{x.shift(),e.callback(t),fe()}))}function an(e,t,n){let o=URL.createObjectURL(e);ce(o,{specificTime:t,retries:t===void 0?1:3},s=>{URL.revokeObjectURL(o),Ke(0,1),n(s)})}var V=0;function j(e,t=7e3){Je(e,"info",t)}function L(e,t=7e3){Je(e,"error",t)}function Je(e,t,n){let o=document.getElementById("toast");o.setAttribute("data-kind",t),o.style.pointerEvents="auto",o.style.opacity="1";let r=document.getElementById("toast-msg");r.textContent=e,V!==0&&(clearTimeout(V),V=0),V=setTimeout(z,n)}function z(){let e=document.getElementById("toast");e.style.pointerEvents="none",e.style.opacity="0"}function y(e){for(;e.hasChildNodes();)e.removeChild(e.lastChild)}function cn(e){return[...new Uint8Array(e)].map(t=>t.toString(16).padStart(2,"0")).join("")}async function tt(e){let n=null;if(e.size<3*1024)n=await e.arrayBuffer();else{n=new ArrayBuffer(3*1024+8);let o=new BigUint64Array(n);o[0]=BigInt(e.size);let r=Math.floor((e.size-1024)/2),i=e.slice(0,1024).arrayBuffer(),s=e.slice(r,r+1024).arrayBuffer(),a=e.slice(e.size-1024,e.size).arrayBuffer(),l=new Uint8Array(n);l.set(new Uint8Array(await i),8),l.set(new Uint8Array(await s),8+1024),l.set(new Uint8Array(await a),8+2*1024)}return cn(await crypto.subtle.digest("SHA-256",n))}function nt(e){let t=3735928559,n=1103547991;for(let o=0,r;o<e.length;o++)r=e.charCodeAt(o),t=Math.imul(t^r,2654435761),n=Math.imul(n^r,1597334677);return t=Math.imul(t^t>>>16,2246822507)^Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507)^Math.imul(t^t>>>13,3266489909),(n>>>0).toString(16).padStart(8,"0")+(t>>>0).toString(16).padStart(8,"0")}function ot(e){if(e<1024)return`${e.toFixed()} B`;let t=["kB","MB","GB","TB","PB"],n=-1;do e/=1024,++n;while(Math.round(Math.abs(e)*100)/100>=1024&&n<t.length-1);return`${e.toFixed(2)} ${t[n]}`}function pe(e,t,n){let o=n*(1-t/2);if(o==0||o==1)return[e,0,o];let r=(n-o)/Math.min(o,1-o);return[e,r,o]}function ye(e,t,n){return`hsl(${e} ${t*100}% ${n*100}%`}var rt={};function Ee(e){let t=rt[e];if(t)return t;let n=nt(e),o=(en,Re,tn)=>Re+en*(tn-Re),r=o(parseInt(n.substr(7,3),16)/4096*360,0,360),i=o(parseInt(n.substr(2,2),16)/255,.4,.8),s=o(parseInt(n.substr(4,2),16)/255,.2,.4),a=Math.min(i*.8,1),l=Math.min(s*3,1),c=Math.min(i*.8,1),T=Math.min(s*4,1),p={bkg:ye(...pe(r,i,s)),border:ye(...pe(r,a,l)),text:ye(...pe(r,c,T))};return rt[e]=p,p}var v={};function st(){v={}}function dn(e){v[e]=v[e]+1||1}function un(e){--v[e]==0&&delete v[e]}function he(e){let t=[];for(let n of Object.keys(v))n.startsWith(e)&&n!=e&&t.push(n);return t.sort((n,o)=>v[o]-v[n]),t}function Te(e,t){try{let o=m().transaction("tags").objectStore("tags").get(e);o.onsuccess=r=>{let i=o.result;i&&t(i.tags)}}catch(n){L(`Error loading tags: ${n}`)}}function at(e){Te(e.id,t=>{let n=e.querySelector(".tag-container");for(let o of t)M(n,o)})}function ve(e){let t=e?.parentElement?.parentElement;if(!t)throw"tagContainer without parent";return t.id}function $(e){let t=ve(e);if(t){let n=W(e),o=m().transaction("tags","readwrite").objectStore("tags");n.length>0?o.put({tags:n},t):o.delete(t)}}async function lt(){try{let e={types:[{description:"Exported tags",accept:{"application/json":[".json"]}}],suggestedName:"exported-tags.json"},n=await(await globalThis.showSaveFilePicker(e)).createWritable(),o={};for(let i of document.getElementsByClassName("entry")){let s=i.id,a=i.getAttribute(f);if(!s||!a)continue;let l=i.querySelector(".tag-container");if(!l)continue;let c=W(l);c.length!==0&&(o[s]={name:a,tags:c})}let r=new Blob([JSON.stringify(o)],{type:"application/json"});await n.write(r),await n.close()}catch(e){return console.log("errol:",e),!1}return!0}function mn(e){if(typeof e!="object"||e===null||!("name"in e&&typeof e.name=="string")||!("tags"in e&&Array.isArray(e.tags)))return!1;for(let t of e.tags)if(typeof t!="string")return!1;return!0}async function ct(e){try{let t={types:[{description:"Tags",accept:{"application/json":[".json"]}}],multiple:!1},[n]=await globalThis.showOpenFilePicker(t),r=await(await n.getFile()).arrayBuffer(),i=new Uint8Array(r),s=new TextDecoder("utf-8"),a=JSON.parse(s.decode(i)),c=m().transaction("tags","readwrite").objectStore("tags");for(let[T,p]of Object.entries(a))T.length===64&&mn(p)&&c.put({tags:p.tags},T);e()}catch(t){console.log("errol:",t)}}function K(e){return e.childNodes[0].textContent||""}function W(e){let t=[],n=e.children;for(let o=1;o<n.length;++o)t.push(K(n[o]));return t}function Se(e,t){let n=document.createElement("span");n.className="tag",n.textContent=e;let o=Ee(e);if(n.style.background=o.bkg,n.style.borderColor=o.border,n.style.color=o.text,n.addEventListener("click",r=>{r.stopPropagation()}),!t||!t.displayOnly){let r=document.createElement("span");r.className="tag-delete",r.textContent="x",r.addEventListener("click",gn),n.appendChild(r)}return n}function dt(e){return e.trim().toLowerCase()}function be(e,t){t=dt(t);let n=e.children;for(let o=1;o<n.length;++o)if(t===K(n[o]))return!0;return!1}function M(e,t){dn(t),e.appendChild(Se(t)),Ie(e)}function it(e,t){let n=dt(t||"");if(n===""||be(e,n))return;M(e,n),$(e);let o=ve(e);qe(o,n)}function fn(e){let t=e.currentTarget;if(!t.classList.contains("tag-add"))return;let n=t.parentElement;if(!n)throw"event on unparented tagContainer";switch(e.key){case"Escape":t.textContent="+",t.blur();break;case"Tab":t.textContent==""||t.textContent=="+"?(t.textContent="+",t.blur()):(it(n,t.textContent),t.textContent="",setTimeout(()=>{t.focus()},0)),e.preventDefault();break;case"Enter":it(n,t.textContent),t.textContent="+",t.blur();break}e.stopPropagation()}function ut(){let e=document.createElement("span");e.className="tag-add",e.textContent="+",e.contentEditable="true",e.setAttribute("spellcheck","false"),e.setAttribute("tabindex","-1"),e.addEventListener("click",n=>{e.textContent="",n.stopPropagation()}),e.addEventListener("focusout",n=>{e.textContent="+"}),e.addEventListener("keydown",fn);let t=document.createElement("div");return t.className="tag-container",t.appendChild(e),Ie(t),t}function Ie(e){let t=e.querySelectorAll(".tag").length,n=e?.parentElement?.parentElement;n&&n.setAttribute(R,`${t}`)}function Z(e,t){un(t);for(let n of e.children)if(t===K(n)){e.removeChild(n),Ie(e);break}}function gn(e){if(!e.currentTarget)return;e.stopPropagation();let n=e.currentTarget.parentElement;if(!n)return;let o=K(n),r=n.parentElement;if(!r)throw"unparented tagDelete";Z(r,o),$(r);let i=ve(r);Ge(i,o)}function mt(e){let t=document.getElementById(e.data.hash);if(t){let n=t.querySelector(".tag-container");if(!n)return;e.data.tagAdd&&M(n,e.data.tagAdd),e.data.tagRemove&&Z(n,e.data.tagRemove)}}function E(){return document.getElementById("search-entry")}function gt(e){let t=document.getElementsByClassName("entry");if(e){let n=In(e);for(let o of t){let r=o;vn(r,n)?r.style.display="":r.style.display="none"}}else for(let n of t){let o=n;o.getAttribute(S)||(o.style.display="")}}function pn(e){return Number.parseInt(e.getAttribute(w)||"0")}function yn(e){return Number.parseInt(e.getAttribute(_)||"0")}function En(e){return Number.parseInt(e.getAttribute(R)||"0")}function hn(e){return Number.parseInt(e.getAttribute(b)||"0")/(1024*1024)}function Tn(e){return Number.parseInt(e.getAttribute(b)||"0")/(1024*1024*1024)}function vn(e,t){if(e.getAttribute(S))return!1;for(let o of t.scalarMatchers)if(!o(e))return!1;if((e.getAttribute(f)||"").toLowerCase().indexOf(t.freetext)===-1)return!1;if(t.includeTags.length||t.excludeTags.length){let o=e.querySelector(".tag-container"),r=o?W(o):[];for(let i of t.includeTags)if(r.indexOf(i)===-1)return!1;for(let i of t.excludeTags)if(r.indexOf(i)!==-1)return!1}return!0}function Sn(e){let t=e.match(/^(>=|>|=|<|<=)([0-9]+)([ptmg]?)$/);if(!t)return;let n=pn;t[3]=="p"?n=yn:t[3]=="t"?n=En:t[3]=="m"?n=hn:t[3]=="g"&&(n=Tn);let o=Number.parseInt(t[2]);switch(t[1]){case">=":return r=>n(r)>=o;case">":return r=>n(r)>o;case"=":return r=>n(r)==o;case"<":return r=>n(r)<o;case"<=":return r=>n(r)<=o}}function bn(e,t){let n=Sn(e);return n?(t.scalarMatchers.push(n),!0):!1}function In(e){let t={freetext:"",includeTags:[],excludeTags:[],scalarMatchers:[]},n=e.slice(-1);(n=="+"||n=="-")&&(e=e.slice(0,-1));let o=[];for(let r of e.trim().toLowerCase().split(" "))r[0]=="+"&&r.length>=2?t.includeTags.push(r.substring(1)):r[0]=="-"&&r.length>=2?t.excludeTags.push(r.substring(1)):bn(r,t)||o.push(r);return t.freetext=o.join(" "),t}function pt(e,t){let n=t;if(n==e.length||e[n]==" "){for(;n--&&e[n]!=" ";)if((e[n]=="+"||e[n]=="-")&&(n==0||e[n-1]==" "))return e.substring(n+1,t)}}function Y(){let e=E();gt(e.value.trim().toLowerCase()),vt(),St()}function yt(){let e=E(),t=document.getElementById("completion");if(y(t),e.selectionStart!=e.selectionEnd){C();return}let n=!1,o=pt(e.value,e.selectionStart||0);if(o!==void 0){let r=he(o);if(r.length>0){n=!0;for(let i of r)t.appendChild(Se(i,{displayOnly:!0}));Ln()}}n||C()}function Et(e){if(e.key==="Tab"){let t=E();if(t.selectionStart==t.selectionEnd){let n=t.selectionStart||0,o=pt(t.value,n);if(o!==void 0){let r=he(o);if(r.length===1){let i=r[0].substring(o.length)+" ";t.setRangeText(i);let s=n+i.length;t.setSelectionRange(s,s),Y(),e.preventDefault(),C()}}}}else setTimeout(yt,0)}function ht(e){yt()}function Tt(e){let t=E();vt(),St(),gt(t.value.trim().toLowerCase())}function vt(){let e=E(),t=document.getElementById("clear-search");t.style.visibility=e.value.length===0?"hidden":"visible"}function St(){let e=E(),t=document.getElementById("save-search");e.value.length===0?t.setAttribute("disabled",""):t.removeAttribute("disabled")}function bt(){Dt("")}function wn(e,t){let n=e.id+"--mirror",o=document.getElementById(n);if(!o){o=document.createElement("div"),o.id=n;let i=getComputedStyle(e),s=o.style;s.position="absolute",s.visibility="hidden",s.overflow="hidden",s.width=i.width,s.height=i.height,s.paddingTop=i.paddingTop,s.paddingRight=i.paddingRight,s.paddingBottom=i.paddingBottom,s.paddingLeft=i.paddingLeft,s.fontFamily=i.fontFamily,s.fontStyle=i.fontStyle,s.fontVariant=i.fontVariant,s.fontWeight=i.fontWeight,s.fontSize=i.fontSize,s.textAlign=i.textAlign,document.body.appendChild(o)}o.textContent=e.value.substring(0,t).replace(/\s/g,"\xA0");let r=document.createElement("span");return r.textContent=".",o.appendChild(r),r.offsetLeft}function Ln(){let e=E(),t=document.getElementById("completion"),n=wn(e,e.selectionStart||0),o=-e.scrollLeft+n+10,r=e.offsetWidth-o-10;t.style.left=`${e.offsetLeft+o}px`,t.style.top=`${e.offsetTop+4}px`,t.style.width=`${r}px`,t.style.display="block"}function C(){let e=document.getElementById("completion");e.style.display="none",y(e)}function It(){let e=document.getElementById("save-query-name");e.value="";let t=document.getElementById("save-query-query");t.value=E().value.trim(),document.getElementById("save-query-dialog").showModal()}function we(){let e=document.getElementById("save-query-name"),t=document.getElementById("save-query-query"),n=e.value.trim(),o=t.value.trim();n!==""&&o!==""&&(Ce(n,o),Le())}var wt="storedQueries";function Lt(){let t=m().transaction("misc").objectStore("misc").get(wt);t.onsuccess=n=>{let o=t.result||[];for(let r of o)Ce(r.name,r.search)}}function Le(){let e=[],t=document.getElementById("saved-searches");for(let r of t.children){let i=r.getAttribute(f),s=r.getAttribute("data-search");!i||!s||e.push({name:i,search:s})}m().transaction("misc","readwrite").objectStore("misc").put(e,wt),Ve(e)}function Ct(e){e.key==="Enter"&&we()}function Dt(e){let t=E();t.value=e,t.dispatchEvent(new Event("change"))}function Cn(e){e.dataTransfer&&(e.dataTransfer.effectAllowed="move")}function Dn(e,t){let n=document.elementFromPoint(e,t);if(n){if(n.classList.contains("ss"))return n;if(n.classList.contains("ss-del")||n.classList.contains("ss-name"))return n.parentElement}return null}function Hn(e){let t=e.target;if(!t)return;let n=t.parentElement,o=Dn(e.clientX,e.clientY);if(o&&o.parentElement===n){if(o!==t){let r=o.offsetHeight;e.clientY>o.offsetTop+r/2?n.insertBefore(t,o.nextSibling):n.insertBefore(t,o)}}else{let r=n.getBoundingClientRect();e.clientX>=r.left&&e.clientX<r.right&&(e.clientY<r.top&&t!==n.firstChild?n.insertBefore(t,n.firstChild):e.clientY>=r.bottom&&t!==n.lastChild&&n.appendChild(t))}e.preventDefault(),e.stopPropagation()}function Bn(e){e.dataTransfer&&(e.dataTransfer.effectAllowed="move"),e.preventDefault(),e.stopPropagation()}function xn(e){Le(),e.preventDefault(),e.stopPropagation()}function Ce(e,t){let n=document.createElement("div");n.className="ss",n.setAttribute(f,e),n.setAttribute("data-search",t),n.setAttribute("draggable","true"),n.addEventListener("dragstart",Cn),n.addEventListener("drag",Hn),n.addEventListener("dragover",Bn),n.addEventListener("dragend",xn);let o=document.createElement("button");o.className="ss-del",o.setAttribute("tabindex","-1"),o.title="Delete query",o.addEventListener("click",()=>{i.removeChild(n),Le()}),n.appendChild(o);let r=document.createElement("span");r.className="ss-name",r.textContent=e,r.title=t,r.addEventListener("click",()=>{Dt(t)}),n.appendChild(r);let i=document.getElementById("saved-searches");i.appendChild(n)}function Ht(e){let t=document.getElementById("saved-searches");y(t);for(let n of e.data.queries)Ce(n.name,n.search)}var X=class{constructor(t){this.current=0;this.q=[];this.maxConcurrency=t}run(t){this.q.push(t),this.tryRun()}tryRun(){if(this.current<this.maxConcurrency){let t=this.q.shift();t!==void 0&&(this.current++,t().then(()=>{this.current--,this.tryRun()}))}}};var Pt=["avi","m4v","mkv","mov","mp4","mpeg","mpeg4","ogg","ogv","webm","wmv"];function Fn(e){let t=e.substr(e.lastIndexOf(".")+1).toLowerCase();return Pt.indexOf(t)>=0}var Bt=["shuffle","by_name","by_file_size","by_duration"],Ut="settings",d={sortMode:"by_name",loopSingle:!1,hideDupes:!1,previewOnHover:!1},O=null;function kn(e){let t=0;return typeof e=="string"&&(t=Math.max(0,Bt.indexOf(e))),Bt[t]}function On(e){let n=m().transaction("misc").objectStore("misc").get(Ut);n.onsuccess=o=>{let r=n.result;r&&(d.sortMode=kn(r.sortMode),d.loopSingle=!!r.loopSingle,d.hideDupes=!!r.hideDupes,d.previewOnHover=!!r.previewOnHover),e()},n.onerror=()=>{L("Error loading preferences"),e()}}function Fe(){let t=m().transaction("misc","readwrite").objectStore("misc"),n={loopSingle:d.loopSingle,sortMode:d.sortMode,hideDupes:d.hideDupes,previewOnHover:d.previewOnHover};t.put(n,Ut).onsuccess=()=>{console.log("settings saved",n)}}function u(){return document.getElementById("video-player")}function re(){return document.getElementById("video-container")}function ke(){return document.getElementById("entries")}function Oe(){return document.getElementById("gallery-container")}function _t(e){return e?.getAttribute(f)||""}function Pe(e){return e.querySelector(".entry-image")}function Rt(e){qt(),xe=null,O=e,u().pause(),ie(e,t=>{Pn(URL.createObjectURL(t)),Zn(e)})}function P(){return O?document.getElementById(O):null}function ie(e,t){let n=H[e];if(n){t(n);return}}function Pn(e){let t=u();t.src&&(URL.revokeObjectURL(t.src),t.src=""),t.autoplay=!0,t.src=e}function Un(e){let t=e.lastIndexOf(".");if(t==-1)return e;let n=e.substr(t+1).toLowerCase();return Pt.indexOf(n)==-1?e:e.substr(0,t)}function Nt(e){return e.getElementsByTagName("img")[0]}var h=null,I=0,He=3;function _n(e){if(e<30)return 4;if(e>3600)return 15;let i=(e-30)/(3600-30);return Math.floor(Math.sqrt(i)*(15-4)+4)}function Rn(e,t){let n=_n(e);if(n*(t+3)>e)return[];let r=e/n,i=[],s=r;for(let a=1;a<n;++a)i.push(s),s+=r;return i}function qt(){if(h){Nt(h).style.display="";for(let e of h.getElementsByTagName("video")){let t=e.src;e.pause(),e.src="",e.remove(),URL.revokeObjectURL(t)}I&&(clearTimeout(I),I=0),h=null}}var oe=[],ee=0;function Gt(){if(I=0,h){let e=h.getElementsByTagName("video");if(e.length!=1)return;let t=e[0];t.currentTime=oe[ee],I=setTimeout(Gt,He*1e3),++ee==oe.length&&(ee=0)}}function Nn(e){if(h||I||!e.parentElement)return;h=e;let t=e.parentElement.id,n=Nt(e),o=Math.floor(n.offsetHeight);t&&ie(t,r=>{let i=URL.createObjectURL(r);if(h!=e){URL.revokeObjectURL(i);return}let s=document.createElement("video");s.style.height=`${o}px`,s.style.display="none",s.muted=!0,s.autoplay=!0,s.loop=!0,e.appendChild(s),s.src=i,s.addEventListener("loadedmetadata",()=>{n.style.display="none",s.style.display="",ee=0,oe=Rn(s.duration,He),oe.length>0&&(I=setTimeout(Gt,He*1e3))},!1)})}var Be=null,te=0;function qn(e){d.previewOnHover&&(Be=e.target,te=setTimeout(()=>{Be==e.target&&Nn(e.target)},500))}function Gn(e){Be=null,te!==0&&(clearTimeout(te),te=0),qt()}function Qn(e){let t=Un(e),n=document.createElement("div");n.className="entry",n.addEventListener("click",Yn),n.setAttribute(f,t);let o=document.createElement("div");o.className="entry-preview",o.addEventListener("mouseenter",qn),o.addEventListener("mouseleave",Gn);let r=document.createElement("img");r.className="entry-image",o.appendChild(r),o.appendChild(ut());let i=document.createElement("div");i.className="duration-badge",o.appendChild(i);let s=document.createElement("div");s.className="quality-badge",o.appendChild(s);let a=document.createElement("div");a.className="file-size-badge",o.appendChild(a),n.appendChild(o);let l=document.createElement("div");return l.className="entry-title",l.textContent=t,n.appendChild(l),n}function Vn(){let e=ke(),t=[...e.children];for(let n=t.length-1;n>0;n--){let o=Math.floor(Math.random()*(n+1));[t[n],t[o]]=[t[o],t[n]]}t.forEach(n=>{e.appendChild(n)})}var jn=(e,t)=>{let n=e.getAttribute(f)||"",o=t.getAttribute(f)||"";return n.localeCompare(o)},zn=(e,t)=>{let n=Number.parseInt(e.getAttribute(b)||"0")||0,o=Number.parseInt(t.getAttribute(b)||"0")||0;return n-o},$n=(e,t)=>{let n=Number.parseFloat(e.getAttribute(w)||"0")||0,o=Number.parseFloat(t.getAttribute(w)||"0")||0;return n-o};function De(e){let t=ke(),n=[...t.children];n.sort(e),n.forEach(o=>{t.appendChild(o)})}var Ue={shuffle:{icon:"url(./assets/shuffle-icon.svg)",tooltip:"Shuffle",radio:"arrange-shuffle",func:()=>{Vn()}},by_name:{icon:"url(./assets/sort-icon.svg)",tooltip:"Sort by name",radio:"arrange-sort-az",func:()=>{De(jn)}},by_file_size:{icon:"url(./assets/sort-by-size.svg)",tooltip:"Sort by size",radio:"arrange-sort-size",func:()=>{De(zn)}},by_duration:{icon:"url(./assets/sort-by-duration.svg)",tooltip:"Sort by duration",radio:"arrange-sort-duration",func:()=>{De($n)}}};function Qt(){Ue[d.sortMode].func()}function Vt(){let e=document.getElementById("shuffle-button"),t=Ue[d.sortMode];e.style.backgroundImage=t.icon,e.title=t.tooltip}function jt(){let e=document.getElementById("loop-button"),t=u();d.loopSingle?(e.classList.remove("disabled"),e.title="Loop single on",t.setAttribute("loop","")):(e.classList.add("disabled"),e.title="Loop single off",t.removeAttribute("loop"))}function _e(){return Oe().style.display!=="none"}var A=0,Kn=4e3,F=0,Wn=2e3;function se(e){if(e&&e.info){xt();let n=document.getElementById("osd-info"),o=document.createElement("span");o.textContent=e.info,n.appendChild(o),F&&(clearTimeout(F),F=0),F=setTimeout(()=>{xt(),F=0},Wn)}let t=document.getElementById("osd-container");t.style.opacity="1.0",A&&(clearTimeout(A),A=0),A=setTimeout(()=>{t.style.opacity="0",A=0},Kn)}function xt(){let e=document.getElementById("osd-info");y(e)}function zt(){let e=document.getElementById("osd-container");e.style.opacity="0"}function Zn(e){let t=document.getElementById(e);if(t){let n=document.getElementById("osd-title");y(n);let o=document.createElement("span");o.textContent=_t(t),n.appendChild(o);let r=document.getElementById("osd-tags");y(r),Te(e,i=>{for(let s of i){let a=Ee(s),l=document.createElement("span");l.textContent=s,l.className="tag",l.style.background=a.bkg,l.style.borderColor=a.border,l.style.color=a.text,r.appendChild(l)}})}}async function Yn(e){if(!e.currentTarget)return;e.preventDefault(),e.stopPropagation();let t=e.currentTarget;if(t.getAttribute(S))return;let n=u();if(t==P())try{await n.play()}catch(o){console.log("Error playing video",o),Kt()}else re().style.background="",Rt(t.id)}function Xn(){if(u().src){Jn();let t=P();if(t&&"mediaSession"in navigator){let n=Pe(t),o={title:_t(t),artist:"VideoQueen",artwork:[{src:n.src,sizes:`${n.naturalWidth}x${n.naturalHeight}`,type:"image/webp"}]};navigator.mediaSession.metadata=new MediaMetadata(o)}}}function $t(){let e=u();e.paused||e.pause(),Oe().style.display="block",document.getElementById("sidebar").style.display="block",re().style.display="none",document.getElementById("progress-container").style.display="",zt(),Xe()}function Jn(){_e()&&(Oe().style.display="none",document.getElementById("sidebar").style.display="none",re().style.display="block",document.getElementById("progress-container").style.display="none",z()),Ye()}function Kt(){let e=u();L(`Error playing video: ${e.error?e.error.message:""}`)}function Mt(e,t){return String(e).padStart(t,"0")}function Wt(e){e=Math.floor(e);let t=Math.floor(e/3600),n=Math.floor(e%3600/60),o=e%60,r=Mt(o,2);if(t){let i=Mt(n,2);return`${t}:${i}:${r}`}return`${n}:${r}`}function eo(){let e=u();if(e.duration){let t=Wt(e.currentTime),n=Math.round(e.currentTime/e.duration*100);se({info:`Time: ${t} (${n}%)`})}}function to(){let e=u();se({info:`Volume: ${Math.round(e.volume*100)}%`})}function no(){let e=u();se({info:`Speed: ${Math.round(e.playbackRate*100)}%`})}function oo(){Me()}function ro(){let e=u();if(e.src&&e.paused&&O){let t=e.currentTime,n=O;$t();let o=document.getElementById(n);if(!o)return;ie(n,function(r){ue(r,t,i=>{if(i.image){let a=Pe(o).src;Ae(o,i),URL.revokeObjectURL(a),me(n,i)}})})}}async function At(){if(document.fullscreenElement)document.exitFullscreen();else try{await re().requestFullscreen()}catch(e){console.log("fullscreen failed: ",e)}}function Ft(e,t){t.paused&&!t.error?t.play():t.pause()}var xe=null,k=0;function g(e,t){let n=parseInt(e.key);xe===n?(k+=.01,k>=1&&(k=0)):k=n/10,xe=n,t.currentTime=t.duration*k}function D(e,t={}){return(n,o)=>{if(!t.pauseOnly||o.paused){let r=n.shiftKey&&t.shiftDelta?t.shiftDelta:e,i=o.currentTime;o.currentTime=Math.max(Math.min(i+r,o.duration),0)}}}var io={Enter:At,f:At,t:ro,p:kt,n:Me,PageUp:kt,PageDown:Me,0:g,1:g,2:g,3:g,4:g,5:g,6:g,7:g,8:g,9:g,j:D(-10),l:D(10),",":D(-1/30,{pauseOnly:!0}),".":D(1/30,{pauseOnly:!0}),ArrowLeft:D(-5,{shiftDelta:-30}),ArrowRight:D(5,{shiftDelta:30})," ":Ft,k:Ft,Escape:(e,t)=>{t.paused||t.pause(),$t()},"[":(e,t)=>{t.playbackRate>.1&&(t.playbackRate-=.05)},"]":(e,t)=>{t.playbackRate<10&&(t.playbackRate+=.05)},"=":(e,t)=>{t.playbackRate=1},ArrowUp:(e,t)=>{t.volume=Math.min(t.volume+.1,1)},ArrowDown:(e,t)=>{t.volume=Math.max(t.volume-.1,0)},i:()=>{P()&&se()},d:()=>{let e=P();if(e){let t=e.querySelector(".tag-container");if(t){let n="delete";be(t,n)?(j(`Removed '${n}' tag`,3e3),Z(t,n)):(j(`Added '${n}' tag`,3e3),M(t,n)),$(t)}}}};function so(e){if(document.activeElement&&document.activeElement.tagName==="INPUT")return;if(_e()){if(e.code==="Escape"){let n=u();n.paused&&n.src&&!n.error&&n.play(),e.preventDefault(),e.stopPropagation()}e.key==="k"&&e.ctrlKey&&(document.getElementById("search-entry").focus(),e.preventDefault(),e.stopPropagation());return}let t=io[e.key];t&&(t(e,u()),e.preventDefault(),e.stopPropagation())}function ao(){d.loopSingle=!d.loopSingle,jt(),Fe()}function J(e){d.sortMode=e,Vt(),Qt(),Fe()}function lo(){let e=document.getElementById("sort-dropdown-content");console.log("got dropdown",e),e.classList.toggle("show-dropdown");let t=Ue[d.sortMode],n=document.getElementById(t.radio);n.checked=!0}function co(e){if(!_e()){let t=u();t.volume=Math.max(Math.min(t.volume+e.deltaY/560,1),0)}}function uo(){let e=[],t=document.getElementsByClassName("entry");for(let n of t){let o=n;o.style.display!=="none"&&e.push(o)}return e}function Zt(e){let t=uo(),n=P();if(!n)return;let o=t.indexOf(n);if(!(o<0))for(let r=0;r!=t.length-1;++r){o=e?o<t.length-1?o+1:0:o>0?o-1:t.length-1;let i=t[o];if(!i.getAttribute(S)&&!i.getAttribute(U)){zt(),Rt(i.id);break}}}function Me(){Zt(!0)}function kt(){Zt(!1)}function Ae(e,t){let n=Pe(e),o=Object.keys(H).length;if(ne<o&&(ne++,ne==o&&fo()),t.unsupported)e.setAttribute(S,"true"),e.style.display="none";else{let r=e.querySelector(".duration-badge");r.textContent=Wt(t.duration),e.setAttribute(w,`${t.duration}`),e.setAttribute(_,`${t.height}`);let i=e.querySelector(".quality-badge");i.textContent=`${t.width}x${t.height}`,n.src=URL.createObjectURL(t.image)}}function mo(e,t){We(e,n=>{if(n){Ae(t,n);return}ie(e,o=>{Ze(o,r=>{r.image||(r={unsupported:!0}),Ae(t,r),me(e,r)})})})}var H={},ne=0;async function Yt(e){document.getElementById("initial-view").style.display="none",st(),H={},ne=0;for(let o of document.getElementsByClassName("entry-image")){let r=o;URL.revokeObjectURL(r.src)}let t=ke();y(t);let n=new X(64);for(let o of e){if(!Fn(o.name))continue;let r=Qn(o.name);t.appendChild(r),n.run(()=>tt(o).then(i=>{if(document.getElementById(i)){let a=r.querySelector(".entry-preview");if(a){a.setAttribute(U,"true"),r.setAttribute(U,"true");let c=document.createElement("div");c.className="dupe-badge",c.textContent=`Dupe of ${H[i].name}`,a.append(c)}let l=r.querySelector(".tag-container");l&&l.remove()}else{r.setAttribute("id",i),r.setAttribute(b,`${o.size}`);let a=r.querySelector(".file-size-badge");a.textContent=ot(o.size),at(r),H[i]=o}mo(i,r)}))}}function fo(){Qt(),Y()}function Xt(){let e=Object.values(H);e.length>0&&Yt(e)}async function go(e){e.preventDefault();let t=await lt();document.getElementById("settings-dialog").close(),t&&j("Tags exported")}function po(e){e.preventDefault(),ct(Xt)}function yo(){C()}function Eo(e){if(!(e.target instanceof Element&&e.target.matches("#shuffle-button")))for(let t of document.getElementsByClassName("sort-dropdown-content"))t.classList.remove("show-dropdown")}function ho(e){let t=e.target,n=document.getElementById("top-gradient-mask"),o=document.getElementById("bottom-gradient-mask");t.scrollTop==0?n.style.opacity="0":n.style.opacity="1",t.scrollTop>=t.scrollHeight-t.offsetHeight-2?o.style.opacity="0":o.style.opacity="1"}async function Ot(e){let t={id:"boop",mode:"read",startIn:"videos"};try{let n=await globalThis.showDirectoryPicker(t),o=[],r=async s=>{for await(let[a,l]of s.entries())l.kind==="file"?o.push(l.getFile()):l.kind==="directory"&&await r(l)};await r(n);let i=await Promise.all(o);Yt(i)}catch(n){console.log("errol: ",n)}}function To(){let e=document.getElementById("sidebar");e.setAttribute("data-flash","true"),setTimeout(()=>{e.removeAttribute("data-flash")},500),we()}function Jt(){if(d.hideDupes){let e=new CSSStyleSheet;e.replaceSync('.entry[data-dupe="true"] { display: none; }'),document.adoptedStyleSheets=[e]}else document.adoptedStyleSheets=[]}function vo(){let e=document.getElementById("settings-hide-dupes");e.checked=d.hideDupes;let t=document.getElementById("settings-preview-video");t.checked=d.previewOnHover,document.getElementById("settings-dialog").showModal()}function So(){let e=document.getElementById("settings-hide-dupes");e.checked!==d.hideDupes&&(d.hideDupes=e.checked,Jt());let t=document.getElementById("settings-preview-video");d.previewOnHover=t.checked,Fe()}async function bo(){if("serviceWorker"in navigator)try{let e=await navigator.serviceWorker.register("service-worker.js",{scope:"./"});e.installing?console.log("Service worker installing"):e.waiting?console.log("Service worker installed"):e.active&&console.log("Service worker active")}catch(e){console.error(`Registration failed with ${e}`)}}globalThis.addEventListener("load",function(){globalThis.addEventListener("keydown",so,{capture:!0});let e=document.getElementById("search-entry");e.addEventListener("input",Y),e.addEventListener("blur",C),e.addEventListener("change",Tt),e.addEventListener("keydown",Et),e.addEventListener("focus",ht);let t=u();if(t.addEventListener("play",Xn,!1),t.addEventListener("error",Kt,!1),t.addEventListener("seeking",eo,!1),t.addEventListener("volumechange",to,!1),t.addEventListener("ratechange",no,!1),t.addEventListener("ended",oo,!1),document.addEventListener("dragover",function(n){n.dataTransfer&&(n.dataTransfer.dropEffect="none"),n.preventDefault()},!1),document.addEventListener("drop",function(n){n.preventDefault()},!1),document.addEventListener("wheel",co,!1),document.getElementById("gallery-view").addEventListener("scroll",ho),document.getElementById("save-query-dialog").addEventListener("keydown",Ct),document.getElementById("loop-button").addEventListener("click",ao),document.getElementById("shuffle-button").addEventListener("click",lo),document.getElementById("clear-search").addEventListener("click",bt),document.getElementById("save-search").addEventListener("click",It),document.getElementById("save-query-confirm").addEventListener("click",To),document.getElementById("saved-searches").addEventListener("dragover",n=>{n.preventDefault(),n.stopPropagation()}),document.getElementById("settings").addEventListener("click",vo),document.getElementById("settings-confirm").addEventListener("click",So),document.getElementById("settings-export-tags").addEventListener("click",go),document.getElementById("settings-import-tags").addEventListener("click",po),document.getElementById("open-folder").addEventListener("click",Ot),document.getElementById("initial-open-folder").addEventListener("click",Ot),document.getElementById("arrange-shuffle").addEventListener("click",()=>J("shuffle")),document.getElementById("arrange-sort-az").addEventListener("click",()=>J("by_name")),document.getElementById("arrange-sort-size").addEventListener("click",()=>J("by_file_size")),document.getElementById("arrange-sort-duration").addEventListener("click",()=>J("by_duration")),document.getElementById("toast-close").addEventListener("click",z),globalThis.addEventListener("resize",yo),globalThis.addEventListener("click",Eo),bo(),Qe(mt),je(Ht),"windowControlsOverlay"in navigator){let n=()=>{let o=navigator.windowControlsOverlay.visible,r=document.getElementById("pwa-flair");r.style.visibility=o?"visible":"hidden"};n(),navigator.windowControlsOverlay.addEventListener("geometrychange",n)}$e(n=>{n?(Lt(),On(()=>{Vt(),jt(),Jt(),Xt()})):L("Error opening IndexedDB")})});})();
