"use strict";(()=>{var Qe=new BroadcastChannel("metadataChannel");function Ze(e){Qe.postMessage(e)}function Ye(e){Qe.addEventListener("message",e)}var T="data-name",H="data-bad-media",J="data-dupe",v="data-file-size",X="data-file-dir",Xe="vqStorage";var R=null,et=[];function tt(e){console.log("storage init");let t=indexedDB.open(Xe,4);t.onupgradeneeded=async n=>{console.log(`onupgradeneeded old=${n.oldVersion} new=${n.newVersion}`);let o=t.result;switch(n.oldVersion){case 0:console.log("Creating new DB"),o.createObjectStore("tags",{});case 1:console.log("Upgrading to version 2"),o.createObjectStore("previews",{});case 2:console.log("Upgrading to version 3"),o.createObjectStore("misc",{});case 3:console.log("Upgrading to version 4"),o.createObjectStore("metadata",{}),et.push(gn)}},t.onerror=n=>{R=null,e(!1)},t.onsuccess=async n=>{R=t.result;for(let o of et)console.log("Running upgrade function"),await o(R);e(!0)}}function b(){if(!R)throw"DB not initialized";return R}async function gn(e){return new Promise((t,n)=>{let o=e.transaction(["tags","metadata"],"readwrite"),r=o.objectStore("tags").openCursor(),i=o.objectStore("metadata"),a=[];r.onsuccess=async c=>{let s=r.result;if(s){let l={contentHash:s.key,tags:s.value.tags};a.push(new Promise((u,p)=>{let g=i.put({metadata:l},s.key);g.onsuccess=()=>u(),g.onerror=p})),s.continue()}else await Promise.all(a),t()},r.onerror=c=>{n(new Error("Could not open tags cursor"))}})}async function te(e,t){return new Promise((n,o)=>{let a=b().transaction(e,"readwrite").objectStore(e).openCursor(),c=0;a.onerror=()=>{o()},a.onsuccess=()=>{let s=a.result;s?(t.has(s.key)||(s.delete(),c++),s.continue()):n(c)}})}var Me=new Map,nt=1;function ot(e){Me.set(nt,e),nt++}var k=new Map;function E(e){let t=k.get(e)||{contentHash:e,tags:[],scenes:[]};return t.scenes=t.scenes||[],t.tags=t.tags||[],t}function rt(e){let t=e.data.md;k.set(t.contentHash,t),Me.forEach(n=>{n(t)})}function pn(e,t){it(e,t),Me.forEach(n=>{n(t)}),Ze({md:t})}function it(e,t){k.set(e,t),b().transaction("metadata","readwrite").objectStore("metadata").put({metadata:t},e)}function at(){return new Promise((e,t)=>{let o=b().transaction("metadata","readonly").objectStore("metadata").getAll();o.onerror=r=>{t(new Error("Failed to initialize metadata"))},o.onsuccess=r=>{for(let i of o.result)k.set(i.metadata.contentHash,i.metadata);e()}})}function B(e,t){let n=structuredClone(E(e)),o=t(n);o!==void 0&&pn(e,o)}async function st(){try{let e={types:[{description:"Exported tags",accept:{"application/json":[".json"]}}],suggestedName:"exported-metadata.json"},n=await(await globalThis.showSaveFilePicker(e)).createWritable(),o=[];k.forEach((i,a)=>{o.push(i)});let r=new Blob([JSON.stringify({metadata:o})],{type:"application/json"});await n.write(r),await n.close()}catch(e){return console.log("export error:",e),!1}return!0}async function ct(){try{let e={types:[{description:"Metadata",accept:{"application/json":[".json"]}}],multiple:!1},[t]=await globalThis.showOpenFilePicker(e),o=await(await t.getFile()).arrayBuffer(),r=new Uint8Array(o),a=new TextDecoder("utf-8").decode(r),s=JSON.parse(a).metadata;for(let l of s)console.log(`updating metadata for ${l.contentHash}`),it(l.contentHash,l);return!0}catch(e){return console.log("import error:",e),!1}}async function lt(e){for(let t of k.keys())e.has(t)||k.delete(t);return te("metadata",e)}var yn=624,En=1e4;function Ie(e,t,n){let o={};function r(){l.style.width=`${yn}px`,o.width=l.videoWidth,o.height=l.videoHeight,o.duration=l.duration}function i(p){if(u!==0&&(clearTimeout(u),u=0),l.removeEventListener("error",s,!1),l.removeEventListener("canplay",c,!1),l.removeEventListener("loadedmetadata",r,!1),l.src="",p&&(o.image=p,p.size<1200&&t.retries>0)){--t.retries,typeof t.specificTime=="number"&&(t.specificTime+=1/30),Ie(e,t,n);return}n(o)}function a(){l.removeEventListener("seeked",a,!1),hn(l,i)}function c(){l.removeEventListener("canplay",c,!1),l.pause(),t.specificTime||(t.specificTime=l.duration/2),l.addEventListener("seeked",a),l.currentTime=t.specificTime}function s(){i(null)}let l=document.getElementById("generator");l.addEventListener("canplay",c,!1),l.addEventListener("loadedmetadata",r,!1),l.addEventListener("error",s,!1),l.src=e;let u=setTimeout(s,En);l.pause()}function hn(e,t){let n=document.getElementById("canvas"),o=e.offsetWidth,r=e.offsetHeight;n.width=o,n.height=r;let i=e.offsetWidth,a=e.offsetHeight,c=n.getContext("2d",{willReadFrequently:!0});if(!c){t(null);return}c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.drawImage(e,0,0,i,a),n.toBlob(t,"image/webp",.5)}var dt=new Map;function S(e){return dt.get(e)||{duration:0,width:0,height:0}}function ut(e,t){let n={duration:t&&t.duration||0,width:t&&t.width||0,height:t&&t.height||0};dt.set(e,n)}var oe=0,V=0;function mt(e,t){let n=document.getElementById("progress-container"),o=document.getElementById("progress");V==0&&(n.style.opacity="1"),oe+=t,V+=e,o.value=oe,o.max=V,oe>=V&&(n.style.opacity="0",V=0,oe=0)}function ft(e,t){let o=b().transaction("previews").objectStore("previews").get(e);o.onsuccess=r=>{ut(e,o.result),t(o.result)}}var $=[],xe=!1;function gt(e,t,n){Le(e,t,void 0,n)}function Le(e,t,n,o){mt(1,0),$.push({contentHash:e,file:t,specificTime:n,callback:o,processing:!1}),$.length==1&&Ce()}function De(e,t){b().transaction("previews","readwrite").objectStore("previews").put(t,e)}function pt(){xe=!0}function yt(){xe=!1;let e=$[0];e&&!e.processing&&Ce()}function Ce(){if(xe)return;let e=$[0];e&&(e.processing=!0,Tn(e.contentHash,e.file,e.specificTime,t=>{$.shift(),e.callback(t),Ce()}))}function Tn(e,t,n,o){let r=URL.createObjectURL(t);Ie(r,{specificTime:n,retries:n===void 0?1:3},c=>{URL.revokeObjectURL(r),mt(0,1),ut(e,c),o(c)})}async function Et(e){return te("previews",e)}function w(e){for(;e.hasChildNodes();)e.removeChild(e.lastChild)}function G(e,t){w(e);let n=document.createElement("span");n.textContent=t,e.appendChild(n)}function bn(e){return[...new Uint8Array(e)].map(t=>t.toString(16).padStart(2,"0")).join("")}async function vt(e){let n=null;if(e.size<3*1024)n=await e.arrayBuffer();else{n=new ArrayBuffer(3*1024+8);let o=new BigUint64Array(n);o[0]=BigInt(e.size);let r=Math.floor((e.size-1024)/2),i=e.slice(0,1024).arrayBuffer(),a=e.slice(r,r+1024).arrayBuffer(),c=e.slice(e.size-1024,e.size).arrayBuffer(),s=new Uint8Array(n);s.set(new Uint8Array(await i),8),s.set(new Uint8Array(await a),1032),s.set(new Uint8Array(await c),8+2*1024)}return bn(await crypto.subtle.digest("SHA-256",n))}function Tt(e){let t=3735928559,n=1103547991;for(let o=0,r;o<e.length;o++)r=e.charCodeAt(o),t=Math.imul(t^r,2654435761),n=Math.imul(n^r,1597334677);return t=Math.imul(t^t>>>16,2246822507)^Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507)^Math.imul(t^t>>>13,3266489909),(n>>>0).toString(16).padStart(8,"0")+(t>>>0).toString(16).padStart(8,"0")}function re(e){if(e<1024)return`${e.toFixed()} B`;let t=["kB","MB","GB","TB","PB"],n=-1;do e/=1024,++n;while(Math.round(Math.abs(e)*100)/100>=1024&&n<t.length-1);return`${e.toFixed(2)} ${t[n]}`}function ht(e,t){return String(e).padStart(t,"0")}function D(e,t=!1){e=Math.floor(e);let n=Math.floor(e/3600),o=Math.floor(e%3600/60),r=e%60,i=ht(r,2);if(t)return`${n?`${n}h `:""} ${o}m ${r}s`;if(n){let a=ht(o,2);return`${n}:${a}:${i}`}return`${o}:${i}`}function bt(e){return e>=1048576?`${(e/1048576).toFixed(2)} Mbps`:`${(e/1024).toFixed(2)} Kbps`}function He(e,t,n){let o=n*(1-t/2);if(o==0||o==1)return[e,0,o];let r=(n-o)/Math.min(o,1-o);return[e,r,o]}function ke(e,t,n){return`hsl(${e} ${t*100}% ${n*100}%`}var St={};function Pe(e){let t=St[e];if(t)return t;let n=Tt(e),o=(g,y,L)=>y+g*(L-y),r=o(parseInt(n.substr(7,3),16)/4096*360,0,360),i=o(parseInt(n.substr(2,2),16)/255,.4,.8),a=o(parseInt(n.substr(4,2),16)/255,.2,.4),c=Math.min(i*.8,1),s=Math.min(a*3,1),l=Math.min(i*.8,1),u=Math.min(a*4,1),p={bkg:ke(...He(r,i,a)),border:ke(...He(r,c,s)),text:ke(...He(r,l,u))};return St[e]=p,p}var C={};function Mt(){C={}}function Sn(e){C[e]=C[e]+1||1}function wn(e){--C[e]==0&&delete C[e]}function Ae(e){let t=[];for(let n of Object.keys(C))n.startsWith(e)&&n!=e&&t.push(n);return t.sort((n,o)=>C[o]-C[n]),t}function Mn(e){let t=e?.parentElement?.parentElement;if(!t)throw"tagContainer without parent";return t.id}function It(e){let t=Mn(e);t&&B(t,n=>(n.tags=xt(e),n))}function ae(e){return e.childNodes[0].textContent||""}function xt(e){let t=[],n=e.children;for(let o=1;o<n.length;++o)t.push(ae(n[o]));return t}function In(e,t){return e.length!=t.length?!1:e.every((n,o)=>n===t[o])}function Be(e,t){let n=xt(e);if(!In(n,t)){for(let o of n)Ft(e,o);for(let o of t)Dt(e,o)}}function Oe(e,t){let n=document.createElement("span");n.className="tag",n.textContent=e;let o=Pe(e);if(n.style.background=o.bkg,n.style.borderColor=o.border,n.style.color=o.text,n.addEventListener("click",r=>{r.stopPropagation()}),!t||!t.displayOnly){let r=document.createElement("span");r.className="tag-delete",r.textContent="x",r.addEventListener("click",Dn),n.appendChild(r)}return n}function Lt(e){return e.trim().toLowerCase()}function xn(e,t){t=Lt(t);let n=e.children;for(let o=1;o<n.length;++o)if(t===ae(n[o]))return!0;return!1}function Dt(e,t){Sn(t),e.appendChild(Oe(t))}function wt(e,t){let n=Lt(t||"");n!==""&&(xn(e,n)||(Dt(e,n),It(e)))}function Ln(e){let t=e.currentTarget;if(!t.classList.contains("tag-add"))return;let n=t.parentElement;if(!n)throw"event on unparented tagContainer";switch(e.key){case"Escape":t.textContent="+",t.blur();break;case"Tab":t.textContent==""||t.textContent=="+"?(t.textContent="+",t.blur()):(wt(n,t.textContent),t.textContent="",setTimeout(()=>{t.focus()},0)),e.preventDefault();break;case"Enter":wt(n,t.textContent),t.textContent="+",t.blur();break}e.stopPropagation()}function Ct(){let e=document.createElement("span");e.className="tag-add",e.textContent="+",e.contentEditable="true",e.setAttribute("spellcheck","false"),e.setAttribute("tabindex","-1"),e.addEventListener("click",n=>{e.textContent="",n.stopPropagation()}),e.addEventListener("focusout",n=>{e.textContent="+"}),e.addEventListener("keydown",Ln);let t=document.createElement("div");return t.className="tag-container",t.appendChild(e),t}function Ft(e,t){wn(t);for(let n of e.children)if(t===ae(n)){e.removeChild(n);break}}function Dn(e){if(!e.currentTarget)return;e.stopPropagation();let n=e.currentTarget.parentElement;if(!n)return;let o=ae(n),r=n.parentElement;if(!r)throw"unparented tagDelete";Ft(r,o),It(r)}var j=0,Cn=4e3,K=0,Fn=5e3;function se(e,t){let n=document.getElementById(e);G(n,t)}function O(e){e&&e.info&&(se("osd-info1",e.info),K&&(clearTimeout(K),K=0),K=setTimeout(()=>{se("osd-info1",""),K=0},Fn));let t=document.getElementById("osd-container");t.style.opacity="1.0",j&&(clearTimeout(j),j=0),j=setTimeout(()=>{t.style.opacity="0",j=0},Cn)}function _e(){let e=document.getElementById("osd-container");e.style.opacity="0"}function ce(e){let t=document.getElementById(e);if(t){let n=document.getElementById("osd-title"),o=t.getAttribute(T)||"";G(n,o);let r=document.getElementById("osd-fileinfo");w(r);let i=S(e),a=Number.parseInt(t.getAttribute(v)||"0")||0,c=a*8/(i.duration||1),s=[D(i.duration,!0),`${i.height}p`,re(a),bt(c)];for(let p of s){let g=document.createElement("span");g.textContent=p,g.className="badge",r.appendChild(g)}let l=document.getElementById("osd-tags");w(l);let u=E(e);if(u){for(let g of u.tags){let y=Pe(g),L=document.createElement("span");L.textContent=g,L.className="tag",L.style.background=y.bkg,L.style.borderColor=y.border,L.style.color=y.text,l.appendChild(L)}let p=document.getElementById("osd-sections");p.style.display=u.scenes.length>0?"block":"none",w(p);for(let g of u.scenes){let y=document.createElement("div");y.textContent=g.name,y.className="osd-section",y.style.left=`${g.start*100}%`,y.style.width=`${g.length*100}%`,p.appendChild(y)}}}}function Ht(e,t){for(let n of e)if(t>=n.start&&t<n.start+n.length)return n}function kn(e,t){return!(e.start+e.length<=t.start||t.start+t.length<=e.start)}function kt(e,t){let n=[];for(let o of t)kn(e,o)||n.push(o);for(let o=0;o<n.length;o++)if(e.start<n[o].start)return n.splice(o,0,e),n;return n.push(e),n}function P(){return document.getElementById("search-entry")}function Pt(e){let t=document.getElementsByClassName("entry"),n=0;if(e){let r=jn(e);for(let i of t){let a=i;Rn(a,r)?(a.style.display="",++n):a.style.display="none"}}else for(let r of t){let i=r;i.getAttribute(H)||(i.style.display="",++n)}let o=document.getElementById("video-count");G(o,`${n}`)}function An(e){return S(e.id).duration}function Bn(e){return S(e.id).height}function On(e){return E(e.id).tags.length}function Un(e){return E(e.id).scenes.length}function _n(e){return Number.parseInt(e.getAttribute(v)||"0")/(1024*1024)}function Nn(e){return Number.parseInt(e.getAttribute(v)||"0")/(1024*1024*1024)}function Rn(e,t){if(e.getAttribute(H))return!1;for(let o of t.scalarMatchers)if(!o(e))return!1;if((e.getAttribute(T)||"").toLowerCase().indexOf(t.freetext)===-1)return!1;if(t.includeTags.length||t.excludeTags.length){let o=E(e.id);for(let r of t.includeTags)if(o.tags.indexOf(r)===-1)return!1;for(let r of t.excludeTags)if(o.tags.indexOf(r)!==-1)return!1}return!0}function Vn(e){let t=e.match(/^(>=|>|=|<|<=)([0-9]+)([ptsmg]?)$/);if(!t)return;let n=An;t[3]=="p"?n=Bn:t[3]=="t"?n=On:t[3]=="s"?n=Un:t[3]=="m"?n=_n:t[3]=="g"&&(n=Nn);let o=Number.parseInt(t[2]);switch(t[1]){case">=":return r=>n(r)>=o;case">":return r=>n(r)>o;case"=":return r=>n(r)==o;case"<":return r=>n(r)<o;case"<=":return r=>n(r)<=o}}function $n(e,t){let n=Vn(e);return n?(t.scalarMatchers.push(n),!0):!1}function Gn(e,t){let n="dir:";if(!e.startsWith(n))return!1;let o=e.substr(n.length);return o.length===0?!1:(t.scalarMatchers.push(r=>r.getAttribute(X)===o),!0)}function jn(e){let t={freetext:"",includeTags:[],excludeTags:[],scalarMatchers:[]},n=e.slice(-1);(n=="+"||n=="-")&&(e=e.slice(0,-1));let o=[];for(let r of e.trim().toLowerCase().split(" "))r[0]=="+"&&r.length>=2?t.includeTags.push(r.substring(1)):r[0]=="-"&&r.length>=2?t.excludeTags.push(r.substring(1)):$n(r,t)||Gn(r,t)||o.push(r);return t.freetext=o.join(" "),t}function At(e,t){let n=t;if(n==e.length||e[n]==" "){for(;n--&&e[n]!=" ";)if((e[n]=="+"||e[n]=="-")&&(n==0||e[n-1]==" "))return e.substring(n+1,t)}}function le(){let e=P();Pt(e.value.trim().toLowerCase()),Nt()}function Bt(){let e=P(),t=document.getElementById("completion");if(w(t),e.selectionStart!=e.selectionEnd){U();return}let n=!1,o=At(e.value,e.selectionStart||0);if(o!==void 0){let r=Ae(o);if(r.length>0){n=!0;for(let i of r)t.appendChild(Oe(i,{displayOnly:!0}));zn()}}n||U()}function Ot(e){if(e.key==="Tab"){let t=P();if(t.selectionStart==t.selectionEnd){let n=t.selectionStart||0,o=At(t.value,n);if(o!==void 0){let r=Ae(o);if(r.length===1){let i=r[0].substring(o.length)+" ";t.setRangeText(i);let a=n+i.length;t.setSelectionRange(a,a),le(),e.preventDefault(),U()}}}}else setTimeout(Bt,0)}function Ut(e){Bt()}function _t(e){let t=P();Nt(),Pt(t.value.trim().toLowerCase())}function Nt(){let e=P(),t=document.getElementById("clear-search");t.style.visibility=e.value.length===0?"hidden":"visible"}function Rt(){qn("")}function Kn(e,t){let n=e.id+"--mirror",o=document.getElementById(n);if(!o){o=document.createElement("div"),o.id=n;let i=getComputedStyle(e),a=o.style;a.position="absolute",a.visibility="hidden",a.overflow="hidden",a.width=i.width,a.height=i.height,a.paddingTop=i.paddingTop,a.paddingRight=i.paddingRight,a.paddingBottom=i.paddingBottom,a.paddingLeft=i.paddingLeft,a.fontFamily=i.fontFamily,a.fontStyle=i.fontStyle,a.fontVariant=i.fontVariant,a.fontWeight=i.fontWeight,a.fontSize=i.fontSize,a.textAlign=i.textAlign,document.body.appendChild(o)}o.textContent=e.value.substring(0,t).replace(/\s/g,"\xA0");let r=document.createElement("span");return r.textContent=".",o.appendChild(r),r.offsetLeft}function zn(){let e=P(),t=document.getElementById("completion"),n=Kn(e,e.selectionStart||0),o=-e.scrollLeft+n+10,r=e.offsetWidth-o-10;t.style.left=`${e.offsetLeft+o}px`,t.style.top=`${e.offsetTop+4}px`,t.style.width=`${r}px`,t.style.display="block"}function U(){let e=document.getElementById("completion");e.style.display="none",w(e)}function qn(e){let t=P();t.value=e,t.dispatchEvent(new Event("change"))}var de=class{maxConcurrency;current=0;q=[];constructor(t){this.maxConcurrency=t}run(t){this.q.push(t),this.tryRun()}tryRun(){if(this.current<this.maxConcurrency){let t=this.q.shift();t!==void 0&&(this.current++,t().then(()=>{this.current--,this.tryRun()}))}}};var ue=0;function I(e,t=7e3){Vt(e,"info",t)}function F(e,t=7e3){Vt(e,"error",t)}function Vt(e,t,n){let o=document.getElementById("toast");o.setAttribute("data-kind",t),o.style.pointerEvents="auto",o.style.opacity="1";let r=document.getElementById("toast-msg");r.textContent=e,ue!==0&&(clearTimeout(ue),ue=0),ue=setTimeout(me,n)}function me(){let e=document.getElementById("toast");e.style.pointerEvents="none",e.style.opacity="0"}var qt=["avi","m4v","mkv","mov","mp4","mpeg","mpeg4","ogg","ogv","webm","wmv"];function $t(e){let t=e.substr(e.lastIndexOf(".")+1).toLowerCase();return qt.indexOf(t)>=0}var Wt="settings",d={sortMode:"by_name",loopSingle:!1,hideDupes:!1,previewOnHover:!1},f=null;function Yn(e){return typeof e=="string"&&Y.get(e)?e:"shuffle"}function Jn(e){let n=b().transaction("misc").objectStore("misc").get(Wt);n.onsuccess=o=>{let r=n.result;r&&(d.sortMode=Yn(r.sortMode),d.loopSingle=!!r.loopSingle,d.hideDupes=!!r.hideDupes,d.previewOnHover=!!r.previewOnHover),e()},n.onerror=()=>{F("Error loading preferences"),e()}}function je(){let t=b().transaction("misc","readwrite").objectStore("misc"),n={loopSingle:d.loopSingle,sortMode:d.sortMode,hideDupes:d.hideDupes,previewOnHover:d.previewOnHover};t.put(n,Wt).onsuccess=()=>{console.log("settings saved",n)}}function m(){return document.getElementById("video-player")}function Te(){return document.getElementById("video-container")}function Ke(){return document.getElementById("entries")}function Q(){return document.getElementById("gallery-container")}function Xn(e){return e?.getAttribute(T)||""}function ze(e){return e.querySelector(".entry-image")}function Qt(e){Yt(),Ve=null,f=e,m().pause(),rn(!1),be(e,t=>{eo(URL.createObjectURL(t)),ce(e)})}function Z(){return f?document.getElementById(f):null}function be(e,t){let n=N[e];if(n){t(n.file);return}}function eo(e){let t=m();t.src&&(URL.revokeObjectURL(t.src),t.src=""),t.autoplay=!0,t.src=e}function to(e){let t=e.lastIndexOf(".");if(t==-1)return e;let n=e.substr(t+1).toLowerCase();return qt.indexOf(n)==-1?e:e.substr(0,t)}function Zt(e){return e.getElementsByTagName("img")[0]}var x=null,A=0,Ne=3;function no(e){if(e<30)return 4;if(e>3600)return 15;let i=(e-30)/3570;return Math.floor(Math.sqrt(i)*11+4)}function oo(e,t){let n=no(e);if(n*(t+3)>e)return[];let r=e/n,i=[],a=r;for(let c=1;c<n;++c)i.push(a),a+=r;return i}function Yt(){if(x){Zt(x).style.display="";for(let e of x.getElementsByTagName("video")){let t=e.src;e.pause(),e.src="",e.remove(),URL.revokeObjectURL(t)}A&&(clearTimeout(A),A=0),x=null}}var he=[],pe=0;function Jt(){if(A=0,x){let e=x.getElementsByTagName("video");if(e.length!=1)return;let t=e[0];t.currentTime=he[pe],A=setTimeout(Jt,Ne*1e3),++pe==he.length&&(pe=0)}}function ro(e){if(x||A||!e.parentElement)return;x=e;let t=e.parentElement.id,n=Zt(e),o=Math.floor(n.offsetHeight);t&&be(t,r=>{let i=URL.createObjectURL(r);if(x!=e){URL.revokeObjectURL(i);return}let a=document.createElement("video");a.style.height=`${o}px`,a.style.display="none",a.muted=!0,a.autoplay=!0,a.loop=!0,e.appendChild(a),a.src=i,a.addEventListener("loadedmetadata",()=>{n.style.display="none",a.style.display="",pe=0,he=oo(a.duration,Ne),he.length>0&&(A=setTimeout(Jt,Ne*1e3))},!1)})}var Re=null,ye=0;function io(e){d.previewOnHover&&(Re=e.target,ye=setTimeout(()=>{Re==e.target&&ro(e.target)},500))}function ao(e){Re=null,ye!==0&&(clearTimeout(ye),ye=0),Yt()}function so(e){let t=to(e),n=document.createElement("div");n.className="entry",n.addEventListener("click",go),n.setAttribute(T,t);let o=document.createElement("div");o.className="entry-preview",o.addEventListener("mouseenter",io),o.addEventListener("mouseleave",ao);let r=document.createElement("img");r.className="entry-image",o.appendChild(r),o.appendChild(Ct());let i=document.createElement("div");i.className="duration-badge",o.appendChild(i);let a=document.createElement("div");a.className="quality-badge",o.appendChild(a);let c=document.createElement("div");c.className="file-size-badge",o.appendChild(c),n.appendChild(o);let s=document.createElement("div");return s.className="entry-title",s.textContent=t,n.appendChild(s),n}function co(){let e=Ke(),t=[...e.children];for(let n=t.length-1;n>0;n--){let o=Math.floor(Math.random()*(n+1));[t[n],t[o]]=[t[o],t[n]]}t.forEach(n=>{e.appendChild(n)})}var lo=(e,t)=>{let n=e.getAttribute(T)||"",o=t.getAttribute(T)||"";return n.localeCompare(o)},uo=(e,t)=>{let n=Number.parseInt(e.getAttribute(v)||"0")||0,o=Number.parseInt(t.getAttribute(v)||"0")||0;return n-o},mo=(e,t)=>{let n=S(e.id).duration,o=S(t.id).duration;return n-o},fo=(e,t)=>{let n=Number.parseInt(e.getAttribute(v)||"0")||0,o=Number.parseInt(t.getAttribute(v)||"0")||0,r=S(e.id).duration||1,i=S(t.id).duration||1,a=n/r,c=o/i;return a-c};function fe(e){let t=Ke(),n=[...t.children];n.sort(e),n.forEach(o=>{t.appendChild(o)})}var Y=new Map([["shuffle",{icon:"url(./assets/shuffle-icon.svg)",tooltip:"Shuffle",func:()=>{co()}}],["by_name",{icon:"url(./assets/sort-icon.svg)",tooltip:"Sort by name",func:()=>{fe(lo)}}],["by_file_size",{icon:"url(./assets/sort-by-size.svg)",tooltip:"Sort by size",func:()=>{fe(uo)}}],["by_duration",{icon:"url(./assets/sort-by-duration.svg)",tooltip:"Sort by duration",func:()=>{fe(mo)}}],["by_quality",{icon:"url(./assets/sort-by-quality.svg)",tooltip:"Sort by quality",func:()=>{fe(fo)}}]]);function Xt(){let e=Y.get(d.sortMode);e&&e.func()}function en(){let e=Y.get(d.sortMode);if(e){let t=document.getElementById("shuffle-button");t.style.backgroundImage=e.icon,t.title=e.tooltip}}function tn(){let e=document.getElementById("loop-button"),t=m();d.loopSingle?(e.classList.remove("disabled"),e.title="Loop single on",t.setAttribute("loop","")):(e.classList.add("disabled"),e.title="Loop single off",t.removeAttribute("loop"))}function qe(){return Q().style.display!=="none"}async function go(e){if(!e.currentTarget)return;e.preventDefault(),e.stopPropagation();let t=e.currentTarget;if(t.getAttribute(H))return;let n=m();if(t==Z())try{await n.play()}catch(o){console.log("Error playing video",o),on()}else Te().style.background="",Qt(t.id)}function po(){if(m().src){yo();let t=Z();if(t&&"mediaSession"in navigator){let n=ze(t),o={title:Xn(t),artist:"VideoQueen",artwork:[{src:n.src,sizes:`${n.naturalWidth}x${n.naturalHeight}`,type:"image/webp"}]};navigator.mediaSession.metadata=new MediaMetadata(o)}}}function nn(){let e=m();e.paused||e.pause(),Q().style.display="block",Te().style.display="none",document.getElementById("progress-container").style.display="",_e(),yt()}function yo(){qe()&&(Q().style.display="none",Te().style.display="block",document.getElementById("progress-container").style.display="none",me()),pt()}function on(){let e=m();F(`Error playing video: ${e.error?e.error.message:""}`)}var ve,ge=0;function Eo(){if(m().duration){if(ve){O({info:`Scene: ${ve}`});return}O()}}function ho(){let e=m();O({info:`Volume: ${Math.round(e.volume*100)}%`})}function vo(){let e=m();O({info:`Speed: ${Math.round(e.playbackRate*100)}%`})}function To(){$e()}function bo(){let e=m();if(e.src&&e.paused&&f){let t=e.currentTime,n=f;nn();let o=document.getElementById(n);if(!o)return;be(n,function(r){Le(n,r,t,i=>{if(i.image){let c=ze(o).src;Ge(o,i),URL.revokeObjectURL(c),De(n,i),B(n,s=>(s.thumbnailTime=t,s))}})})}}async function Gt(){if(document.fullscreenElement)document.exitFullscreen();else try{await Te().requestFullscreen()}catch(e){console.log("fullscreen failed: ",e)}}function rn(e){let t=m(),n=!1;typeof e<"u"?n=e:n=t.style.objectFit!=="fill",t.style.objectFit=n?"fill":"contain"}function jt(e,t){t.paused&&!t.error?t.play():t.pause()}var Ve=null,z=0;function Se(e,t,n){if(n==1&&h){let o=e.duration*h.start,r=e.duration*(h.start+h.length);(t<o||t>=r)&&(I("Exiting loop",1e3),h=void 0)}e.currentTime=t}function M(e,t){let n=parseInt(e.key);Ve===n?(z+=.01,z>=1&&(z=0)):z=n/10,Ve=n,Se(t,t.duration*z,1)}function So(e,t){if(!f)return;let n=E(f),o=t.duration*.5;typeof n.thumbnailTime=="number"&&(o=n.thumbnailTime),Se(t,o,1)}function _(e,t={}){return(n,o)=>{if(!t.pauseOnly||o.paused){let r=n.shiftKey&&t.shiftDelta?t.shiftDelta:e,i=o.currentTime;Se(o,Math.max(Math.min(i+r,o.duration),0),1)}}}var W,h;function wo(e,t){if(!t.paused){F("Pause video before marking start of scene",3e3);return}W=t.currentTime/t.duration,I(`Marked start of scene at ${D(t.currentTime)}`,3e3)}function Mo(e,t){if(!t.paused){F("Pause video before marking end of scene",3e3);return}if(W===void 0){F("Mark start of scene before marking end",3e3);return}if(t.currentTime/t.duration-W<=0){F("Scene end must be after the start",3e3);return}document.getElementById("name-scene-dialog").showModal()}function Io(){if(W===void 0||!f)return;let e=m(),t=W,n=e.currentTime/e.duration,o=n-t,i=document.getElementById("save-scene-name").value.trim();i!==""&&(B(f,a=>(a.scenes=kt({start:t,length:o,name:i},a.scenes),a)),I(`Adding scene between ${D(t*e.duration)} and ${D(n*e.duration)}`,3e3),ce(f))}function xo(e){let t=m(),n=t.currentTime/t.duration,o=D(t.currentTime),r=Math.round(n*100);se("osd-info2",`Time: ${o} (${r}%)`),h&&n>h.start+h.length&&Se(t,h.start*t.duration,2)}function Lo(e){if(!f)return;let t=e.currentTime/e.duration,n=E(f);return Ht(n.scenes,t)}function Do(e,t){h=Lo(t),h&&(t.currentTime=h.start*t.duration)}function Co(e,t){if(!f)return;let n=E(f);if(n.scenes.length===0)return;let o=i=>{ve=i.name,ge&&clearTimeout(ge),ge=setTimeout(()=>{ve="",ge=0},500),t.currentTime=i.start*t.duration,t.paused&&!t.error&&t.play()},r=t.currentTime/t.duration;for(let i of n.scenes)if(i.start>r){o(i);return}o(n.scenes[0])}var Fo={Enter:Gt,w:(e,t)=>{rn()},f:Gt,t:bo,p:Kt,n:$e,PageUp:Kt,PageDown:$e,A:_o,a:Uo,"[":wo,"]":Mo,L:Do,s:Co,0:M,1:M,2:M,3:M,4:M,5:M,6:M,7:M,8:M,9:M,j:_(-10),l:_(10),",":_(-1/30,{pauseOnly:!0}),".":_(1/30,{pauseOnly:!0}),ArrowLeft:_(-5,{shiftDelta:-30}),ArrowRight:_(5,{shiftDelta:30}),z:So," ":jt,k:jt,Escape:(e,t)=>{t.paused||t.pause(),nn()},"=":(e,t)=>{t.playbackRate=1},ArrowUp:(e,t)=>{t.volume=Math.min(t.volume+.1,1)},ArrowDown:(e,t)=>{t.volume=Math.max(t.volume-.1,0)},i:()=>{Z()&&O()},d:()=>{f&&B(f,e=>{let t="delete",o=e.tags.indexOf(t);return o==-1?(I(`Added '${t}' tag`,3e3),e.tags.push(t)):(I(`Removed '${t}' tag`,3e3),e.tags.splice(o,1)),e})}};function Ho(e){if(document.activeElement&&document.activeElement.tagName==="INPUT"||e.key==="w"&&e.ctrlKey)return;if(qe()){if(e.code==="Escape"){let n=m();n.paused&&n.src&&!n.error&&n.play(),e.preventDefault(),e.stopPropagation()}e.key==="k"&&e.ctrlKey&&(document.getElementById("search-entry").focus(),e.preventDefault(),e.stopPropagation()),e.key==="m"&&e.ctrlKey&&(an("shuffle"),e.preventDefault(),e.stopPropagation());return}let t=Fo[e.key];t&&(t(e,m()),e.preventDefault(),e.stopPropagation())}function ko(){d.loopSingle=!d.loopSingle,tn(),je()}function an(e){d.sortMode=e,en(),Xt(),je()}function Po(){if(document.getElementById("sort-dropdown-content").classList.toggle("show-dropdown"),Y.get(d.sortMode)){let n=`arrange_${d.sortMode}`,o=document.getElementById(n);o.checked=!0}}function Ao(e){if(!qe()){let t=m();t.volume=Math.max(Math.min(t.volume+e.deltaY/560,1),0)}}function Bo(){let e=[],t=document.getElementsByClassName("entry");for(let n of t){let o=n;o.style.display!=="none"&&e.push(o)}return e}function sn(){return e=>!0}function Oo(e){return t=>cn(t)==e}function We(e,t){let n=Bo(),o=Z();if(!o)return;let r=n.indexOf(o);if(!(r<0))for(let i=0;i!=n.length-1;++i){r=e?r<n.length-1?r+1:0:r>0?r-1:n.length-1;let a=n[r];if(!(a.getAttribute(H)||a.getAttribute(J))&&t(a)){_e(),Qt(a.id);break}}}function $e(){We(!0,sn())}function Kt(){We(!1,sn())}function cn(e){let t=e.getAttribute(T)||"";if(t=="")return"";let n=t.indexOf("-");return n==-1?"":t.substr(0,n).trim().toLowerCase()}function ln(e){let t=Z();if(!t)return;let n=cn(t);n!=""&&We(e,Oo(n))}function Uo(){ln(!0)}function _o(){ln(!1)}function Ge(e,t){let n=ze(e);if(Ee<q&&(++Ee,Ee==q&&Ro()),t.unsupported)e.setAttribute(H,"true"),e.style.display="none";else{let o=e.querySelector(".duration-badge");o.textContent=D(t.duration);let r=e.querySelector(".quality-badge");r.textContent=`${t.width}x${t.height}`,n.src=URL.createObjectURL(t.image)}}function No(e,t){ft(e,n=>{if(n){Ge(t,n);return}be(e,o=>{gt(e,o,r=>{r.image||(r={unsupported:!0}),Ge(t,r),De(e,r)})})})}var N={},Ee=0,q=0,dn=0;async function un(e){document.getElementById("initial-view").style.display="none",Mt(),N={},Ee=0,dn=performance.now();for(let o of document.getElementsByClassName("entry-image")){let r=o;URL.revokeObjectURL(r.src)}let t=Ke();w(t),q=0;for(let o of e){let r=o.file;$t(r.name)&&++q}q>0&&(Q().style.display="none");let n=new de(64);for(let o of e){let r=o.file;if(!$t(r.name))continue;let i=so(r.name);t.appendChild(i),n.run(()=>vt(r).then(a=>{if(document.getElementById(a)){let s=i.querySelector(".entry-preview");if(s){s.setAttribute(J,"true"),i.setAttribute(J,"true");let u=document.createElement("div");u.className="dupe-badge",u.textContent=`Dupe of ${N[a].file.name}`,s.append(u)}let l=i.querySelector(".tag-container");l&&l.remove()}else{i.setAttribute("id",a),i.setAttribute(v,`${r.size}`),i.setAttribute(X,o.dir);let s=i.querySelector(".file-size-badge");s.textContent=re(r.size);let l=i.querySelector(".tag-container"),u=E(a);Be(l,u.tags),N[a]=o}No(a,i)}))}}function Ro(){Q().style.display="block";let e=performance.now();console.log(`Total load time: ${e-dn}`),Xt(),le()}function mn(){let e=Object.values(N);e.length>0&&un(e)}async function Vo(e){e.preventDefault();let t=await st();document.getElementById("settings-dialog").close(),t&&I("Metadata exported")}async function $o(e){e.preventDefault();let t=await ct();document.getElementById("settings-dialog").close(),mn(),t&&I("Metadata imported")}async function Go(){let e=new Set(Object.keys(N)),t=await Et(e),n=await lt(e);I(`Removed ${t} unused previews and ${n} metadata entries`)}function jo(){U()}function Ko(e){if(!(e.target instanceof Element&&e.target.matches("#shuffle-button")))for(let t of document.getElementsByClassName("sort-dropdown-content"))t.classList.remove("show-dropdown")}function zo(e){let t=e.target,n=document.getElementById("top-gradient-mask"),o=document.getElementById("bottom-gradient-mask");t.scrollTop==0?n.style.opacity="0":n.style.opacity="1",t.scrollTop>=t.scrollHeight-t.offsetHeight-2?o.style.opacity="0":o.style.opacity="1"}async function zt(e){let t={id:"boop",mode:"read",startIn:"videos"};try{let n=await globalThis.showDirectoryPicker(t),o=[],r=async(i,a)=>{for await(let[c,s]of a.entries())s.kind==="file"?o.push({file:await s.getFile(),dir:i}):s.kind==="directory"&&await r(c,s)};await r("root",n),un(o)}catch(n){console.log("errol: ",n)}}function fn(){if(d.hideDupes){let e=new CSSStyleSheet;e.replaceSync('.entry[data-dupe="true"] { display: none; }'),document.adoptedStyleSheets=[e]}else document.adoptedStyleSheets=[]}function qo(){let e=document.getElementById("settings-hide-dupes");e.checked=d.hideDupes;let t=document.getElementById("settings-preview-video");t.checked=d.previewOnHover,document.getElementById("settings-dialog").showModal()}function Wo(){let e=document.getElementById("settings-hide-dupes");e.checked!==d.hideDupes&&(d.hideDupes=e.checked,fn());let t=document.getElementById("settings-preview-video");d.previewOnHover=t.checked,je()}function Qo(e){let t=document.getElementById(e.contentHash);if(!t)return;let n=t.querySelector(".tag-container");n&&Be(n,e.tags),e.contentHash==f&&ce(e.contentHash)}async function Zo(){if("serviceWorker"in navigator)try{let e=await navigator.serviceWorker.register("service-worker.js",{scope:"./"});e.installing?console.log("Service worker installing"):e.waiting?console.log("Service worker installed"):e.active&&console.log("Service worker active")}catch(e){console.error(`Registration failed with ${e}`)}}globalThis.addEventListener("load",function(){globalThis.addEventListener("keydown",Ho,{capture:!0});let e=document.getElementById("search-entry");e.addEventListener("input",le),e.addEventListener("blur",U),e.addEventListener("change",_t),e.addEventListener("keydown",Ot),e.addEventListener("focus",Ut);let t=m();t.addEventListener("play",po,!1),t.addEventListener("error",on,!1),t.addEventListener("seeking",Eo,!1),t.addEventListener("volumechange",ho,!1),t.addEventListener("ratechange",vo,!1),t.addEventListener("ended",To,!1),t.addEventListener("timeupdate",xo,!1),document.addEventListener("dragover",function(n){n.dataTransfer&&(n.dataTransfer.dropEffect="none"),n.preventDefault()},!1),document.addEventListener("drop",function(n){n.preventDefault()},!1),document.addEventListener("wheel",Ao,!1),document.getElementById("gallery-view").addEventListener("scroll",zo),document.getElementById("loop-button").addEventListener("click",ko),document.getElementById("shuffle-button").addEventListener("click",Po),document.getElementById("clear-search").addEventListener("click",Rt),document.getElementById("settings").addEventListener("click",qo),document.getElementById("settings-confirm").addEventListener("click",Wo),document.getElementById("settings-export-tags").addEventListener("click",Vo),document.getElementById("settings-import-tags").addEventListener("click",$o),document.getElementById("settings-gc-previews").addEventListener("click",Go),document.getElementById("open-folder").addEventListener("click",zt),document.getElementById("initial-open-folder").addEventListener("click",zt),document.getElementById("save-query-confirm").addEventListener("click",Io),Y.forEach((n,o)=>{document.getElementById(`arrange_${o}`).addEventListener("click",()=>an(o))}),document.getElementById("toast-close").addEventListener("click",me),globalThis.addEventListener("resize",jo),globalThis.addEventListener("click",Ko),Zo(),ot(Qo),Ye(rt),tt(n=>{n?at().then(()=>{Jn(()=>{en(),tn(),fn(),mn()})}):F("Error opening IndexedDB")})});})();
