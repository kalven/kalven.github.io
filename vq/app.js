"use strict";(()=>{var We=new BroadcastChannel("metadataChannel");function qe(e){We.postMessage(e)}function Qe(e){We.addEventListener("message",e)}var y="data-name",I="data-bad-media",Z="data-dupe",x="data-file-size",J="data-file-dir",Je="vqStorage";var O=null,Ye=[];function Xe(e){console.log("storage init");let t=indexedDB.open(Je,4);t.onupgradeneeded=async n=>{console.log(`onupgradeneeded old=${n.oldVersion} new=${n.newVersion}`);let r=t.result;switch(n.oldVersion){case 0:console.log("Creating new DB"),r.createObjectStore("tags",{});case 1:console.log("Upgrading to version 2"),r.createObjectStore("previews",{});case 2:console.log("Upgrading to version 3"),r.createObjectStore("misc",{});case 3:console.log("Upgrading to version 4"),r.createObjectStore("metadata",{}),Ye.push(gn)}},t.onerror=n=>{O=null,e(!1)},t.onsuccess=async n=>{O=t.result;for(let r of Ye)console.log("Running upgrade function"),await r(O);e(!0)}}function E(){if(!O)throw"DB not initialized";return O}async function gn(e){return new Promise((t,n)=>{let r=e.transaction(["tags","metadata"],"readwrite"),o=r.objectStore("tags").openCursor(),i=r.objectStore("metadata"),a=[];o.onsuccess=async l=>{let s=o.result;if(s){let c={contentHash:s.key,tags:s.value.tags};a.push(new Promise((f,b)=>{let Q=i.put({metadata:c},s.key);Q.onsuccess=()=>f(),Q.onerror=b})),s.continue()}else await Promise.all(a),t()},o.onerror=l=>{n(new Error("Could not open tags cursor"))}})}async function X(e,t){return new Promise((n,r)=>{let a=E().transaction(e,"readwrite").objectStore(e).openCursor(),l=0;a.onerror=()=>{r()},a.onsuccess=()=>{let s=a.result;s?(t.has(s.key)||(s.delete(),l++),s.continue()):n(l)}})}var Te=new Map,et=1;function tt(e){Te.set(et,e),et++}var L=new Map;function g(e){let t=L.get(e)||{contentHash:e,tags:[],scenes:[]};return t.scenes=t.scenes||[],t.tags=t.tags||[],t}function nt(e){let t=e.data.md;L.set(t.contentHash,t),Te.forEach(n=>{n(t)})}function pn(e,t){rt(e,t),Te.forEach(n=>{n(t)}),qe({md:t})}function rt(e,t){L.set(e,t),E().transaction("metadata","readwrite").objectStore("metadata").put({metadata:t},e)}function ot(){return new Promise((e,t)=>{let r=E().transaction("metadata","readonly").objectStore("metadata").getAll();r.onerror=o=>{t(new Error("Failed to initialize metadata"))},r.onsuccess=o=>{for(let i of r.result)L.set(i.metadata.contentHash,i.metadata);e()}})}function D(e,t){let n=structuredClone(g(e)),r=t(n);r!==void 0&&pn(e,r)}async function it(){try{let e={types:[{description:"Exported tags",accept:{"application/json":[".json"]}}],suggestedName:"exported-metadata.json"},n=await(await globalThis.showSaveFilePicker(e)).createWritable(),r=[];L.forEach((i,a)=>{r.push(i)});let o=new Blob([JSON.stringify({metadata:r})],{type:"application/json"});await n.write(o),await n.close()}catch(e){return console.log("export error:",e),!1}return!0}async function at(){try{let e={types:[{description:"Metadata",accept:{"application/json":[".json"]}}],multiple:!1},[t]=await globalThis.showOpenFilePicker(e),r=await(await t.getFile()).arrayBuffer(),o=new Uint8Array(r),a=new TextDecoder("utf-8").decode(o),s=JSON.parse(a).metadata;for(let c of s)console.log(`updating metadata for ${c.contentHash}`),rt(c.contentHash,c);return!0}catch(e){return console.log("import error:",e),!1}}async function st(e){for(let t of L.keys())e.has(t)||L.delete(t);return X("metadata",e)}function v(e){for(;e.hasChildNodes();)e.removeChild(e.lastChild)}function U(e,t){v(e);let n=document.createElement("span");n.textContent=t,e.appendChild(n)}function yn(e){return[...new Uint8Array(e)].map(t=>t.toString(16).padStart(2,"0")).join("")}async function ct(e){let n=null;if(e.size<3*1024)n=await e.arrayBuffer();else{n=new ArrayBuffer(3*1024+8);let r=new BigUint64Array(n);r[0]=BigInt(e.size);let o=Math.floor((e.size-1024)/2),i=e.slice(0,1024).arrayBuffer(),a=e.slice(o,o+1024).arrayBuffer(),l=e.slice(e.size-1024,e.size).arrayBuffer(),s=new Uint8Array(n);s.set(new Uint8Array(await i),8),s.set(new Uint8Array(await a),1032),s.set(new Uint8Array(await l),8+2*1024)}return yn(await crypto.subtle.digest("SHA-256",n))}function lt(e){let t=3735928559,n=1103547991;for(let r=0,o;r<e.length;r++)o=e.charCodeAt(r),t=Math.imul(t^o,2654435761),n=Math.imul(n^o,1597334677);return t=Math.imul(t^t>>>16,2246822507)^Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507)^Math.imul(t^t>>>13,3266489909),(n>>>0).toString(16).padStart(8,"0")+(t>>>0).toString(16).padStart(8,"0")}function dt(e){if(e<1024)return`${e.toFixed()} B`;let t=["kB","MB","GB","TB","PB"],n=-1;do e/=1024,++n;while(Math.round(Math.abs(e)*100)/100>=1024&&n<t.length-1);return`${e.toFixed(2)} ${t[n]}`}function Se(e,t,n){let r=n*(1-t/2);if(r==0||r==1)return[e,0,r];let o=(n-r)/Math.min(r,1-r);return[e,o,r]}function be(e,t,n){return`hsl(${e} ${t*100}% ${n*100}%`}var ut={};function Me(e){let t=ut[e];if(t)return t;let n=lt(e),r=(Q,Ke,fn)=>Ke+Q*(fn-Ke),o=r(parseInt(n.substr(7,3),16)/4096*360,0,360),i=r(parseInt(n.substr(2,2),16)/255,.4,.8),a=r(parseInt(n.substr(4,2),16)/255,.2,.4),l=Math.min(i*.8,1),s=Math.min(a*3,1),c=Math.min(i*.8,1),f=Math.min(a*4,1),b={bkg:be(...Se(o,i,a)),border:be(...Se(o,l,s)),text:be(...Se(o,c,f))};return ut[e]=b,b}var M={};function ft(){M={}}function En(e){M[e]=M[e]+1||1}function hn(e){--M[e]==0&&delete M[e]}function we(e){let t=[];for(let n of Object.keys(M))n.startsWith(e)&&n!=e&&t.push(n);return t.sort((n,r)=>M[r]-M[n]),t}function vn(e){let t=e?.parentElement?.parentElement;if(!t)throw"tagContainer without parent";return t.id}function gt(e){let t=vn(e);t&&D(t,n=>(n.tags=pt(e),n))}function ne(e){return e.childNodes[0].textContent||""}function pt(e){let t=[],n=e.children;for(let r=1;r<n.length;++r)t.push(ne(n[r]));return t}function Tn(e,t){return e.length!=t.length?!1:e.every((n,r)=>n===t[r])}function Ie(e,t){let n=pt(e);if(!Tn(n,t)){for(let r of n)vt(e,r);for(let r of t)Et(e,r)}}function xe(e,t){let n=document.createElement("span");n.className="tag",n.textContent=e;let r=Me(e);if(n.style.background=r.bkg,n.style.borderColor=r.border,n.style.color=r.text,n.addEventListener("click",o=>{o.stopPropagation()}),!t||!t.displayOnly){let o=document.createElement("span");o.className="tag-delete",o.textContent="x",o.addEventListener("click",Mn),n.appendChild(o)}return n}function yt(e){return e.trim().toLowerCase()}function Sn(e,t){t=yt(t);let n=e.children;for(let r=1;r<n.length;++r)if(t===ne(n[r]))return!0;return!1}function Et(e,t){En(t),e.appendChild(xe(t))}function mt(e,t){let n=yt(t||"");n!==""&&(Sn(e,n)||(Et(e,n),gt(e)))}function bn(e){let t=e.currentTarget;if(!t.classList.contains("tag-add"))return;let n=t.parentElement;if(!n)throw"event on unparented tagContainer";switch(e.key){case"Escape":t.textContent="+",t.blur();break;case"Tab":t.textContent==""||t.textContent=="+"?(t.textContent="+",t.blur()):(mt(n,t.textContent),t.textContent="",setTimeout(()=>{t.focus()},0)),e.preventDefault();break;case"Enter":mt(n,t.textContent),t.textContent="+",t.blur();break}e.stopPropagation()}function ht(){let e=document.createElement("span");e.className="tag-add",e.textContent="+",e.contentEditable="true",e.setAttribute("spellcheck","false"),e.setAttribute("tabindex","-1"),e.addEventListener("click",n=>{e.textContent="",n.stopPropagation()}),e.addEventListener("focusout",n=>{e.textContent="+"}),e.addEventListener("keydown",bn);let t=document.createElement("div");return t.className="tag-container",t.appendChild(e),t}function vt(e,t){hn(t);for(let n of e.children)if(t===ne(n)){e.removeChild(n);break}}function Mn(e){if(!e.currentTarget)return;e.stopPropagation();let n=e.currentTarget.parentElement;if(!n)return;let r=ne(n),o=n.parentElement;if(!o)throw"unparented tagDelete";vt(o,r),gt(o)}var _=0,wn=4e3,N=0,In=5e3;function re(e,t){let n=document.getElementById(e);U(n,t)}function F(e){e&&e.info&&(re("osd-info1",e.info),N&&(clearTimeout(N),N=0),N=setTimeout(()=>{re("osd-info1",""),N=0},In));let t=document.getElementById("osd-container");t.style.opacity="1.0",_&&(clearTimeout(_),_=0),_=setTimeout(()=>{t.style.opacity="0",_=0},wn)}function Ce(){let e=document.getElementById("osd-container");e.style.opacity="0"}function oe(e){let t=document.getElementById(e);if(t){let n=document.getElementById("osd-title"),r=t.getAttribute(y)||"";U(n,r);let o=document.getElementById("osd-tags");v(o);let i=g(e);if(i){for(let l of i.tags){let s=Me(l),c=document.createElement("span");c.textContent=l,c.className="tag",c.style.background=s.bkg,c.style.borderColor=s.border,c.style.color=s.text,o.appendChild(c)}let a=document.getElementById("osd-sections");a.style.display=i.scenes.length>0?"block":"none",v(a);for(let l of i.scenes){let s=document.createElement("div");s.textContent=l.name,s.className="osd-section",s.style.left=`${l.start*100}%`,s.style.width=`${l.length*100}%`,a.appendChild(s)}}}}var Ln=624,Cn=1e4;function He(e,t,n){let r={};function o(){c.style.width=`${Ln}px`,r.width=c.videoWidth,r.height=c.videoHeight,r.duration=c.duration}function i(b){if(f!==0&&(clearTimeout(f),f=0),c.removeEventListener("error",s,!1),c.removeEventListener("canplay",l,!1),c.removeEventListener("loadedmetadata",o,!1),c.src="",b&&(r.image=b,b.size<1200&&t.retries>0)){--t.retries,typeof t.specificTime=="number"&&(t.specificTime+=1/30),He(e,t,n);return}n(r)}function a(){c.removeEventListener("seeked",a,!1),Hn(c,i)}function l(){c.removeEventListener("canplay",l,!1),c.pause(),t.specificTime||(t.specificTime=c.duration/2),c.addEventListener("seeked",a),c.currentTime=t.specificTime}function s(){i(null)}let c=document.getElementById("generator");c.addEventListener("canplay",l,!1),c.addEventListener("loadedmetadata",o,!1),c.addEventListener("error",s,!1),c.src=e;let f=setTimeout(s,Cn);c.pause()}function Hn(e,t){let n=document.getElementById("canvas"),r=e.offsetWidth,o=e.offsetHeight;n.width=r,n.height=o;let i=e.offsetWidth,a=e.offsetHeight,l=n.getContext("2d",{willReadFrequently:!0});if(!l){t(null);return}l.imageSmoothingEnabled=!0,l.imageSmoothingQuality="high",l.drawImage(e,0,0,i,a),n.toBlob(t,"image/webp",.5)}var Tt=new Map;function k(e){return Tt.get(e)||{duration:0,width:0,height:0}}function St(e,t){let n={duration:t&&t.duration||0,width:t&&t.width||0,height:t&&t.height||0};Tt.set(e,n)}var ie=0,R=0;function bt(e,t){let n=document.getElementById("progress-container"),r=document.getElementById("progress");R==0&&(n.style.opacity="1"),ie+=t,R+=e,r.value=ie,r.max=R,ie>=R&&(n.style.opacity="0",R=0,ie=0)}function Mt(e,t){let r=E().transaction("previews").objectStore("previews").get(e);r.onsuccess=o=>{St(e,r.result),t(r.result)}}var V=[],De=!1;function wt(e,t,n){Fe(e,t,void 0,n)}function Fe(e,t,n,r){bt(1,0),V.push({contentHash:e,file:t,specificTime:n,callback:r,processing:!1}),V.length==1&&Pe()}function ke(e,t){E().transaction("previews","readwrite").objectStore("previews").put(t,e)}function It(){De=!0}function xt(){De=!1;let e=V[0];e&&!e.processing&&Pe()}function Pe(){if(De)return;let e=V[0];e&&(e.processing=!0,Fn(e.contentHash,e.file,e.specificTime,t=>{V.shift(),e.callback(t),Pe()}))}function Fn(e,t,n,r){let o=URL.createObjectURL(t);He(o,{specificTime:n,retries:n===void 0?1:3},l=>{URL.revokeObjectURL(o),bt(0,1),St(e,l),r(l)})}async function Lt(e){return X("previews",e)}function Ht(e,t){for(let n of e)if(t>=n.start&&t<n.start+n.length)return n}function kn(e,t){return!(e.start+e.length<=t.start||t.start+t.length<=e.start)}function Dt(e,t){let n=[];for(let r of t)kn(e,r)||n.push(r);for(let r=0;r<n.length;r++)if(e.start<n[r].start)return n.splice(r,0,e),n;return n.push(e),n}function C(){return document.getElementById("search-entry")}function Ft(e){let t=document.getElementsByClassName("entry"),n=0;if(e){let o=jn(e);for(let i of t){let a=i;Rn(a,o)?(a.style.display="",++n):a.style.display="none"}}else for(let o of t){let i=o;i.getAttribute(I)||(i.style.display="",++n)}let r=document.getElementById("video-count");U(r,`${n}`)}function An(e){return k(e.id).duration}function Bn(e){return k(e.id).height}function On(e){return g(e.id).tags.length}function Un(e){return g(e.id).scenes.length}function _n(e){return Number.parseInt(e.getAttribute(x)||"0")/(1024*1024)}function Nn(e){return Number.parseInt(e.getAttribute(x)||"0")/(1024*1024*1024)}function Rn(e,t){if(e.getAttribute(I))return!1;for(let r of t.scalarMatchers)if(!r(e))return!1;if((e.getAttribute(y)||"").toLowerCase().indexOf(t.freetext)===-1)return!1;if(t.includeTags.length||t.excludeTags.length){let r=g(e.id);for(let o of t.includeTags)if(r.tags.indexOf(o)===-1)return!1;for(let o of t.excludeTags)if(r.tags.indexOf(o)!==-1)return!1}return!0}function Vn(e){let t=e.match(/^(>=|>|=|<|<=)([0-9]+)([ptsmg]?)$/);if(!t)return;let n=An;t[3]=="p"?n=Bn:t[3]=="t"?n=On:t[3]=="s"?n=Un:t[3]=="m"?n=_n:t[3]=="g"&&(n=Nn);let r=Number.parseInt(t[2]);switch(t[1]){case">=":return o=>n(o)>=r;case">":return o=>n(o)>r;case"=":return o=>n(o)==r;case"<":return o=>n(o)<r;case"<=":return o=>n(o)<=r}}function $n(e,t){let n=Vn(e);return n?(t.scalarMatchers.push(n),!0):!1}function Gn(e,t){let n="dir:";if(!e.startsWith(n))return!1;let r=e.substr(n.length);return r.length===0?!1:(t.scalarMatchers.push(o=>o.getAttribute(J)===r),!0)}function jn(e){let t={freetext:"",includeTags:[],excludeTags:[],scalarMatchers:[]},n=e.slice(-1);(n=="+"||n=="-")&&(e=e.slice(0,-1));let r=[];for(let o of e.trim().toLowerCase().split(" "))o[0]=="+"&&o.length>=2?t.includeTags.push(o.substring(1)):o[0]=="-"&&o.length>=2?t.excludeTags.push(o.substring(1)):$n(o,t)||Gn(o,t)||r.push(o);return t.freetext=r.join(" "),t}function kt(e,t){let n=t;if(n==e.length||e[n]==" "){for(;n--&&e[n]!=" ";)if((e[n]=="+"||e[n]=="-")&&(n==0||e[n-1]==" "))return e.substring(n+1,t)}}function ae(){let e=C();Ft(e.value.trim().toLowerCase()),Ut()}function Pt(){let e=C(),t=document.getElementById("completion");if(v(t),e.selectionStart!=e.selectionEnd){P();return}let n=!1,r=kt(e.value,e.selectionStart||0);if(r!==void 0){let o=we(r);if(o.length>0){n=!0;for(let i of o)t.appendChild(xe(i,{displayOnly:!0}));Kn()}}n||P()}function At(e){if(e.key==="Tab"){let t=C();if(t.selectionStart==t.selectionEnd){let n=t.selectionStart||0,r=kt(t.value,n);if(r!==void 0){let o=we(r);if(o.length===1){let i=o[0].substring(r.length)+" ";t.setRangeText(i);let a=n+i.length;t.setSelectionRange(a,a),ae(),e.preventDefault(),P()}}}}else setTimeout(Pt,0)}function Bt(e){Pt()}function Ot(e){let t=C();Ut(),Ft(t.value.trim().toLowerCase())}function Ut(){let e=C(),t=document.getElementById("clear-search");t.style.visibility=e.value.length===0?"hidden":"visible"}function _t(){Wn("")}function zn(e,t){let n=e.id+"--mirror",r=document.getElementById(n);if(!r){r=document.createElement("div"),r.id=n;let i=getComputedStyle(e),a=r.style;a.position="absolute",a.visibility="hidden",a.overflow="hidden",a.width=i.width,a.height=i.height,a.paddingTop=i.paddingTop,a.paddingRight=i.paddingRight,a.paddingBottom=i.paddingBottom,a.paddingLeft=i.paddingLeft,a.fontFamily=i.fontFamily,a.fontStyle=i.fontStyle,a.fontVariant=i.fontVariant,a.fontWeight=i.fontWeight,a.fontSize=i.fontSize,a.textAlign=i.textAlign,document.body.appendChild(r)}r.textContent=e.value.substring(0,t).replace(/\s/g,"\xA0");let o=document.createElement("span");return o.textContent=".",r.appendChild(o),o.offsetLeft}function Kn(){let e=C(),t=document.getElementById("completion"),n=zn(e,e.selectionStart||0),r=-e.scrollLeft+n+10,o=e.offsetWidth-r-10;t.style.left=`${e.offsetLeft+r}px`,t.style.top=`${e.offsetTop+4}px`,t.style.width=`${o}px`,t.style.display="block"}function P(){let e=document.getElementById("completion");e.style.display="none",v(e)}function Wn(e){let t=C();t.value=e,t.dispatchEvent(new Event("change"))}var se=class{maxConcurrency;current=0;q=[];constructor(t){this.maxConcurrency=t}run(t){this.q.push(t),this.tryRun()}tryRun(){if(this.current<this.maxConcurrency){let t=this.q.shift();t!==void 0&&(this.current++,t().then(()=>{this.current--,this.tryRun()}))}}};var ce=0;function T(e,t=7e3){Nt(e,"info",t)}function w(e,t=7e3){Nt(e,"error",t)}function Nt(e,t,n){let r=document.getElementById("toast");r.setAttribute("data-kind",t),r.style.pointerEvents="auto",r.style.opacity="1";let o=document.getElementById("toast-msg");o.textContent=e,ce!==0&&(clearTimeout(ce),ce=0),ce=setTimeout(le,n)}function le(){let e=document.getElementById("toast");e.style.pointerEvents="none",e.style.opacity="0"}var Wt=["avi","m4v","mkv","mov","mp4","mpeg","mpeg4","ogg","ogv","webm","wmv"];function Rt(e){let t=e.substr(e.lastIndexOf(".")+1).toLowerCase();return Wt.indexOf(t)>=0}var Vt=["shuffle","by_name","by_file_size","by_duration"],qt="settings",d={sortMode:"by_name",loopSingle:!1,hideDupes:!1,previewOnHover:!1},m=null;function Jn(e){let t=0;return typeof e=="string"&&(t=Math.max(0,Vt.indexOf(e))),Vt[t]}function Yn(e){let n=E().transaction("misc").objectStore("misc").get(qt);n.onsuccess=r=>{let o=n.result;o&&(d.sortMode=Jn(o.sortMode),d.loopSingle=!!o.loopSingle,d.hideDupes=!!o.hideDupes,d.previewOnHover=!!o.previewOnHover),e()},n.onerror=()=>{w("Error loading preferences"),e()}}function Re(){let t=E().transaction("misc","readwrite").objectStore("misc"),n={loopSingle:d.loopSingle,sortMode:d.sortMode,hideDupes:d.hideDupes,previewOnHover:d.previewOnHover};t.put(n,qt).onsuccess=()=>{console.log("settings saved",n)}}function u(){return document.getElementById("video-player")}function ye(){return document.getElementById("video-container")}function Ve(){return document.getElementById("entries")}function W(){return document.getElementById("gallery-container")}function Xn(e){return e?.getAttribute(y)||""}function $e(e){return e.querySelector(".entry-image")}function Qt(e){Jt(),Ue=null,m=e,u().pause(),on(!1),Ee(e,t=>{er(URL.createObjectURL(t)),oe(e)})}function q(){return m?document.getElementById(m):null}function Ee(e,t){let n=B[e];if(n){t(n.file);return}}function er(e){let t=u();t.src&&(URL.revokeObjectURL(t.src),t.src=""),t.autoplay=!0,t.src=e}function tr(e){let t=e.lastIndexOf(".");if(t==-1)return e;let n=e.substr(t+1).toLowerCase();return Wt.indexOf(n)==-1?e:e.substr(0,t)}function Zt(e){return e.getElementsByTagName("img")[0]}var S=null,H=0,Be=3;function nr(e){if(e<30)return 4;if(e>3600)return 15;let i=(e-30)/3570;return Math.floor(Math.sqrt(i)*11+4)}function rr(e,t){let n=nr(e);if(n*(t+3)>e)return[];let o=e/n,i=[],a=o;for(let l=1;l<n;++l)i.push(a),a+=o;return i}function Jt(){if(S){Zt(S).style.display="";for(let e of S.getElementsByTagName("video")){let t=e.src;e.pause(),e.src="",e.remove(),URL.revokeObjectURL(t)}H&&(clearTimeout(H),H=0),S=null}}var ge=[],ue=0;function Yt(){if(H=0,S){let e=S.getElementsByTagName("video");if(e.length!=1)return;let t=e[0];t.currentTime=ge[ue],H=setTimeout(Yt,Be*1e3),++ue==ge.length&&(ue=0)}}function or(e){if(S||H||!e.parentElement)return;S=e;let t=e.parentElement.id,n=Zt(e),r=Math.floor(n.offsetHeight);t&&Ee(t,o=>{let i=URL.createObjectURL(o);if(S!=e){URL.revokeObjectURL(i);return}let a=document.createElement("video");a.style.height=`${r}px`,a.style.display="none",a.muted=!0,a.autoplay=!0,a.loop=!0,e.appendChild(a),a.src=i,a.addEventListener("loadedmetadata",()=>{n.style.display="none",a.style.display="",ue=0,ge=rr(a.duration,Be),ge.length>0&&(H=setTimeout(Yt,Be*1e3))},!1)})}var Oe=null,me=0;function ir(e){d.previewOnHover&&(Oe=e.target,me=setTimeout(()=>{Oe==e.target&&or(e.target)},500))}function ar(e){Oe=null,me!==0&&(clearTimeout(me),me=0),Jt()}function sr(e){let t=tr(e),n=document.createElement("div");n.className="entry",n.addEventListener("click",mr),n.setAttribute(y,t);let r=document.createElement("div");r.className="entry-preview",r.addEventListener("mouseenter",ir),r.addEventListener("mouseleave",ar);let o=document.createElement("img");o.className="entry-image",r.appendChild(o),r.appendChild(ht());let i=document.createElement("div");i.className="duration-badge",r.appendChild(i);let a=document.createElement("div");a.className="quality-badge",r.appendChild(a);let l=document.createElement("div");l.className="file-size-badge",r.appendChild(l),n.appendChild(r);let s=document.createElement("div");return s.className="entry-title",s.textContent=t,n.appendChild(s),n}function cr(){let e=Ve(),t=[...e.children];for(let n=t.length-1;n>0;n--){let r=Math.floor(Math.random()*(n+1));[t[n],t[r]]=[t[r],t[n]]}t.forEach(n=>{e.appendChild(n)})}var lr=(e,t)=>{let n=e.getAttribute(y)||"",r=t.getAttribute(y)||"";return n.localeCompare(r)},dr=(e,t)=>{let n=Number.parseInt(e.getAttribute(x)||"0")||0,r=Number.parseInt(t.getAttribute(x)||"0")||0;return n-r},ur=(e,t)=>{let n=k(e.id).duration,r=k(t.id).duration;return n-r};function Ae(e){let t=Ve(),n=[...t.children];n.sort(e),n.forEach(r=>{t.appendChild(r)})}var Ge={shuffle:{icon:"url(./assets/shuffle-icon.svg)",tooltip:"Shuffle",radio:"arrange-shuffle",func:()=>{cr()}},by_name:{icon:"url(./assets/sort-icon.svg)",tooltip:"Sort by name",radio:"arrange-sort-az",func:()=>{Ae(lr)}},by_file_size:{icon:"url(./assets/sort-by-size.svg)",tooltip:"Sort by size",radio:"arrange-sort-size",func:()=>{Ae(dr)}},by_duration:{icon:"url(./assets/sort-by-duration.svg)",tooltip:"Sort by duration",radio:"arrange-sort-duration",func:()=>{Ae(ur)}}};function Xt(){Ge[d.sortMode].func()}function en(){let e=document.getElementById("shuffle-button"),t=Ge[d.sortMode];e.style.backgroundImage=t.icon,e.title=t.tooltip}function tn(){let e=document.getElementById("loop-button"),t=u();d.loopSingle?(e.classList.remove("disabled"),e.title="Loop single on",t.setAttribute("loop","")):(e.classList.add("disabled"),e.title="Loop single off",t.removeAttribute("loop"))}function je(){return W().style.display!=="none"}async function mr(e){if(!e.currentTarget)return;e.preventDefault(),e.stopPropagation();let t=e.currentTarget;if(t.getAttribute(I))return;let n=u();if(t==q())try{await n.play()}catch(r){console.log("Error playing video",r),rn()}else ye().style.background="",Qt(t.id)}function fr(){if(u().src){gr();let t=q();if(t&&"mediaSession"in navigator){let n=$e(t),r={title:Xn(t),artist:"VideoQueen",artwork:[{src:n.src,sizes:`${n.naturalWidth}x${n.naturalHeight}`,type:"image/webp"}]};navigator.mediaSession.metadata=new MediaMetadata(r)}}}function nn(){let e=u();e.paused||e.pause(),W().style.display="block",ye().style.display="none",document.getElementById("progress-container").style.display="",Ce(),xt()}function gr(){je()&&(W().style.display="none",ye().style.display="block",document.getElementById("progress-container").style.display="none",le()),It()}function rn(){let e=u();w(`Error playing video: ${e.error?e.error.message:""}`)}function $t(e,t){return String(e).padStart(t,"0")}function z(e){e=Math.floor(e);let t=Math.floor(e/3600),n=Math.floor(e%3600/60),r=e%60,o=$t(r,2);if(t){let i=$t(n,2);return`${t}:${i}:${o}`}return`${n}:${o}`}var pe,de=0;function pr(){if(u().duration){if(pe){F({info:`Scene: ${pe}`});return}F()}}function yr(){let e=u();F({info:`Volume: ${Math.round(e.volume*100)}%`})}function Er(){let e=u();F({info:`Speed: ${Math.round(e.playbackRate*100)}%`})}function hr(){_e()}function vr(){let e=u();if(e.src&&e.paused&&m){let t=e.currentTime,n=m;nn();let r=document.getElementById(n);if(!r)return;Ee(n,function(o){Fe(n,o,t,i=>{if(i.image){let l=$e(r).src;Ne(r,i),URL.revokeObjectURL(l),ke(n,i),D(n,s=>(s.thumbnailTime=t,s))}})})}}async function Gt(){if(document.fullscreenElement)document.exitFullscreen();else try{await ye().requestFullscreen()}catch(e){console.log("fullscreen failed: ",e)}}function on(e){let t=u(),n=!1;typeof e<"u"?n=e:n=t.style.objectFit!=="fill",t.style.objectFit=n?"fill":"contain"}function jt(e,t){t.paused&&!t.error?t.play():t.pause()}var Ue=null,$=0;function he(e,t,n){if(n==1&&p){let r=e.duration*p.start,o=e.duration*(p.start+p.length);(t<r||t>=o)&&(T("Exiting loop",1e3),p=void 0)}e.currentTime=t}function h(e,t){let n=parseInt(e.key);Ue===n?($+=.01,$>=1&&($=0)):$=n/10,Ue=n,he(t,t.duration*$,1)}function Tr(e,t){if(!m)return;let n=g(m),r=t.duration*.5;typeof n.thumbnailTime=="number"&&(r=n.thumbnailTime),he(t,r,1)}function A(e,t={}){return(n,r)=>{if(!t.pauseOnly||r.paused){let o=n.shiftKey&&t.shiftDelta?t.shiftDelta:e,i=r.currentTime;he(r,Math.max(Math.min(i+o,r.duration),0),1)}}}var K,p;function Sr(e,t){if(!t.paused){w("Pause video before marking start of scene",3e3);return}K=t.currentTime/t.duration,T(`Marked start of scene at ${z(t.currentTime)}`,3e3)}function br(e,t){if(!t.paused){w("Pause video before marking end of scene",3e3);return}if(K===void 0){w("Mark start of scene before marking end",3e3);return}if(t.currentTime/t.duration-K<=0){w("Scene end must be after the start",3e3);return}document.getElementById("name-scene-dialog").showModal()}function Mr(){if(K===void 0||!m)return;let e=u(),t=K,n=e.currentTime/e.duration,r=n-t,i=document.getElementById("save-scene-name").value.trim();i!==""&&(D(m,a=>(a.scenes=Dt({start:t,length:r,name:i},a.scenes),a)),T(`Adding scene between ${z(t*e.duration)} and ${z(n*e.duration)}`,3e3),oe(m))}function wr(e){let t=u(),n=t.currentTime/t.duration,r=z(t.currentTime),o=Math.round(n*100);re("osd-info2",`Time: ${r} (${o}%)`),p&&n>p.start+p.length&&he(t,p.start*t.duration,2)}function Ir(e){if(!m)return;let t=e.currentTime/e.duration,n=g(m);return Ht(n.scenes,t)}function xr(e,t){p=Ir(t),p&&(t.currentTime=p.start*t.duration)}function Lr(e,t){if(!m)return;let n=g(m);if(n.scenes.length===0)return;let r=i=>{pe=i.name,de&&clearTimeout(de),de=setTimeout(()=>{pe="",de=0},500),t.currentTime=i.start*t.duration,t.paused&&!t.error&&t.play()},o=t.currentTime/t.duration;for(let i of n.scenes)if(i.start>o){r(i);return}r(n.scenes[0])}var Cr={Enter:Gt,f:Gt,w:()=>{on()},t:vr,p:zt,n:_e,PageUp:zt,PageDown:_e,A:Or,a:Br,"[":Sr,"]":br,L:xr,s:Lr,0:h,1:h,2:h,3:h,4:h,5:h,6:h,7:h,8:h,9:h,j:A(-10),l:A(10),",":A(-1/30,{pauseOnly:!0}),".":A(1/30,{pauseOnly:!0}),ArrowLeft:A(-5,{shiftDelta:-30}),ArrowRight:A(5,{shiftDelta:30}),z:Tr," ":jt,k:jt,Escape:(e,t)=>{t.paused||t.pause(),nn()},"=":(e,t)=>{t.playbackRate=1},ArrowUp:(e,t)=>{t.volume=Math.min(t.volume+.1,1)},ArrowDown:(e,t)=>{t.volume=Math.max(t.volume-.1,0)},i:()=>{q()&&F()},d:()=>{m&&D(m,e=>{let t="delete",r=e.tags.indexOf(t);return r==-1?(T(`Added '${t}' tag`,3e3),e.tags.push(t)):(T(`Removed '${t}' tag`,3e3),e.tags.splice(r,1)),e})}};function Hr(e){if(document.activeElement&&document.activeElement.tagName==="INPUT")return;if(je()){if(e.code==="Escape"){let n=u();n.paused&&n.src&&!n.error&&n.play(),e.preventDefault(),e.stopPropagation()}e.key==="k"&&e.ctrlKey&&(document.getElementById("search-entry").focus(),e.preventDefault(),e.stopPropagation()),e.key==="m"&&e.ctrlKey&&(G("shuffle"),e.preventDefault(),e.stopPropagation());return}let t=Cr[e.key];t&&(t(e,u()),e.preventDefault(),e.stopPropagation())}function Dr(){d.loopSingle=!d.loopSingle,tn(),Re()}function G(e){d.sortMode=e,en(),Xt(),Re()}function Fr(){let e=document.getElementById("sort-dropdown-content");console.log("got dropdown",e),e.classList.toggle("show-dropdown");let t=Ge[d.sortMode],n=document.getElementById(t.radio);n.checked=!0}function kr(e){if(!je()){let t=u();t.volume=Math.max(Math.min(t.volume+e.deltaY/560,1),0)}}function Pr(){let e=[],t=document.getElementsByClassName("entry");for(let n of t){let r=n;r.style.display!=="none"&&e.push(r)}return e}function an(){return e=>!0}function Ar(e){return t=>sn(t)==e}function ze(e,t){let n=Pr(),r=q();if(!r)return;let o=n.indexOf(r);if(!(o<0))for(let i=0;i!=n.length-1;++i){o=e?o<n.length-1?o+1:0:o>0?o-1:n.length-1;let a=n[o];if(!(a.getAttribute(I)||a.getAttribute(Z))&&t(a)){Ce(),Qt(a.id);break}}}function _e(){ze(!0,an())}function zt(){ze(!1,an())}function sn(e){let t=e.getAttribute(y)||"";if(t=="")return"";let n=t.indexOf("-");return n==-1?"":t.substr(0,n).trim().toLowerCase()}function cn(e){let t=q();if(!t)return;let n=sn(t);n!=""&&ze(e,Ar(n))}function Br(){cn(!0)}function Or(){cn(!1)}function Ne(e,t){let n=$e(e);if(fe<j&&(++fe,fe==j&&_r()),t.unsupported)e.setAttribute(I,"true"),e.style.display="none";else{let r=e.querySelector(".duration-badge");r.textContent=z(t.duration);let o=e.querySelector(".quality-badge");o.textContent=`${t.width}x${t.height}`,n.src=URL.createObjectURL(t.image)}}function Ur(e,t){Mt(e,n=>{if(n){Ne(t,n);return}Ee(e,r=>{wt(e,r,o=>{o.image||(o={unsupported:!0}),Ne(t,o),ke(e,o)})})})}var B={},fe=0,j=0,ln=0;async function dn(e){document.getElementById("initial-view").style.display="none",ft(),B={},fe=0,ln=performance.now();for(let r of document.getElementsByClassName("entry-image")){let o=r;URL.revokeObjectURL(o.src)}let t=Ve();v(t),j=0;for(let r of e){let o=r.file;Rt(o.name)&&++j}j>0&&(W().style.display="none");let n=new se(64);for(let r of e){let o=r.file;if(!Rt(o.name))continue;let i=sr(o.name);t.appendChild(i),n.run(()=>ct(o).then(a=>{if(document.getElementById(a)){let s=i.querySelector(".entry-preview");if(s){s.setAttribute(Z,"true"),i.setAttribute(Z,"true");let f=document.createElement("div");f.className="dupe-badge",f.textContent=`Dupe of ${B[a].file.name}`,s.append(f)}let c=i.querySelector(".tag-container");c&&c.remove()}else{i.setAttribute("id",a),i.setAttribute(x,`${o.size}`),i.setAttribute(J,r.dir);let s=i.querySelector(".file-size-badge");s.textContent=dt(o.size);let c=i.querySelector(".tag-container"),f=g(a);Ie(c,f.tags),B[a]=r}Ur(a,i)}))}}function _r(){W().style.display="block";let e=performance.now();console.log(`Total load time: ${e-ln}`),Xt(),ae()}function un(){let e=Object.values(B);e.length>0&&dn(e)}async function Nr(e){e.preventDefault();let t=await it();document.getElementById("settings-dialog").close(),t&&T("Metadata exported")}async function Rr(e){e.preventDefault();let t=await at();document.getElementById("settings-dialog").close(),un(),t&&T("Metadata imported")}async function Vr(){let e=new Set(Object.keys(B)),t=await Lt(e),n=await st(e);T(`Removed ${t} unused previews and ${n} metadata entries`)}function $r(){P()}function Gr(e){if(!(e.target instanceof Element&&e.target.matches("#shuffle-button")))for(let t of document.getElementsByClassName("sort-dropdown-content"))t.classList.remove("show-dropdown")}function jr(e){let t=e.target,n=document.getElementById("top-gradient-mask"),r=document.getElementById("bottom-gradient-mask");t.scrollTop==0?n.style.opacity="0":n.style.opacity="1",t.scrollTop>=t.scrollHeight-t.offsetHeight-2?r.style.opacity="0":r.style.opacity="1"}async function Kt(e){let t={id:"boop",mode:"read",startIn:"videos"};try{let n=await globalThis.showDirectoryPicker(t),r=[],o=async(i,a)=>{for await(let[l,s]of a.entries())s.kind==="file"?r.push({file:await s.getFile(),dir:i}):s.kind==="directory"&&await o(l,s)};await o("root",n),dn(r)}catch(n){console.log("errol: ",n)}}function mn(){if(d.hideDupes){let e=new CSSStyleSheet;e.replaceSync('.entry[data-dupe="true"] { display: none; }'),document.adoptedStyleSheets=[e]}else document.adoptedStyleSheets=[]}function zr(){let e=document.getElementById("settings-hide-dupes");e.checked=d.hideDupes;let t=document.getElementById("settings-preview-video");t.checked=d.previewOnHover,document.getElementById("settings-dialog").showModal()}function Kr(){let e=document.getElementById("settings-hide-dupes");e.checked!==d.hideDupes&&(d.hideDupes=e.checked,mn());let t=document.getElementById("settings-preview-video");d.previewOnHover=t.checked,Re()}function Wr(e){let t=document.getElementById(e.contentHash);if(!t)return;let n=t.querySelector(".tag-container");n&&Ie(n,e.tags),e.contentHash==m&&oe(e.contentHash)}async function qr(){if("serviceWorker"in navigator)try{let e=await navigator.serviceWorker.register("service-worker.js",{scope:"./"});e.installing?console.log("Service worker installing"):e.waiting?console.log("Service worker installed"):e.active&&console.log("Service worker active")}catch(e){console.error(`Registration failed with ${e}`)}}globalThis.addEventListener("load",function(){globalThis.addEventListener("keydown",Hr,{capture:!0});let e=document.getElementById("search-entry");e.addEventListener("input",ae),e.addEventListener("blur",P),e.addEventListener("change",Ot),e.addEventListener("keydown",At),e.addEventListener("focus",Bt);let t=u();t.addEventListener("play",fr,!1),t.addEventListener("error",rn,!1),t.addEventListener("seeking",pr,!1),t.addEventListener("volumechange",yr,!1),t.addEventListener("ratechange",Er,!1),t.addEventListener("ended",hr,!1),t.addEventListener("timeupdate",wr,!1),document.addEventListener("dragover",function(n){n.dataTransfer&&(n.dataTransfer.dropEffect="none"),n.preventDefault()},!1),document.addEventListener("drop",function(n){n.preventDefault()},!1),document.addEventListener("wheel",kr,!1),document.getElementById("gallery-view").addEventListener("scroll",jr),document.getElementById("loop-button").addEventListener("click",Dr),document.getElementById("shuffle-button").addEventListener("click",Fr),document.getElementById("clear-search").addEventListener("click",_t),document.getElementById("settings").addEventListener("click",zr),document.getElementById("settings-confirm").addEventListener("click",Kr),document.getElementById("settings-export-tags").addEventListener("click",Nr),document.getElementById("settings-import-tags").addEventListener("click",Rr),document.getElementById("settings-gc-previews").addEventListener("click",Vr),document.getElementById("open-folder").addEventListener("click",Kt),document.getElementById("initial-open-folder").addEventListener("click",Kt),document.getElementById("save-query-confirm").addEventListener("click",Mr),document.getElementById("arrange-shuffle").addEventListener("click",()=>G("shuffle")),document.getElementById("arrange-sort-az").addEventListener("click",()=>G("by_name")),document.getElementById("arrange-sort-size").addEventListener("click",()=>G("by_file_size")),document.getElementById("arrange-sort-duration").addEventListener("click",()=>G("by_duration")),document.getElementById("toast-close").addEventListener("click",le),globalThis.addEventListener("resize",$r),globalThis.addEventListener("click",Gr),qr(),tt(Wr),Qe(nt),Xe(n=>{n?ot().then(()=>{Yn(()=>{en(),tn(),mn(),un()})}):w("Error opening IndexedDB")})});})();
